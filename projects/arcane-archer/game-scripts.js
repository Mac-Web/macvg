var Movement=pc.createScript("movement");Movement.attributes.add("speed",{type:"number",default:.1}),Movement.attributes.add("rollSpeed",{type:"number",default:.1}),Movement.attributes.add("turnSpeed",{type:"number",default:.35}),Movement.attributes.add("aimDistance",{type:"number",default:4.5}),Movement.attributes.add("freezeTime",{type:"number",default:1}),Movement.attributes.add("originEntity",{type:"entity"}),Movement.attributes.add("farEntity",{type:"entity"}),Movement.attributes.add("characterEntity",{type:"entity"}),Movement.attributes.add("touchEntity",{type:"entity"}),Movement.attributes.add("touchStartEntity",{type:"entity"}),Movement.attributes.add("touchMoveEntity",{type:"entity"}),Movement.attributes.add("touchDirectionEntity",{type:"entity"}),Movement.attributes.add("playerDirectionEntity",{type:"entity"}),Movement.attributes.add("leftFoot",{type:"entity"}),Movement.attributes.add("rightFoot",{type:"entity"}),Movement.attributes.add("shootPosition",{type:"entity"}),Movement.attributes.add("torsoEntity",{type:"entity"}),Movement.attributes.add("headEntity",{type:"entity"}),Movement.attributes.add("aimTargetEntity",{type:"entity"}),Movement.attributes.add("targetEntity",{type:"entity"}),Movement.attributes.add("cameraAngleEntity",{type:"entity"}),Movement.attributes.add("lookEntity",{type:"entity"}),Movement.attributes.add("lookAngleEntity",{type:"entity"}),Movement.attributes.add("headAngleEntity",{type:"entity"}),Movement.attributes.add("circleEntity",{type:"entity"}),Movement.attributes.add("fillEntity",{type:"entity"}),Movement.attributes.add("runningParticles",{type:"entity"}),Movement.prototype.initialize=function(){this.enemies=[],this.direction=-90,this.nextDirection=-90,this.cameraAngle=0,this.currentFar=0,this.isTouchMoved=!1,this.entity.ownerType="Player",this.isLocked=!1,this.originalTorsoAngle=this.torsoEntity.getLocalEulerAngles().clone(),this.originalHeadAngle=this.headEntity.getLocalEulerAngles().clone(),this.traceIndex=0,this.isCarrying=!1,this.lastCollide=-1,this.isRolling=-1,this.footstepType="Grass",this.isTouching=!1,this.touchStart=new pc.Vec2(0,0),this.currentTouch=new pc.Vec2(0,0),this.centerVector=new pc.Vec3(0,0,0),this.stepIndex=1,this.isRunning=!1,this.characterEntity.anim.on("Sound",this.playSound,this),this.characterEntity.anim.on("Hit",this.onHit,this),this.characterEntity.anim.on("Shoot",this.onShoot,this),this.characterEntity.anim.on("Aim",this.onAim,this),this.characterEntity.anim.on("ArrowFly",this.onArrowFly,this),this.characterEntity.anim.on("Idle",this.onIdle,this),this.characterEntity.anim.on("Roll",this.onRoll,this),this.app.touch&&(this.app.touch.on("touchstart",this.onTouchStart,this),this.app.touch.on("touchmove",this.onTouchMove,this),this.app.touch.on("touchend",this.onTouchEnd,this)),this.app.mouse.on("mousedown",this.onTouchStart,this),this.app.mouse.on("mousemove",this.onTouchMove,this),this.app.mouse.on("mouseup",this.onTouchEnd,this),this.app.keyboard&&this.app.keyboard.on("keydown",this.onKeyDown,this),this.entity.on("Carry",this.setCarryState,this),this.entity.on("Stop",this.stop,this),this.entity.on("Death",this.onDeath,this),this.entity.on("Footstep",this.setFootstepType,this),this.entity.on("Hit",this.onDamage,this),this.entity.on("Collision:Trigger",this.onTrigger,this),this.app.on("Enemy:Spawn",this.onEnemySpawn,this),this.app.on("Player:Respawn",this.onRespawn,this),this.app.on("Player:Stop",this.stop,this),this.app.on("MapManager:RestartLevel",this.onRespawn,this)},Movement.prototype.setFootstepType=function(t){this.footstepType=t},Movement.prototype.onRespawn=function(){this.isLocked=!1,this.characterEntity.anim.setTrigger("Spawn")},Movement.prototype.onTrigger=function(t){t&&t.enabled&&t.tags.list().indexOf("Kinematic")>-1&&(this.lastPushTime=Date.now())},Movement.prototype.onDamage=function(t,i){"IceArrow"==i&&(this.isLocked=!0,setTimeout((function(t){t.entity.script.player.isDeath||(t.isLocked=!1)}),1e3*this.freezeTime,this))},Movement.prototype.onDeath=function(){this.isTouching=!1,this.isRunning=!1,this.isLocked=!0,this.circleEntity.element.opacity=0,this.fillEntity.enabled=!1,this.aimTargetEntity.enabled=!1,this.characterEntity.anim.setBoolean("Shooting",!1),this.characterEntity.anim.setBoolean("Running",!1),this.characterEntity.anim.setTrigger("Death"),this.runningParticles.particlesystem.stop()},Movement.prototype.stop=function(){this.isTouching=!1,this.isRunning=!1,this.isLocked=!0,this.lastStop=Date.now(),this.lastCollide=-1,this.isRunning=!1,this.characterEntity.anim.setBoolean("Running",this.isRunning),clearTimeout(this.stopTimer),this.stopTimer=setTimeout((function(t){t.isLocked=!1}),1e3,this)},Movement.prototype.onEnemySpawn=function(){this.enemies=this.app.root.findByTag("Enemy")},Movement.prototype.onRoll=function(){this.isRolling=Date.now(),this.isShooting=!1,this.characterEntity.anim.setBoolean("Shooting",this.isShooting)},Movement.prototype.onIdle=function(){this.entity.fire("Action",!1)},Movement.prototype.onAim=function(){this.entity.fire("Action",!0),this.entity.sound.slots["Bow-Draw"].pitch=.9+.15*Math.random(),this.entity.sound.play("Bow-Draw")},Movement.prototype.onArrowFly=function(){this.entity.sound.slots["Arrow-Fly"].pitch=.9+.15*Math.random(),this.entity.sound.play("Arrow-Fly")},Movement.prototype.onShoot=function(){if(!Utils.isGameActive)return!1;var t=this.shootPosition.getPosition(),i=this.aimTargetEntity.getPosition(),e=Utils.lookAt(t.x,t.z,i.x,i.z);this.app.fire("ShootManager:Shoot","Player","Arrow",t,i),this.app.fire("Player:Shoot",t,i),this.app.fire("EffectManager:TraceEffect",t,e*pc.math.RAD_TO_DEG-90),this.entity.fire("Action",!1),this.entity.sound.play("Bow-Shoot"),this.app.fire("Motion","Shoot")},Movement.prototype.setCarryState=function(t){this.isCarrying=t},Movement.prototype.onKeyDown=function(){PokiPlugin.firstGameplayEvent(),this.app.fire("Player:Moved")},Movement.prototype.onTouchStart=function(t){if(this.isLocked)return!1;var i=t.touches;i||(i=[t]),this.playerDirectionEntity.enabled=!0,i.length>0&&(this.touchStart.x=i[0].x,this.touchStart.y=i[0].y,this.isTouchMoved=!1,this.totalMouseDistance=0,this.setTouchEntityPosition(),this.touchEntity.enabled=!0,this.isTouching=!0),PokiPlugin.firstGameplayEvent(),this.app.fire("Player:Moved")},Movement.prototype.setTouchEntityPosition=function(){var t=this.app.graphicsDevice.canvas,i=this.touchStart.x/t.clientWidth*2-1,e=1-this.touchStart.y/t.clientHeight*2;this.touchEntity.setPosition(i,e,0)},Movement.prototype.onTouchMove=function(t){if(this.isLocked)return!1;var i=t.touches;if(i||(i=[t]),i.length>0){this.currentTouch.x=i[0].x,this.currentTouch.y=i[0].y,this.isTouchMoved=!0;var e=this.currentTouch.x-this.touchStart.x,s=this.currentTouch.y-this.touchStart.y,n=75;if(e>n?e=n:e<-75&&(e=-75),s>n?s=n:s<-75&&(s=-75),this.touchMoveEntity.setLocalPosition(2*e,2*-s,0),this.totalMouseDistance=Utils.distance(this.touchStart.x,this.touchStart.y,this.currentTouch.x,this.currentTouch.y),this.touchMoveEntity.enabled=!0,this.totalMouseDistance>=n){var o=this.currentTouch.x-this.touchStart.x,h=this.currentTouch.y-this.touchStart.y,a=this.normalize(o,h),r=Math.min(Math.max(this.totalMouseDistance,0),n);this.touchStart.x=this.currentTouch.x-a.x*r,this.touchStart.y=this.currentTouch.y-a.y*r,this.setTouchEntityPosition()}}},Movement.prototype.normalize=function(t,i){var e=Math.sqrt(t*t+i*i);return 0===e?{x:0,y:0}:{x:t/e,y:i/e}},Movement.prototype.onTouchEnd=function(t){this.isTouching=!1,this.playerDirectionEntity.enabled=!1,this.touchEntity.enabled=!1,PokiPlugin.firstGameplayEvent(),this.app.fire("Player:Moved")},Movement.prototype.playSound=function(t){if("Run"==t.string){var i="Footstep-"+this.footstepType+"-"+this.stepIndex,e=.9;this.isCarrying&&(e=.8),this.entity.sound.slots[i].pitch=e+.1*Math.random(),this.entity.sound.play(i),this.stepIndex++,this.stepIndex>4&&(this.stepIndex=1)}},Movement.prototype.footstepTrace=function(){return!!this.isRunning&&(!(Date.now()-this.lastFootstep<150)&&(this.traceIndex++,this.traceIndex>1&&(this.traceIndex=0),void(this.lastFootstep=Date.now())))},Movement.prototype.setTouch=function(){if(this.isLocked)return!1;if(this.isTouching&&this.isTouchMoved){var t=Utils.lookAt(this.touchStart.x,this.touchStart.y,this.currentTouch.x,this.currentTouch.y);this.nextDirection=(-t+Math.PI/2)*pc.math.RAD_TO_DEG,this.isRunning=!0,this.touchDirectionEntity.setLocalEulerAngles(0,0,-this.nextDirection),this.touchDirectionEntity.enabled=this.totalMouseDistance>50}},Movement.prototype.setKeyboard=function(){(this.app.keyboard.isPressed(pc.KEY_W)||this.app.keyboard.isPressed(pc.KEY_UP))&&(this.nextDirection=-90,this.isRunning=!0),(this.app.keyboard.isPressed(pc.KEY_A)||this.app.keyboard.isPressed(pc.KEY_LEFT))&&(this.nextDirection=-180,this.isRunning=!0),(this.app.keyboard.isPressed(pc.KEY_D)||this.app.keyboard.isPressed(pc.KEY_RIGHT))&&(this.nextDirection=0,this.isRunning=!0),(this.app.keyboard.isPressed(pc.KEY_S)||this.app.keyboard.isPressed(pc.KEY_DOWN))&&(this.nextDirection=90,this.isRunning=!0),(this.app.keyboard.isPressed(pc.KEY_W)||this.app.keyboard.isPressed(pc.KEY_UP))&&(this.app.keyboard.isPressed(pc.KEY_A)||this.app.keyboard.isPressed(pc.KEY_LEFT))&&(this.nextDirection=-135,this.isRunning=!0),(this.app.keyboard.isPressed(pc.KEY_W)||this.app.keyboard.isPressed(pc.KEY_UP))&&(this.app.keyboard.isPressed(pc.KEY_D)||this.app.keyboard.isPressed(pc.KEY_RIGHT))&&(this.nextDirection=-45,this.isRunning=!0),(this.app.keyboard.isPressed(pc.KEY_S)||this.app.keyboard.isPressed(pc.KEY_DOWN))&&(this.app.keyboard.isPressed(pc.KEY_A)||this.app.keyboard.isPressed(pc.KEY_LEFT))&&(this.nextDirection=135,this.isRunning=!0),(this.app.keyboard.isPressed(pc.KEY_S)||this.app.keyboard.isPressed(pc.KEY_DOWN))&&(this.app.keyboard.isPressed(pc.KEY_D)||this.app.keyboard.isPressed(pc.KEY_RIGHT))&&(this.nextDirection=45,this.isRunning=!0)},Movement.prototype.setMovement=function(t){if(pc.isInterfaceLocked)return!1;if(this.isLocked)return this.characterEntity.anim.setBoolean("Running",!1),!1;if(Date.now()-this.lastStop<120)return!1;if(this.isPushing=Date.now()-this.lastPushTime<100,this.isRunning=!1,this.setKeyboard(),this.setTouch(),this.isRunning){var i=this.turnSpeed;this.isCarrying&&(i*=.5),this.isPushing&&(i*=.5),Date.now()-this.isRolling<1e3&&(i*=.1),this.direction=Utils.rotate(this.direction,this.nextDirection*pc.math.DEG_TO_RAD,i);var e=this.speed;this.isCarrying&&(e*=.65),this.isPushing&&(e*=.5),this.isShooting&&(e*=.85);var s=Math.cos(this.direction)*e*t,n=Math.sin(this.direction)*e*t;Date.now()-this.isRolling<1e3&&(s=Math.cos(this.direction)*this.rollSpeed*t,n=Math.sin(this.direction)*this.rollSpeed*t),this.entity.translateLocal(s,0,n)}this.originEntity.setLocalEulerAngles(0,90-this.direction*pc.math.RAD_TO_DEG,0),this.farEntity.setLocalPosition(this.currentFar,0,0),this.characterEntity.anim.setBoolean("Pushing",this.isPushing),this.isPushing&&this.characterEntity.anim.setBoolean("Shooting",!1),this.characterEntity.anim.setBoolean("Running",this.isRunning),this.isRunning?this.runningParticles.particlesystem.play():this.runningParticles.particlesystem.stop(),this.isShooting=!1},Movement.prototype.setLimitRadius=function(t){var i=this.fogEntity.getLocalScale().x,e=Math.PI/2,s=this.entity.getPosition(),n=Utils.lookAt(s.x,s.z,0,0),o=Math.cos(n-e)*this.speed*t,h=Math.sin(n-e)*this.speed*t;this.centerVector.clone().sub(s).length()>i-1&&this.entity.translateLocal(o,0,-h)},Movement.prototype.update=function(t){if(!Utils.isGameActive)return this.characterEntity.anim.setBoolean("Running",!1),!1;this.getClosestTarget(),this.setMovement(t),this.footstepTrace()},Movement.prototype.getClosestTarget=function(){for(var t=null,i=99999,e=this.entity.getPosition(),s=this.enemies.length;s--;){var n=this.enemies[s],o=n.getPosition().sub(e).length();o<i&&n.parent&&n.enabled&&!n.script.enemy.isDeath&&(i=o+(100-n.script.enemy.health)/100,t=n)}this.targetEntity=t||!1},Movement.prototype.postUpdate=function(){if(!Utils.isGameActive)return this.characterEntity.anim.setBoolean("Shooting",!1),!1;if(this.isLocked)return!1;if(this.torsoEntity.setLocalEulerAngles(this.originalTorsoAngle),this.headEntity.setLocalEulerAngles(this.originalHeadAngle),this.isPushing)return!1;if(Date.now()-this.isRolling<1e3)return!1;if(this.targetEntity){var t=this.targetEntity.getPosition(),i=this.entity.getPosition(),e=this.targetEntity.getPosition().clone().sub(this.entity.getPosition()).length(),s=Utils.lookAt(i.x,i.z,t.x,t.z);this.cameraAngle=Utils.rotate(this.cameraAngle,s,.1),this.cameraAngleEntity.setLocalEulerAngles(0,this.cameraAngle*pc.math.RAD_TO_DEG-90,0),this.lookEntity.setLocalEulerAngles(0,s*pc.math.RAD_TO_DEG-90,0),this.aimTargetEntity.setPosition(this.aimTargetEntity.getPosition().lerp(this.aimTargetEntity.getPosition(),this.targetEntity.getPosition(),.1)),e<this.aimDistance?(this.torsoEntity.setEulerAngles(this.lookAngleEntity.getEulerAngles()),this.headEntity.setEulerAngles(this.headAngleEntity.getEulerAngles()),this.circleEntity.element.opacity=.35,this.fillEntity.enabled=!0,this.aimTargetEntity.enabled=!0,this.isShooting=!0):(this.circleEntity.element.opacity=.05,this.fillEntity.enabled=!1,this.aimTargetEntity.enabled=!1)}else this.circleEntity.element.opacity=0,this.fillEntity.enabled=!1,this.aimTargetEntity.enabled=!1;this.characterEntity.anim.setBoolean("Shooting",this.isShooting),this.app.fire("Camera:Zoom",this.isShooting),this.currentFar=pc.math.lerp(this.currentFar,this.isShooting?1:0,.01)};var CameraFollow=pc.createScript("cameraFollow");CameraFollow.attributes.add("desktopCamera",{type:"entity"}),CameraFollow.attributes.add("mobileCamera",{type:"entity"}),CameraFollow.attributes.add("followEntity",{type:"entity"}),CameraFollow.attributes.add("playerEntity",{type:"entity"}),CameraFollow.attributes.add("arrowEntity",{type:"entity"}),CameraFollow.attributes.add("speed",{type:"number",default:.1}),CameraFollow.prototype.initialize=function(){var t=this.desktopCamera;Utils.isMobile()&&(window.innerWidth>window.innerHeight&&this.mobileCamera.setLocalPosition(0,.752,9.64),this.desktopCamera.enabled=!1,this.mobileCamera.enabled=!0,t=this.mobileCamera),this.cameraEntity=t,this.cameraEntity.name="Lens",this.arrowEntity.enabled=!1,this.startFov=parseInt(this.cameraEntity.camera.fov+""),this.isZooming=!1,this.app.on("Camera:Focus",this.setCameraFocus,this),this.app.on("Camera:BlackWhite",this.setBlackWhite,this),this.app.on("Camera:Zoom",this.setCameraZoom,this)},CameraFollow.prototype.setCameraZoom=function(t){this.isZooming=t},CameraFollow.prototype.setBlackWhite=function(t){this.cameraEntity.script.blackWhite.enabled=t},CameraFollow.prototype.setCameraFocus=function(t,e){if(!t)return!1;var i=1e3;e&&(i=e),this.followEntity=t,this.speed=.04,this.arrowEntity.enabled=!0,this.entity.sound.play("Spinning"),this.playerEntity.script.movement.isLocked=!0,clearTimeout(this.cameraTimer),this.cameraTimer=setTimeout((function(t){t.arrowEntity.enabled=!1,t.entity.sound.play("Spinning"),t.followEntity=t.playerEntity,t.speed=.04,t.playerEntity.script.movement.isLocked=!1}),i,this)},CameraFollow.prototype.update=function(t){if(this.cameraEntity.camera.fov=pc.math.lerp(this.cameraEntity.camera.fov,this.startFov-(this.isZooming?1:0),.1),!this.followEntity)return!1;var e=this.entity.getPosition().lerp(this.entity.getPosition(),this.followEntity.getPosition(),this.speed);this.entity.setPosition(0,e.y,e.z),this.arrowEntity.setPosition(this.followEntity.getPosition())};var MaterialShader=pc.createScript("materialShader");MaterialShader.attributes.add("inEditor",{type:"boolean",default:!0,title:"In Editor"}),MaterialShader.attributes.add("autoplay",{type:"boolean",default:!0}),MaterialShader.attributes.add("continuous",{type:"boolean",default:!0}),MaterialShader.attributes.add("isDebug",{type:"boolean",default:!1}),MaterialShader.attributes.add("isImage",{type:"boolean",default:!1}),MaterialShader.attributes.add("isStatic",{type:"boolean",default:!1}),MaterialShader.attributes.add("isBatched",{type:"boolean",default:!1}),MaterialShader.attributes.add("color",{type:"boolean",default:!0}),MaterialShader.attributes.add("transform",{type:"boolean",default:!0}),MaterialShader.attributes.add("light",{type:"boolean",default:!0}),MaterialShader.attributes.add("material",{type:"asset",assetType:"material"}),MaterialShader.attributes.add("textures",{type:"json",schema:[{name:"name",type:"string",default:"texture_0"},{name:"texture",type:"asset",assetType:"texture"}],array:!0}),MaterialShader.attributes.add("colors",{type:"json",schema:[{name:"name",type:"string",default:"color_0"},{name:"color",type:"rgba"}],array:!0}),MaterialShader.attributes.add("vectors",{type:"json",schema:[{name:"name",type:"string",default:"vector_0"},{name:"vector",type:"vec2"}],array:!0}),MaterialShader.attributes.add("numbers",{type:"json",schema:[{name:"name",type:"string",default:"number_0"},{name:"number",type:"number",default:0}],array:!0}),MaterialShader.attributes.add("curves",{type:"json",schema:[{name:"name",type:"string",default:"curve_0"},{name:"curve",type:"curve",curves:["x","y","z"]},{name:"speed",type:"number",default:1}],array:!0}),MaterialShader.attributes.add("billboard",{type:"boolean",default:!1}),MaterialShader.attributes.add("vertexSet",{type:"boolean",default:!1}),MaterialShader.attributes.add("cloneMaterial",{type:"boolean",default:!1}),MaterialShader.attributes.add("alphaRef",{type:"number",default:.15}),MaterialShader.attributes.add("shader",{type:"string",default:"dmVjNCBnZXRDb2xvcih2ZWMyIFVWKXsKLy92ZWMzIHRleHR1cmVfY29sb3IgPSB0ZXh0dXJlMkQodGV4dHVyZV8wLCBVVikucmdiOwpjb2xvci5yZ2IgPSB2ZWMzKDAuMCwgMS4wLCAwLjApOwpjb2xvci5hID0gMS4wOwoKcmV0dXJuIGNvbG9yOwp9Cgp2ZWMzIGdldFZlcnRleCh2ZWMzIGxvY2FsUG9zaXRpb24sIHZlYzMgd29ybGRQb3NpdGlvbiwgdmVjMiBVVil7CnZlcnRleC54eXogPSB2ZWMzKDAuMCwgMC4wLCAwLjApOwoKcmV0dXJuIHZlcnRleDsKfQ=="}),MaterialShader.prototype.initialize=function(){this.once=!1,this.isPlaying=this.autoplay,this.reset(),this.isDebug?this.addCodeEditor():(this.emissive=atob(this.shader),this.updateMaterial()),this.on("attr:textures",this.onAttributeChange,this),this.on("attr:colors",this.onAttributeChange,this),this.on("attr:vectors",this.onAttributeChange,this),this.on("attr:numbers",this.onAttributeChange,this),this.on("attr:curves",this.onAttributeChange,this),this.on("attr:shader",this.onAttributeChange,this),this.entity.on("MaterialShader:Set",this.setVariable,this),this.entity.on("MaterialShader:Play",this.onPlay,this),this.app.on("MaterialShader:"+this.entity.name,this.setVariable,this),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this),this.entity.on("Model:Loaded",this.onModelLoaded,this),this.app.on("MaterialShader:Reset",this.onStateChange,this),this.material&&(this.totalAssets=2+this.textures.length,this.loaded=0,this.loadAllAssets())},MaterialShader.prototype.onDestroy=function(){this.cloneMaterial&&this.currentMaterial&&this.currentMaterial.destroy()},MaterialShader.prototype.onPlay=function(){this.isPlaying=!0,this.timestamp=0},MaterialShader.prototype.loadAllAssets=function(){var t=this,e=this.entity.model.asset,a=this.app.assets.get(e);for(var i in a?(a.ready((function(){t.loaded++,t.isLoaded()})),this.app.assets.load(a)):(this.loaded++,this.isLoaded()),this.material.ready((function(){t.loaded++,t.isLoaded()})),this.app.assets.load(this.material),this.textures){var r=this.textures[i];r.texture.ready((function(){t.loaded++,t.isLoaded()})),this.app.assets.load(r.texture)}},MaterialShader.prototype.isLoaded=function(){this.loaded>=this.totalAssets&&(this.isBatched?setTimeout((function(t){t.getMaterialByBatch(),t.updateMaterial()}),100,this):(this.cloneMaterial?(this.currentMaterial=this.material.resource.clone(),this.entity.model.meshInstances[0].material=this.currentMaterial):this.currentMaterial=this.material.resource,this.currentMaterial.chunks.APIVersion=pc.CHUNKAPI_1_55,this.updateMaterial(),this.app.fire("Shader:Loaded",this.entity.name)))},MaterialShader.prototype.setVariable=function(t,e){for(var a in this.parameters){var i=this.parameters[a];this.currentMaterial.setParameter(i.name,i.resource),i.name==t&&(this.parameters[a].resource=e)}},MaterialShader.prototype.updateDynamicVariables=function(){for(var t in this.curves){var e=this.curves[t];for(var a in this.parameters){var i=this.parameters[a];if(i.name==e.name){var r=e.curve.value(this.timestamp*e.speed%1);i.resource=[r[0],r[1],r[2]]}}}},MaterialShader.prototype.onModelLoaded=function(t){!0===t&&setTimeout((function(t){t.onAttributeChange()}),3e3,this)},MaterialShader.prototype.onStateChange=function(t){this.reset()},MaterialShader.prototype.copy=function(t){var e=btoa(t);navigator.clipboard.writeText(e).then((function(){console.log("Async: Copying to clipboard was successful!")}),(function(t){console.error("Async: Could not copy text: ",t)}))},MaterialShader.prototype.addCodeEditor=function(){var t=this,e=document.createElement("button");e.style.position="fixed",e.style.left="10px",e.style.top="340px",e.style.width="100px",e.style.height="40px",e.style.zIndex="5000",e.style.background="rgba(0, 0, 0, 0.5)",e.style.color="#fff",e.textContent="Copy",e.onclick=function(){t.copy(t.emissiveCode.value)},document.body.appendChild(e);var a=document.createElement("textarea");a.style.position="fixed",a.style.left="10px",a.style.top="10px",a.style.width="400px",a.style.height="300px",a.style.padding="10px",a.style.zIndex="5000",a.style.background="rgba(0, 0, 0, 0.5)",a.style.outline="none",a.style.color="white",a.onkeyup=this.onShaderChange.bind(this);var i=document.createElement("style");i.innerText="#application-console{max-height: 80px;}",document.body.appendChild(i),this.emissiveCode=a,this.emissiveCode.value=atob(this.shader),this.emissive=this.emissiveCode.value,this.updateMaterial(),document.body.appendChild(a)},MaterialShader.prototype.onShaderChange=function(){clearTimeout(this.timer),this.timer=setTimeout((function(t){t.emissive=t.emissiveCode.value,t.updateMaterial()}),100,this)},MaterialShader.prototype.reset=function(){this.timestamp=0,this.isPlaying=!0,this.parameters=[]},MaterialShader.prototype.line=function(t){return t+"\n"},MaterialShader.prototype.number=function(t){return parseFloat(t).toFixed(2)},MaterialShader.prototype.colorRGB=function(t){return"vec3("+this.number(t.data[0])+", "+this.number(t.data[1])+", "+this.number(t.data[2])+")"},MaterialShader.prototype.colorRGBA=function(t){return"vec4("+this.number(t.data[0])+", "+this.number(t.data[1])+", "+this.number(t.data[2])+", "+this.number(t.data[3])+")"},MaterialShader.prototype.addParameter=function(t,e){var a="";for(var i in this[t]){var r=this[t][i],s=!1;if(a+=this.line("uniform "+e+" "+r.name+";"),"textures"==t&&(s=r.texture.resource),"colors"==t&&(s=r.color.data),"vectors"==t&&(s=r.vector.data),"curves"==t){var n=r.curve.value(this.timestamp*r.speed);s=[n[0],n[1],n[2]]}"numbers"==t&&(s=r.number),this.parameters.push({name:r.name,resource:s})}return a},MaterialShader.prototype.generateShaderOutput=function(){var t="";return t+=this.addParameter("textures","sampler2D"),t+=this.addParameter("colors","vec4"),t+=this.addParameter("vectors","vec2"),t+=this.addParameter("numbers","float"),t+=this.addParameter("curves","vec3"),t+=this.line("uniform float timestamp;"),t+=this.line("uniform float alpha_ref;"),t+=this.line("uniform float alphaRef;"),t+=this.line("vec4 color  = vec4(0.0);"),t+=this.line("vec3 vertex = vec3(0.0);"),t+=this.line(this.emissive),t+=this.line("void getEmission() {"),t+=this.line("}"),t+=this.line("void getAlbedo() {"),t+=this.line("}"),t+=this.line("void getOpacity() {"),t+=this.line("}"),t+=this.line("void alphaTest(float a) {"),t+=this.line("if (a < alpha_ref) discard;"),t+=this.line("}")},MaterialShader.prototype.onAttributeChange=function(){this.reset(),this.updateMaterial()},MaterialShader.prototype.generateTransformOutput=function(){var t="";return t+=this.addParameter("textures","sampler2D"),t+=this.addParameter("colors","vec4"),t+=this.addParameter("vectors","vec2"),t+=this.addParameter("numbers","float"),t+=this.addParameter("curves","vec3"),this.isBatched&&(t+=this.line("#define DYNAMICBATCH")),t+=this.line("uniform float timestamp;"),t+=this.line("uniform mat4 matrix_viewInverse;"),t+=this.line("mat4 getModelMatrix() {"),t+=this.line("#ifdef DYNAMICBATCH"),t+=this.line("return getBoneMatrix(vertex_boneIndices);"),t+=this.line("#elif defined(INSTANCING)"),t+=this.line("return mat4(instance_line1, instance_line2, instance_line3, instance_line4);"),t+=this.line("#else"),t+=this.line("return matrix_model;"),t+=this.line("#endif"),t+=this.line("}"),t+=this.line("vec4 color  = vec4(0.0);"),t+=this.line("vec3 vertex = vec3(0.0);"),t+=this.line(this.emissive),t+=this.line("vec4 getPosition() {"),t+=this.line("dModelMatrix = getModelMatrix();"),t+=this.line("vec3 localPos = vertex_position;"),t+=this.line("vec4 posW   = dModelMatrix * vec4(localPos, 1.0);"),t+=this.line("vec2 UV     = localPos.xy * 0.5 + vec2(0.5, 0.5);"),this.billboard&&(t+=this.line("vec3 CameraUp_worldspace = matrix_viewInverse[1].xyz;"),t+=this.line("vec3 CameraRight_worldspace = matrix_viewInverse[0].xyz;"),t+=this.line("vec3 particleCenter_wordspace = ( dModelMatrix * vec4(0.0, 0.0, 0.0, 1.0) ).xyz;"),t+=this.line("posW.xyz = particleCenter_wordspace.xyz + CameraRight_worldspace * localPos.x + CameraUp_worldspace * localPos.y;")),this.vertexSet?t+=this.line("posW.xyz = getFullVertex(localPos, posW.xyz, UV, dModelMatrix, matrix_viewInverse);"):t+=this.line("posW.xyz+= getVertex(localPos, posW.xyz, UV);"),t+=this.line("dPositionW = posW.xyz;"),t+=this.line("vec4 outputPosition = matrix_viewProjection * posW;"),t+=this.line("return outputPosition;"),t+=this.line("}"),t+=this.line("vec3 getWorldPosition() {"),t+=this.line("return dPositionW;"),t+=this.line("}")},MaterialShader.prototype.getMaterialByBatch=function(){var t=this.entity.model.batchGroupId,e=this.app.batcher.getBatches(t);for(var a in e){var i=e[a].meshInstance.material;this.currentMaterial=i}},MaterialShader.prototype.updateMaterial=function(){if(this.timestamp=0,!this.currentMaterial)return!1;this.transform&&(this.currentMaterial.chunks.transformVS=this.generateTransformOutput()),this.color&&(this.currentMaterial.chunks.diffusePS=this.generateShaderOutput(),this.currentMaterial.chunks.opacityPS=" ",this.currentMaterial.chunks.emissivePS=" ",this.currentMaterial.chunks.alphaTestPS=" ",this.currentMaterial.chunks.endPS="vec4 outputColor = getColor(vUv0);",this.currentMaterial.chunks.endPS+="dAlpha = outputColor.a;",this.currentMaterial.chunks.endPS+="if (dAlpha < alphaRef){ discard; }",this.currentMaterial.chunks.endPS+="gl_FragColor.rgb = outputColor.rgb;",this.light&&(this.currentMaterial.chunks.endPS+="gl_FragColor.rgb = mix(gl_FragColor.rgb * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);",this.currentMaterial.chunks.endPS+="gl_FragColor.rgb = addFog(gl_FragColor.rgb);",this.currentMaterial.chunks.endPS+="gl_FragColor.rgb = toneMap(gl_FragColor.rgb);",this.currentMaterial.chunks.endPS+="gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);")),this.currentMaterial.update()},MaterialShader.prototype.update=function(t){if(this.currentMaterial){if(this.updateDynamicVariables(),!this.isStatic||!this.once){for(var e in this.parameters){var a=this.parameters[e];this.currentMaterial.setParameter(a.name,a.resource)}this.once=!0}this.currentMaterial.setParameter("timestamp",this.timestamp),this.currentMaterial.setParameter("alphaRef",this.alphaRef),this.currentMaterial.update()}this.isPlaying&&(this.timestamp+=t,!this.continuous&&this.timestamp>=1&&(this.timestamp=1,this.isPlaying=!1))};var EffectManager=pc.createScript("effectManager");EffectManager.attributes.add("splashEffect",{type:"entity"}),EffectManager.attributes.add("splashSprite",{type:"entity"}),EffectManager.attributes.add("waveEffect",{type:"entity"}),EffectManager.attributes.add("landSmokeEffect",{type:"entity"}),EffectManager.attributes.add("landSmokeSprite",{type:"entity"}),EffectManager.attributes.add("destroyEffect",{type:"entity"}),EffectManager.attributes.add("traceEffect",{type:"entity"}),EffectManager.attributes.add("traceSprite",{type:"entity"}),EffectManager.attributes.add("cannonTraceEffect",{type:"entity"}),EffectManager.attributes.add("cannonTraceSprite",{type:"entity"}),EffectManager.attributes.add("hitEffect",{type:"entity"}),EffectManager.attributes.add("hitEffectSprite",{type:"entity"}),EffectManager.prototype.initialize=function(){this.nextTimeScale=1,this.app.on("EffectManager:LandSmoke",this.playLandSmoke,this),this.app.on("EffectManager:Splash",this.playSplash,this),this.app.on("EffectManager:WoodDestroy",this.playWoodDestroy,this),this.app.on("EffectManager:Footstep",this.addFootstep,this),this.app.on("EffectManager:Destroy",this.playDestroyEffect,this),this.app.on("EffectManager:HitEffect",this.playHitEffect,this),this.app.on("EffectManager:SlowTime",this.playSlowEffect,this),this.app.on("EffectManager:TraceEffect",this.playTraceEffect,this),this.app.on("EffectManager:CannonTraceEffect",this.playCannonTraceEffect,this),this.footstepIndex=0,this.footsteps=this.entity.findByTag("Footstep")},EffectManager.prototype.addFootstep=function(t){this.footsteps[this.footstepIndex].setPosition(t.getPosition().clone()),this.footsteps[this.footstepIndex].setRotation(t.getRotation().clone()),this.footstepIndex++,this.footsteps.length-1<this.footstepIndex&&(this.footstepIndex=0)},EffectManager.prototype.playTraceEffect=function(t,e){this.traceEffect.setPosition(t),this.traceEffect.setLocalEulerAngles(0,e,0),this.traceSprite.sprite.stop("Fire"),this.traceSprite.sprite.play("Fire")},EffectManager.prototype.playCannonTraceEffect=function(t,e){this.cannonTraceEffect.setPosition(t),this.cannonTraceEffect.lookAt(e),this.cannonTraceSprite.sprite.stop("Fire"),this.cannonTraceSprite.sprite.play("Fire")},EffectManager.prototype.playSlowEffect=function(){this.nextTimeScale=.2,clearTimeout(this.timescaleTimer),this.timescaleTimer=setTimeout((function(t){t.nextTimeScale=1}),800,this)},EffectManager.prototype.playDestroyEffect=function(t){this.app.fire("BakedPhysics:DestroyEffect",t)},EffectManager.prototype.playHitEffect=function(t){this.hitEffect.setPosition(t),this.hitEffectSprite.sprite.stop(),this.hitEffectSprite.sprite.play("Fire")},EffectManager.prototype.playLandSmoke=function(t){this.landSmokeEffect.setPosition(t),this.landSmokeSprite.sprite.stop(),this.landSmokeSprite.sprite.play("Fire")},EffectManager.prototype.playSplash=function(t){this.splashEffect.setPosition(t),this.splashSprite.sprite.stop(),this.splashSprite.sprite.play("Fire"),this.waveEffect.sprite.stop(),this.waveEffect.sprite.play("Fire")},EffectManager.prototype.playWoodDestroy=function(t){this.app.fire("BakedPhysics:WoodDestroy",t)},EffectManager.prototype.update=function(t){if(PokiPlugin.isPaused)return!1;this.app.timeScale=pc.math.lerp(this.app.timeScale,this.nextTimeScale,.1)};var Droppable=pc.createScript("droppable");Droppable.attributes.add("accept",{type:"string",default:"Log"}),Droppable.attributes.add("icon",{type:"asset"}),Droppable.attributes.add("placeIndex",{type:"number"}),Droppable.attributes.add("maxItems",{type:"number",default:3}),Droppable.attributes.add("dropType",{type:"string",enum:[{Smoke:"Smoke"}],default:"Smoke"}),Droppable.attributes.add("placeEntity",{type:"entity"}),Droppable.attributes.add("completeEntity",{type:"entity"}),Droppable.attributes.add("repeatItself",{type:"boolean",default:!1}),Droppable.attributes.add("type",{type:"string",enum:[{TimerBar:"TimerBar"},{Completable:"Completable"}],default:"Completable"}),Droppable.attributes.add("fillUpTime",{type:"number",default:5}),Droppable.prototype.initialize=function(){this.isBuilt=!1,this.isActive=!1,this.completeEntity&&(this.completeEntity.enabled=!1),this.entity.on("Drop",this.onDrop,this),this.entity.on("Active",this.setActive,this),this.entity.on("Complete",this.setComplete,this),this.entity.on("Reset",this.setReset,this)},Droppable.prototype.setReset=function(){this.isBuilt=!1,this.isActive=!0,this.placeIndex=0,this.completeEntity&&(this.completeEntity.enabled=!1),this.clearPlaces()},Droppable.prototype.setActive=function(){this.isActive=!0},Droppable.prototype.setComplete=function(){this.completeEntity&&(this.completeEntity.enabled=!0),this.isBuilt=!0,this.setActive()},Droppable.prototype.onDrop=function(t){return!this.isBuilt&&(t.name==this.accept&&(this.dropEffect(),this.entity.fire("Station:Update"),this.maxItems<=this.placeIndex&&!this.completeEntity&&(this.clearPlaces(),setTimeout((function(t){t.app.fire("Bank:Add",200,t.entity)}),1e3,this)),void(!this.isBuilt&&this.completeEntity&&this.maxItems<=this.placeIndex&&(setTimeout((function(t){t.build()}),200,this),this.isBuilt=!0))))},Droppable.prototype.clearPlaces=function(){var t=this.entity.findByTag("PlaceIndex");for(var e in t){var i=t[e].findByTag("Collectable");if(i.length>0)for(var p in i){i[p].destroy()}}this.placeIndex=0},Droppable.prototype.dropEffect=function(){"Smoke"==this.dropType&&this.app.fire("EffectManager:LandSmoke",this.entity.getPosition())},Droppable.prototype.build=function(){this.setComplete(),"Log"==this.accept&&this.app.fire("EffectManager:WoodDestroy",this.entity.getPosition()),this.app.fire("Motion","LittleShake"),this.entity.fire("Station:Complete")};var Motion=pc.createScript("motion");Motion.attributes.add("motions",{type:"json",schema:[{name:"name",type:"string"},{name:"position",type:"curve",curves:["x","y","z"]},{name:"rotation",type:"curve",curves:["x","y","z"]},{name:"scale",type:"curve",curves:["x","y","z"]},{name:"speed",type:"number",default:1},{name:"autoplay",type:"boolean",default:!1},{name:"loop",type:"boolean",default:!1}],array:!0}),Motion.attributes.add("events",{type:"json",schema:[{name:"animationName",type:"string"},{name:"eventName",type:"string"},{name:"time",type:"number",default:1},{name:"type",type:"string",default:"Anytime",enum:[{Anytime:"Anytime"},{Start:"Start"},{End:"End"}]}],array:!0}),Motion.attributes.add("lerp",{type:"number",default:.5}),Motion.prototype.initialize=function(){this.timestamp=0,this.currentSpeed=0,this.currentMotion=!1,this.isReverting=!1,this.startPosition=this.entity.getLocalPosition().clone(),this.startRotation=this.entity.getLocalEulerAngles().clone(),this.startScale=this.entity.getLocalScale().clone(),this.position=new pc.Vec3(0,0,0),this.rotation=new pc.Vec3(0,0,0),this.scale=new pc.Vec3(0,0,0),this.motions.length>0&&this.motions[0].autoplay&&this.onMotionPlay(this.motions[0].name),this.app.on("Motion",this.onMotionPlay,this),this.app.on("Motion:Stop",this.onMotionStop,this),this.entity.on("Motion",this.onMotionPlay,this),this.entity.on("Motion:Stop",this.onMotionStop,this)},Motion.prototype.findMotion=function(t){var i=!1;for(var n in this.motions){var e=this.motions[n];e.name==t&&(i=e)}return i},Motion.prototype.onMotionStop=function(t){this.currentMotion&&this.currentMotion.name==t&&(this.isPlaying=!1,this.currentMotion=!1)},Motion.prototype.onMotionPlay=function(t,i){if(!i&&this.currentMotion&&this.currentMotion.name==t)return!1;var n=this.findMotion(t);if(!n)return!1;this.isPlaying=!0,this.timestamp=0,this.currentMotion=n,this.triggerStartEvent(this.currentMotion)},Motion.prototype.triggerEvents=function(t){for(var i in this.events){var n=this.events[i],e=n.time;n.animationName==this.currentMotion.name&&e>this.timestamp&&e<=this.timestamp+t&&this.app.fire(n.eventName)}},Motion.prototype.findEventByMotion=function(t,i){for(var n in this.events){var e=this.events[n];if(e.animationName==t.name&&e.type==i)return e}},Motion.prototype.triggerStartEvent=function(t){var i=this.findEventByMotion(t,"Start");i&&this.app.fire(i.eventName)},Motion.prototype.triggerEndEvent=function(t){var i=this.findEventByMotion(t,"End");i&&this.app.fire(i.eventName)},Motion.prototype.update=function(t){if(!this.isPlaying)return!1;if(!this.currentMotion)return!1;var i=this.currentMotion.position.value(this.timestamp),n=this.currentMotion.rotation.value(this.timestamp),e=this.currentMotion.scale.value(this.timestamp);this.position=this.position.lerp(this.position,new pc.Vec3(i[0],i[1],i[2]),this.lerp),this.rotation=this.rotation.lerp(this.rotation,new pc.Vec3(n[0],n[1],n[2]),this.lerp),this.scale=this.scale.lerp(this.scale,new pc.Vec3(e[0],e[1],e[2]),this.lerp),this.entity.setLocalPosition(this.position.clone().add(this.startPosition)),this.entity.setLocalEulerAngles(this.rotation.clone().add(this.startRotation)),this.entity.setLocalScale(this.scale.clone().add(this.startScale)),this.triggerEvents(t),this.timestamp>=1&&(this.isPlaying=!1,this.currentMotion.loop?this.onMotionPlay(this.currentMotion.name,!0):(this.triggerEndEvent(this.currentMotion),this.currentMotion=!1)),this.isReverting?(this.timestamp-=t*this.currentMotion.speed,this.timestamp<=0&&(this.triggerEndEvent(this.currentMotion),this.currentMotion=!1,this.isPlaying=!1,this.isReverting=!1)):this.timestamp+=t*this.currentMotion.speed,this.timestamp=Math.max(this.timestamp,0),this.timestamp=Math.min(this.timestamp,1)};var BakedPhysicsPlayer=pc.createScript("bakedPhysicsPlayer");BakedPhysicsPlayer.attributes.add("staticEntity",{type:"entity"}),BakedPhysicsPlayer.attributes.add("speed",{type:"number",default:1}),BakedPhysicsPlayer.attributes.add("autoplay",{type:"boolean",default:!1}),BakedPhysicsPlayer.attributes.add("file",{type:"asset",assetType:"json"}),BakedPhysicsPlayer.attributes.add("soundPlay",{type:"boolean"}),BakedPhysicsPlayer.prototype.initialize=function(){this.staticEntity.on("Model:Loaded",this._onModelLoaded,this),this.on("destroy",this.onDestroy,this)},BakedPhysicsPlayer.prototype._onModelLoaded=function(t){!0===t&&this.onModelLoaded()},BakedPhysicsPlayer.prototype.onModelLoaded=function(){var t=this;this.isPlaying=!1,this.fps=60,this.pool=[],this.data={},this.frames=[],this.frameIndex=0,this.frameTime=0,this.isHidden=!1,this.childVertices=!1,this.childScale=!1,this.app.assets.load(this.file),this.file.ready((function(i){var e=this.resources[0];t.data=e,t.count=e.count,t.duration=e.duration,t.frames=e.frames,t.childVertices=e.childVertices,t.childScale=e.childScale,t.createPhysicalObjects(),t.hidePool()})),this.staticEntity.enabled=!1,this.app.on("BakedPhysics:"+this.entity.name,this.onPlay,this),this.autoplay&&this.app.fire("BakedPhysics:"+this.entity.name,new pc.Vec3(0,0,0))},BakedPhysicsPlayer.prototype.onDestroy=function(){this.app.off("BakedPhysics:"+this.entity.name,this.onPlay,this)},BakedPhysicsPlayer.prototype.onPlay=function(t){this.isPlaying=!0,this.isHidden=!1,this.isEnded=!1,this.frameIndex=0,this.frameTime=0,t&&this.entity.setLocalPosition(t),this.showPool(),this.soundPlay&&this.entity.sound.play("Sound")},BakedPhysicsPlayer.prototype.createPhysicalObjects=function(){if(this.data.childVertices){var t=this.staticEntity.model.meshInstances;for(var i in t){var e=t[i];parseInt(i)>-1&&(e.triggered=!1,e.isLarge=e.node.name.search("Large")>-1,this.pool.push(e))}}else for(var s=0;s<this.count;s++){var a=this.staticEntity.clone();a.enabled=!0,this.pool.push(a),this.entity.addChild(a)}},BakedPhysicsPlayer.prototype.showPool=function(t){if(this.childVertices)this.staticEntity.enabled=!0;else for(var i=this.pool.length;i--;)this.pool[i].enabled=!0;this.staticEntity.enabled=!0},BakedPhysicsPlayer.prototype.hidePool=function(t){if(this.isHidden)return!1;if(this.childVertices)for(var i=this.pool.length;i--;)this.pool[i].triggered=!1,this.pool[i].enabled=!1;else this.staticEntity.enabled=!1;this.staticEntity.enabled=!1,this.isHidden=!0},BakedPhysicsPlayer.prototype.onEnd=function(){if(this.isEnded)return!1;this.isEnded=!0},BakedPhysicsPlayer.prototype.getRadius=function(t){return t.x+t.y+t.z},BakedPhysicsPlayer.prototype.update=function(t){if(!this.isPlaying)return!1;if(0===this.frames.length)return!1;if(this.frames.length-1<this.frameIndex)return this.isPlaying=!1,this.hidePool(),this.onEnd(),!1;for(var i=this.pool.length;i--;){var e=this.frames[this.frameIndex][i],s=e,a=e[0];if(this.childVertices?(this.pool[a].node.setLocalPosition(100*s[1],100*s[2],100*s[3]),this.pool[a].node.setLocalEulerAngles(s[4],s[5],s[6])):(this.pool[a].setLocalPosition(s[1],s[2],s[3]),this.pool[a].setLocalEulerAngles(s[4],s[5],s[6])),this.groundTrigger){var o=this.pool[a].node.getPosition().clone();!this.pool[a].triggered&&this.pool[a].isLarge&&o.y<0&&(this.pool[a].triggered=!0)}}this.frameTime+=t*this.fps*this.speed,this.frameIndex=Math.round(this.frameTime)};var ModelComponent=pc.createScript("modelComponent");ModelComponent.attributes.add("loaded",{type:"boolean",default:!1}),ModelComponent.prototype.initialize=function(){if(this.loaded)return setTimeout((function(t){t.entity.fire("Model:Loaded",!0)}),1e3,this),!1;this.materialCount=0,this.materialLoaded=0;var t=this.entity.model.asset;if(!t)return!1;var e=this.app.assets.get(t),a=this;e.ready((function(){a.entity.fire("Model:Loaded",!1),a.checkMaterials()}))},ModelComponent.prototype.checkMaterials=function(){if(!this.entity.model)return!1;var t=this.entity.model.meshInstances,e=this;if(!t)return!1;for(var a in this.materialCount=t.length,t){var i=t[a].material,o=this.app.assets.find(i.name);if(!o)return!1;o.ready((function(){e.checkTextures(i)})),this.app.assets.load(o)}},ModelComponent.prototype.checkTextures=function(t){var e=t._assetReferences,a=0,i=0,o=this;for(var n in e){var s=e[n];i++,this.app.assets.load(s.asset),s.asset.ready((function(){++a>=i&&o.setMaterial()}))}0===i&&this.setMaterial()},ModelComponent.prototype.setMaterial=function(){this.materialLoaded++,this.materialCount==this.materialLoaded&&this.entity.fire("Model:Loaded",!0)};var Rotate=pc.createScript("rotate");Rotate.attributes.add("axis",{type:"string",enum:[{x:"x"},{y:"y"},{z:"z"}]}),Rotate.attributes.add("speed",{type:"number"}),Rotate.attributes.add("waveStyle",{type:"boolean"}),Rotate.attributes.add("waveWidth",{type:"number"}),Rotate.attributes.add("children",{type:"boolean"}),Rotate.attributes.add("graphName",{type:"string"}),Rotate.prototype.initialize=function(){this.currentElement=this.entity,this.timestamp=0,this.children&&(this.currentElement=this.entity.findByName(this.graphName))},Rotate.prototype.update=function(t){var e=this.speed*(60*t);this.waveStyle&&(e=Math.cos(this.timestamp*this.speed)*this.waveWidth,this.timestamp+=60*t),this.currentElement?("x"==this.axis&&this.currentElement.rotateLocal(e,0,0),"y"==this.axis&&this.currentElement.rotateLocal(0,e,0),"z"==this.axis&&this.currentElement.rotateLocal(0,0,e)):this.children&&(this.currentElement=this.entity.findByName(this.graphName))};var Collisions=pc.createScript("collisions");Collisions.attributes.add("speed",{type:"number",default:5}),Collisions.attributes.add("triggerDistance",{type:"number",default:1.5}),Collisions.attributes.add("collectDistance",{type:"number",default:3}),Collisions.attributes.add("isKinematic",{type:"boolean",default:!1}),Collisions.attributes.add("hasTrigger",{type:"boolean",default:!0}),Collisions.prototype.initialize=function(){this.lastCollisionCheck=Date.now(),this.lastDropTime=Date.now(),this.lastCollectTime=Date.now(),this.currentlyCollidingTriggers=[],this.app.on("Scene:Triggers",this.scanTriggers,this),this.app.on("Scene:AddTrigger",this.addTrigger,this),this.app.on("Scene:AddCollision",this.addCollision,this),this.app.on("Scene:RemoveCollision",this.removeCollision,this),this.app.on("Scene:Collision",this.scanCollisions,this),this.entity.on("Trigger:Reset",this.resetTrigger,this),this.scanTriggers(),this.scanCollisions()},Collisions.prototype.resetTrigger=function(){this.lastTriggerEntity=!1,this.isColliding=!1},Collisions.prototype.scanTriggers=function(){this.triggers=this.app.root.findByTag("Trigger"),this.lastTriggerEntity=null},Collisions.prototype.addTrigger=function(i){this.triggers.push(i)},Collisions.prototype.addCollision=function(i){this.collisions.push(i)},Collisions.prototype.removeCollision=function(i){var t=this.collisions.indexOf(i);t>-1&&this.collisions.splice(t,1)},Collisions.prototype.scanCollisions=function(){this.collisions=this.app.root.findByTag("Collision")},Collisions.prototype.checkCollision=function(i){if(Date.now()-this.lastCollisionCheck<80)return!1;for(var t=this.entity.getPosition(),s=this.triggers.length,o=[],n=this.lastTriggerEntity&&this.lastTriggerEntity.tags.list().indexOf("Collect")>-1;s--;){if((a=this.triggers[s])&&a.enabled&&a.parent){var l=a.getPosition().clone(),e=Utils.distance(l.x,l.z,t.x,t.z),r=this.triggerDistance;if(a.tags.list().indexOf("Collect")>-1&&(r=this.collectDistance,n&&a!==this.lastTriggerEntity))continue;e<r&&((a.tags.list().indexOf("Loop")>-1||this.lastTriggerEntity!==a)&&(a.fire("Trigger",this.entity),this.lastTriggerEntity=a),o.push(a))}}for(s=0;s<this.currentlyCollidingTriggers.length;s++){var a=this.currentlyCollidingTriggers[s];o.includes(a)||a.fire("Leave",this.entity)}0===o.length&&(this.lastTriggerEntity=null),this.currentlyCollidingTriggers=o,this.lastCollisionCheck=Date.now()},Collisions.prototype.hasAnyCollision=function(){return this.isColliding},Collisions.prototype.mapCollisions=function(){var i=this.collisions.length;for(this.collisionByIndex={};i--;){var t=this.collisions[i],s=t.getPosition().clone(),o=Math.ceil(s.x),n=Math.ceil(s.z);this.collisionByIndex[o]||(this.collisionByIndex[o]={}),this.collisionByIndex[o][n]||(this.collisionByIndex[o][n]=[]),this.collisionByIndex[o][n].push(t)}},Collisions.prototype.getOneGridCollision=function(i){var t=Math.ceil(i.x),s=Math.ceil(i.z);return this.collisionByIndex&&this.collisionByIndex[t]&&this.collisionByIndex[t][s]?this.collisionByIndex[t][s]:[]},Collisions.prototype.getCollisionsByMap=function(i){for(var t=[],s=Math.ceil(i.x),o=Math.ceil(i.z),n=s-1;n<=s+1;n++)for(var l=o-1;l<=o+1;l++)this.collisionByIndex&&this.collisionByIndex[n]&&this.collisionByIndex[n][l]&&(t=t.concat(this.collisionByIndex[n][l]));return t},Collisions.prototype.checkBorderCollision=function(i){var t=0;this.entity.collision&&(t=.5*this.entity.collision.radius);for(var s=this.entity.getPosition(),o=this.collisions,n=o.length;n--;){var l=o[n];if(l!=this.entity&&l&&l.enabled&&l.collision){var e=l.getPosition(),r=l.getPosition().clone().sub(s.clone()).length(),a=t+l.collision.radius;if(r<=a+.15){var h=Utils.lookAt(s.x,s.z,e.x,e.z)-Math.PI,c=Math.cos(h)*this.speed*i,g=Math.sin(h)*this.speed*i;l.tags.list().indexOf("Kinematic")>-1?l.translateLocal(-g,0,-c):this.isKinematic||this.entity.translateLocal(g,0,c),l.tags.list().indexOf("Rotatable")>-1&&l.fire("Rotate",this.entity,-c,0,g),l.tags.list().indexOf("Torque")>-1&&l.fire("Torque",100*-c,0,100*g),l.tags.list().indexOf("Active")>-1&&this.entity.fire("Collision:Trigger",l)}if(l.tags.list().indexOf("Revert")>-1){l.originalPosition||(l.originalPosition=l.getPosition().clone());var d=l.getPosition().clone().lerp(l.getPosition(),l.originalPosition,.05);l.setPosition(d),r<a&&l.fire("Collision")}}}},Collisions.prototype.update=function(i){!this.isKinematic&&this.hasTrigger&&(this.entity.script.building&&this.entity.script.building.currentBuilding||this.checkCollision(i)),this.checkBorderCollision(i)};var SplineMotion=pc.createScript("splineMotion");SplineMotion.attributes.add("speed",{type:"number",default:1}),SplineMotion.attributes.add("tension",{type:"number",default:1}),SplineMotion.prototype.initialize=function(){this.animations=[],this.points=this.entity.findByTag("Point"),this.hidePoints(),this.app.on("SplineMotion:"+this.entity.name,this.play,this),this.on("destroy",this.onDestroy)},SplineMotion.prototype.hidePoints=function(){for(var t in this.points){var i=this.points[t];i.getPosition().clone();i.enabled=!1}},SplineMotion.prototype.onDestroy=function(){this.app.off("SplineMotion:"+this.entity.name,this.play,this)},SplineMotion.prototype.generateCurves=function(){var t={timestamp:0,isPlaying:!0};for(var i in t.curveX=new pc.Curve,t.curveY=new pc.Curve,t.curveZ=new pc.Curve,t.curveX.type=pc.CURVE_SPLINE,t.curveY.type=pc.CURVE_SPLINE,t.curveZ.type=pc.CURVE_SPLINE,t.curveX.tension=this.tension,t.curveY.tension=this.tension,t.curveZ.tension=this.tension,this.points){var e=this.points[i],n=parseInt(i)/this.points.length,o=e.getPosition().clone();t.curveX.add(n,o.x),t.curveY.add(n,o.y),t.curveZ.add(n,o.z),e.enabled=!1}return t.firstPosition=this.points[0].getPosition().clone(),t},SplineMotion.prototype.play=function(t,i,e){return 0===this.points.length?(console.error("No point tags found in spline motion!"),!1):t?!t.curve&&(this.visualEntity=t,this.visualEntity.curve=this.generateCurves(),void this.animations.push(this.visualEntity)):(console.error("First arg should be an entity!"),!1)},SplineMotion.prototype.update=function(t){for(var i in this.animations){var e=this.animations[i];if(e.curve.isPlaying){var n=e.curve.curveX.value(e.curve.timestamp),o=e.curve.curveY.value(e.curve.timestamp),s=e.curve.curveZ.value(e.curve.timestamp);e.setPosition(n,o,s),e.curve.timestamp+=t*this.speed,e.curve.timestamp>=1&&(e.curve.isPlaying=!1,e.curve=!1,this.animations.splice(this.animations.indexOf(e),1))}}};var World2Screen=pc.createScript("world2Screen");World2Screen.attributes.add("holderEntity",{type:"entity"}),World2Screen.attributes.add("display",{type:"entity",array:!0}),World2Screen.prototype.postInitialize=function(){this.interactions=[],this.cameraEntity=this.app.root.findByName("Lens"),this.frameDrawn=0,this.nextFrameVisible=!1,this.app.on("World2Screen:Clone",this.cloneInteraction,this),this.app.on("World2Screen:Show",this.addInteraction,this),this.app.on("World2Screen:Visible",this.visibleInteraction,this),this.app.on("World2Screen:Hide",this.removeInteraction,this),this.hideAllDisplays(),this.on("destroy",this.onDestroy,this)},World2Screen.prototype.hideAllDisplays=function(){for(var t in this.display){this.display[t].enabled=!1}},World2Screen.prototype.onDestroy=function(){this.app.off("World2Screen:Show",this.setInteraction,this)},World2Screen.prototype.getInteractionDisplay=function(t){var e=!1;for(var i in this.display){var n=this.display[i];n.name==t&&(e=n)}return e},World2Screen.prototype.removeInteraction=function(t,e){var i=this.getInteractionDisplay(t);i&&(i.enabled=!1,i.entity=!1)},World2Screen.prototype.addInteraction=function(t,e,i){var n=this.getInteractionDisplay(t);n&&(n.entity!=e&&(n.enabled=!1),n.offset=i||new pc.Vec3(0,0,0),n.entity=e,n.type=t,n.enabled=!0,n.createdAt=Date.now())},World2Screen.prototype.cloneInteraction=function(t,e,i,n){var r=this.getInteractionDisplay(t),o=this;r&&((r=r.clone()).name=e._guid,r.enabled=!0,r.offset=i||new pc.Vec3(0,0,0),r.entity=e,r.type=t,r.enabled=!0,r.createdAt=Date.now(),n&&n(r),e.on("destroy",(function(){o.display.splice(o.display.indexOf(r),1),r.destroy()})),this.holderEntity.addChild(r),this.display.push(r))},World2Screen.prototype.visibleInteraction=function(t,e,i){this.addInteraction(t,e,i),this.frameDrawn=0,this.nextFrameVisible=t},World2Screen.prototype.updateInteraction=function(t){if(!this.cameraEntity)return!1;var e=new pc.Vec3,i=this.cameraEntity.camera,n=this.app.graphicsDevice.maxPixelRatio,r=this.entity.screen.scale,o=this.app.graphicsDevice;return!!i&&(!!t.entity&&(t.offset&&t.offset.name?i.worldToScreen(t.offset.getPosition().clone(),e):i.worldToScreen(t.entity.getPosition().clone().add(t.offset),e),e.x*=n,e.y*=n,void(e.x>0&&e.x<this.app.graphicsDevice.width&&e.y>0&&e.y<this.app.graphicsDevice.height&&e.z>0?(t.setLocalPosition(e.x/r,(o.height-e.y)/r,0),t.enabled=t.entity.enabled):t.enabled=!1)))},World2Screen.prototype.update=function(t){for(var e=this.display.length;e--;){var i=this.display[e];i&&this.updateInteraction(i)}this.nextFrameVisible&&this.frameDrawn>0&&this.removeInteraction(this.nextFrameVisible),this.frameDrawn++};var WorldAttach=pc.createScript("worldAttach");WorldAttach.attributes.add("type",{type:"string"}),WorldAttach.attributes.add("offset",{type:"vec3",default:[0,0,0]}),WorldAttach.prototype.initialize=function(){this.app.fire("World2Screen:Clone",this.type,this.entity,this.offset,this.onSetCallback.bind(this))},WorldAttach.prototype.onSetCallback=function(t){console.log(t)};var Timeline=pc.createScript("timeline");Timeline.attributes.add("autoplay",{type:"boolean"}),Timeline.attributes.add("loop",{type:"boolean",default:!1}),Timeline.attributes.add("yoyo",{type:"boolean",default:!1}),Timeline.attributes.add("position",{type:"boolean",default:!1}),Timeline.attributes.add("scale",{type:"boolean",default:!1}),Timeline.attributes.add("rotation",{type:"boolean",default:!1}),Timeline.attributes.add("opacity",{type:"boolean",default:!1}),Timeline.attributes.add("custom",{type:"boolean",default:!1}),Timeline.attributes.add("playSound",{type:"boolean",default:!1}),Timeline.attributes.add("duration",{type:"number",default:1}),Timeline.attributes.add("delay",{type:"number",default:0}),Timeline.attributes.add("repeat",{type:"number",default:0}),Timeline.attributes.add("soundDelay",{type:"number",default:0}),Timeline.attributes.add("rollback",{type:"number",default:0}),Timeline.attributes.add("ease",{type:"string",enum:[{Linear:"Linear"},{QuadraticIn:"QuadraticIn"},{QuadraticOut:"QuadraticOut"},{QuadraticInOut:"QuadraticInOut"},{CubicIn:"CubicIn"},{CubicOut:"CubicOut"},{CubicInOut:"CubicInOut"},{QuarticIn:"QuarticIn"},{QuarticOut:"QuarticOut"},{QuarticInOut:"QuarticInOut"},{QuinticIn:"QuinticIn"},{QuinticOut:"QuinticOut"},{QuinticInOut:"QuinticInOut"},{SineIn:"SineIn"},{SineOut:"SineOut"},{SineInOut:"SineInOut"},{ExponentialIn:"ExponentialIn"},{ExponentialOut:"ExponentialOut"},{ExponentialInOut:"ExponentialInOut"},{CircularIn:"CircularIn"},{CircularOut:"CircularOut"},{CircularInOut:"CircularInOut"},{BackIn:"BackIn"},{BackOut:"BackOut"},{BackInOut:"BackInOut"},{BounceIn:"BounceIn"},{BounceOut:"BounceOut"},{BounceInOut:"BounceInOut"},{ElasticIn:"ElasticIn"},{ElasticOut:"ElasticOut"},{ElasticInOut:"ElasticInOut"}],default:"Linear"}),Timeline.attributes.add("startFrame",{type:"json",schema:[{name:"position",type:"vec3"},{name:"rotation",type:"vec3"},{name:"scale",type:"vec3",default:[1,1,1]},{name:"opacity",type:"number",default:1},{name:"custom",type:"string",description:"For example camera.fov = 40"}]}),Timeline.attributes.add("endFrame",{type:"json",schema:[{name:"position",type:"vec3"},{name:"rotation",type:"vec3"},{name:"scale",type:"vec3",default:[1,1,1]},{name:"opacity",type:"number",default:1},{name:"custom",type:"string",description:"For example camera.fov = 40"}]}),Timeline.prototype.initialize=function(){this.animation={custom:0},this.eventListener=!1,this.app.on("Timeline:"+this.entity.name,this.onPlay,this),this.app.on("Timeline:"+this.entity.name+"@Time",this.setTime,this),this.entity.on("Timeline",this.onPlay,this),this.on("destroy",this.onDestroy,this),this.on("state",this.onStateChange,this),this.autoplay&&this.onPlay()},Timeline.prototype.setTime=function(t){this.duration=t},Timeline.prototype.onStateChange=function(t){!0===t?this.autoplay&&this.onPlay():this.reset()},Timeline.prototype.onDestroy=function(){},Timeline.prototype.getEase=function(){return pc[this.ease]},Timeline.prototype.reset=function(){this.positionFrames&&this.positionFrames.stop(),this.rotationFrames&&this.rotationFrames.stop(),this.scaleFrames&&this.scaleFrames.stop(),this.opacityFrames&&this.opacityFrames.stop(),this.customFrames&&this.customFrames.stop()},Timeline.prototype.setFirstFrame=function(options){var frame=this.startFrame;if(options.isReverse&&(frame=this.endFrame),this.position&&this.entity.setLocalPosition(frame.position),this.rotation&&this.entity.setLocalEulerAngles(frame.rotation),this.scale&&this.entity.setLocalScale(frame.scale),this.opacity&&(this.entity.element.opacity=frame.opacity),this.custom){var parts=frame.custom.split(" = "),query=parts[0],value=parseFloat(parts[1]);this.animation.custom=value,eval("this.entity."+this.custom)}},Timeline.prototype.onComplete=function(){},Timeline.prototype.onPlay=function(_options){var self=this,options={isReverse:!1,delay:this.delay,playSound:this.playSound};"object"==typeof _options&&(options.isReverse=!!_options.isReverse),"object"==typeof _options&&(options.playSound=!!_options.playSound),options.playSound&&setTimeout((function(t){t.entity.sound.play("Sound")}),1e3*this.soundDelay,this);var frame=this.endFrame;if(options.isReverse&&(options.delay=0,frame=this.startFrame),this.reset(),this.setFirstFrame(options),this.position&&(this.positionFrames=this.entity.tween(this.entity.getLocalPosition()).to({x:frame.position.x,y:frame.position.y,z:frame.position.z},this.duration,this.getEase()).delay(options.delay),this.eventListener||(this.eventListener=this.positionFrames.on("complete",this.onComplete,this)),this.loop&&this.positionFrames.loop(!0),this.yoyo&&this.positionFrames.yoyo(!0),this.repeat>0&&this.positionFrames.repeat(this.repeat),this.positionFrames.start()),this.rotation&&(this.rotationFrames=this.entity.tween(this.entity.getLocalEulerAngles()).rotate({x:frame.rotation.x,y:frame.rotation.y,z:frame.rotation.z},this.duration,this.getEase()).delay(options.delay),this.eventListener||(this.eventListener=this.rotationFrames.on("complete",this.onComplete,this)),this.loop&&this.rotationFrames.loop(!0),this.yoyo&&this.rotationFrames.yoyo(!0),this.repeat>0&&this.rotationFrames.repeat(this.repeat),this.rotationFrames.start()),this.scale&&(this.scaleFrames=this.entity.tween(this.entity.getLocalScale()).to({x:frame.scale.x,y:frame.scale.y,z:frame.scale.z},this.duration,this.getEase()).delay(options.delay),this.eventListener||(this.eventListener=this.scaleFrames.on("complete",this.onComplete,this)),this.loop&&this.scaleFrames.loop(!0),this.yoyo&&this.scaleFrames.yoyo(!0),this.repeat>0&&this.scaleFrames.repeat(this.repeat),this.scaleFrames.start()),this.opacity&&(this.opacityFrames=this.entity.tween(this.entity.element).to({opacity:frame.opacity},this.duration,this.getEase()).delay(options.delay),this.eventListener||(this.eventListener=this.opacityFrames.on("complete",this.onComplete,this)),this.loop&&this.opacityFrames.loop(!0),this.yoyo&&this.opacityFrames.yoyo(!0),this.repeat>0&&this.opacityFrames.repeat(this.repeat),this.opacityFrames.start()),this.custom){var parts=frame.custom.split(" = "),query=parts[0],value=parseFloat(parts[1]);this.customFrames=this.entity.tween(this.animation).to({custom:value},this.duration,this.getEase()).delay(options.delay),this.customFrames.on("update",(function(){eval("this.entity."+query+" = "+self.animation.custom)})),this.customFrames.start()}this.rollback>0&&!options.isReverse&&setTimeout((function(t){t.onPlay({isReverse:!0})}),1e3*this.rollback,this)};pc.extend(pc,function(){var TweenManager=function(t){this._app=t,this._tweens=[],this._add=[]};TweenManager.prototype={add:function(t){return this._add.push(t),t},update:function(t){for(var i=0,e=this._tweens.length;i<e;)this._tweens[i].update(t)?i++:(this._tweens.splice(i,1),e--);if(this._add.length){for(let t=0;t<this._add.length;t++)this._tweens.indexOf(this._add[t])>-1||this._tweens.push(this._add[t]);this._add.length=0}}};var Tween=function(t,i,e){pc.events.attach(this),this.manager=i,e&&(this.entity=null),this.time=0,this.complete=!1,this.playing=!1,this.stopped=!0,this.pending=!1,this.target=t,this.duration=0,this._currentDelay=0,this.timeScale=1,this._reverse=!1,this._delay=0,this._yoyo=!1,this._count=0,this._numRepeats=0,this._repeatDelay=0,this._from=!1,this._slerp=!1,this._fromQuat=new pc.Quat,this._toQuat=new pc.Quat,this._quat=new pc.Quat,this.easing=pc.Linear,this._sv={},this._ev={}},_parseProperties=function(t){var i;return t instanceof pc.Vec2?i={x:t.x,y:t.y}:t instanceof pc.Vec3?i={x:t.x,y:t.y,z:t.z}:t instanceof pc.Vec4||t instanceof pc.Quat?i={x:t.x,y:t.y,z:t.z,w:t.w}:t instanceof pc.Color?(i={r:t.r,g:t.g,b:t.b},void 0!==t.a&&(i.a=t.a)):i=t,i};Tween.prototype={to:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this},from:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this._from=!0,this},rotate:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this._slerp=!0,this},start:function(){var t,i,e,s;if(this.playing=!0,this.complete=!1,this.stopped=!1,this._count=0,this.pending=this._delay>0,this._reverse&&!this.pending?this.time=this.duration:this.time=0,this._from){for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this._properties[t],this._ev[t]=this.target[t]);this._slerp&&(this._toQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z,this._fromQuat.setFromEulerAngles(i,e,s))}else{for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this.target[t],this._ev[t]=this._properties[t]);this._slerp&&(i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z,void 0!==this._properties.w?(this._fromQuat.copy(this.target),this._toQuat.set(i,e,s,this._properties.w)):(this._fromQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),this._toQuat.setFromEulerAngles(i,e,s)))}return this._currentDelay=this._delay,this.manager.add(this),this},pause:function(){this.playing=!1},resume:function(){this.playing=!0},stop:function(){this.playing=!1,this.stopped=!0},delay:function(t){return this._delay=t,this.pending=!0,this},repeat:function(t,i){return this._count=0,this._numRepeats=t,this._repeatDelay=i||0,this},loop:function(t){return t?(this._count=0,this._numRepeats=1/0):this._numRepeats=0,this},yoyo:function(t){return this._yoyo=t,this},reverse:function(){return this._reverse=!this._reverse,this},chain:function(){for(var t=arguments.length;t--;)t>0?arguments[t-1]._chained=arguments[t]:this._chained=arguments[t];return this},update:function(t){if(this.stopped)return!1;if(!this.playing)return!0;if(!this._reverse||this.pending?this.time+=t*this.timeScale:this.time-=t*this.timeScale,this.pending){if(!(this.time>this._currentDelay))return!0;this._reverse?this.time=this.duration-(this.time-this._currentDelay):this.time-=this._currentDelay,this.pending=!1}var i=0;(!this._reverse&&this.time>this.duration||this._reverse&&this.time<0)&&(this._count++,this.complete=!0,this.playing=!1,this._reverse?(i=this.duration-this.time,this.time=0):(i=this.time-this.duration,this.time=this.duration));var e,s,n=0===this.duration?1:this.time/this.duration,r=this.easing(n);for(var h in this._properties)this._properties.hasOwnProperty(h)&&(e=this._sv[h],s=this._ev[h],this.target[h]=e+(s-e)*r);if(this._slerp&&this._quat.slerp(this._fromQuat,this._toQuat,r),this.entity&&(this.entity._dirtifyLocal(),this.element&&this.entity.element&&(this.entity.element[this.element]=this.target),this._slerp&&this.entity.setLocalRotation(this._quat)),this.fire("update",t),this.complete){var a=this._repeat(i);return a?this.fire("loop"):(this.fire("complete",i),this.entity&&this.entity.off("destroy",this.stop,this),this._chained&&this._chained.start()),a}return!0},_repeat:function(t){if(this._count<this._numRepeats){if(this._reverse?this.time=this.duration-t:this.time=t,this.complete=!1,this.playing=!0,this._currentDelay=this._repeatDelay,this.pending=!0,this._yoyo){for(var i in this._properties){var e=this._sv[i];this._sv[i]=this._ev[i],this._ev[i]=e}this._slerp&&(this._quat.copy(this._fromQuat),this._fromQuat.copy(this._toQuat),this._toQuat.copy(this._quat))}return!0}return!1}};var BounceOut=function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},BounceIn=function(t){return 1-BounceOut(1-t)};return{TweenManager:TweenManager,Tween:Tween,Linear:function(t){return t},QuadraticIn:function(t){return t*t},QuadraticOut:function(t){return t*(2-t)},QuadraticInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},CubicIn:function(t){return t*t*t},CubicOut:function(t){return--t*t*t+1},CubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},QuarticIn:function(t){return t*t*t*t},QuarticOut:function(t){return 1- --t*t*t*t},QuarticInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},QuinticIn:function(t){return t*t*t*t*t},QuinticOut:function(t){return--t*t*t*t*t+1},QuinticInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},SineIn:function(t){return 0===t?0:1===t?1:1-Math.cos(t*Math.PI/2)},SineOut:function(t){return 0===t?0:1===t?1:Math.sin(t*Math.PI/2)},SineInOut:function(t){return 0===t?0:1===t?1:.5*(1-Math.cos(Math.PI*t))},ExponentialIn:function(t){return 0===t?0:Math.pow(1024,t-1)},ExponentialOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},ExponentialInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},CircularIn:function(t){return 1-Math.sqrt(1-t*t)},CircularOut:function(t){return Math.sqrt(1- --t*t)},CircularInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},BackIn:function(t){var i=1.70158;return t*t*((i+1)*t-i)},BackOut:function(t){var i=1.70158;return--t*t*((i+1)*t+i)+1},BackInOut:function(t){var i=2.5949095;return(t*=2)<1?t*t*((i+1)*t-i)*.5:.5*((t-=2)*t*((i+1)*t+i)+2)},BounceIn:BounceIn,BounceOut:BounceOut,BounceInOut:function(t){return t<.5?.5*BounceIn(2*t):.5*BounceOut(2*t-1)+.5},ElasticIn:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),-e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/.4))},ElasticOut:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),e*Math.pow(2,-10*t)*Math.sin((t-i)*(2*Math.PI)/.4)+1)},ElasticInOut:function(t){var i,e=.1,s=.4;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=s*Math.asin(1/e)/(2*Math.PI),(t*=2)<1?e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/s)*-.5:e*Math.pow(2,-10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/s)*.5+1)}}}()),function(){pc.AppBase.prototype.addTweenManager=function(){this._tweenManager=new pc.TweenManager(this),this.on("update",(function(t){this._tweenManager.update(t)}))},pc.AppBase.prototype.tween=function(t){return new pc.Tween(t,this._tweenManager)},pc.Entity.prototype.tween=function(t,i){var e=this._app.tween(t);return e.entity=this,this.once("destroy",e.stop,e),i&&i.element&&(e.element=i.element),e};var t=pc.AppBase.getApplication();t&&t.addTweenManager()}();var Station=pc.createScript("station");Station.attributes.add("isActive",{type:"boolean",default:!0}),Station.attributes.add("condition",{type:"string",default:"None"}),Station.attributes.add("conditionValue",{type:"string",default:"0"}),Station.attributes.add("global",{type:"boolean",default:!1}),Station.attributes.add("slowFeedback",{type:"boolean",default:!1}),Station.attributes.add("connectedEntity",{type:"entity"}),Station.attributes.add("timeBar",{type:"entity"}),Station.attributes.add("cloneEntity",{type:"entity"}),Station.attributes.add("collisionEntity",{type:"entity"}),Station.attributes.add("buyEntity",{type:"entity"}),Station.attributes.add("unlockEntity",{type:"entity"}),Station.attributes.add("onHoverShow",{type:"entity"}),Station.attributes.add("onAppearDisable",{type:"entity"}),Station.attributes.add("onAppearDisable2",{type:"entity"}),Station.attributes.add("playBuildingEffect",{type:"boolean"}),Station.attributes.add("enableOnComplete",{type:"entity"}),Station.attributes.add("disableOnComplete",{type:"entity"}),Station.attributes.add("action",{type:"string",default:"Add:Item"}),Station.attributes.add("value",{type:"string",default:"Wood"}),Station.attributes.add("time",{type:"number",default:1}),Station.attributes.add("money",{type:"number",default:0}),Station.attributes.add("moneyStep",{type:"number",default:1}),Station.attributes.add("loop",{type:"boolean",default:!1}),Station.attributes.add("bar",{type:"boolean",default:!0}),Station.attributes.add("barName",{type:"string",default:"Bar"}),Station.attributes.add("visualBar",{type:"entity"}),Station.attributes.add("doDestroy",{type:"boolean",default:!0}),Station.attributes.add("nextStage",{type:"boolean",default:!1}),Station.attributes.add("waitAnimation",{type:"string",default:""}),Station.attributes.add("waitValue",{type:"string",default:""}),Station.attributes.add("waitTime",{type:"number",default:750}),Station.prototype.initialize=function(){this.offset=new pc.Vec3(0,3,0),this.createdAt=Date.now(),this.startTime=parseInt(""+this.time),this.stationName="Station_"+this.entity.name+"_"+this.entity.parent.name+"_"+this.entity.parent.parent.name,this.who=!1,this.waitingVolume=0,this.hoverEntity=this.entity.findByName("Hover"),this.originalScale=this.hoverEntity.getLocalScale().clone().x,this.scaleFactor=.9,this.edgeEntity=this.entity.findByName("Edge"),this.edgeEntity.enabled=!1,this.progressEntity=this.entity.findByName("Progress"),this.progressEntity&&(this.progressEntity.enabled=!1),this.enableOnComplete&&(this.enableOnComplete.enabled=!1),this.buyEntity&&(this.buyEntity.enabled=!0),this.unlockEntity&&(this.unlockEntity.enabled=!1),this.animationEntity=this.entity.findByName("Animation"),this.groupEntity=this.entity.findByName("Group"),this.moneyIcon=this.entity.findByName("MoneyIcon"),this.moneyText=this.entity.findByName("MoneyText"),this.moneyText&&(this.moneyText.element.text=this.money),this.onAppearDisable&&(this.onAppearDisable.enabled=!1),this.onAppearDisable2&&(this.onAppearDisable2.enabled=!1),this.startMoney=this.money,this.entity.on("Trigger",this.onTrigger,this),this.entity.on("Leave",this.onLeave,this),this.entity.on("Station:Upgrade",this.stationUpgrade,this),this.entity.on("Reset",this.reset,this),this.entity.on("Complete",this.onComplete,this),this.nextStage&&(this.entity.parent.on("Stage:Clear",this.onStageClear,this),this.buyEntity.enabled=!1),this.enoughMoneyToBuyOnce=!1,this.lastMoneyCheck=Date.now()},Station.prototype.onComplete=function(){setTimeout((function(t){t.completeCarry(),t.destroy()}),50,this)},Station.prototype.stationUpgrade=function(t,i){this.time=this.startTime/i,this.timeBar&&(this.timeBar.script.timeline.duration=this.time)},Station.prototype.conditionCallback=function(t){this.bar&&(this.app.fire("Timeline:Fill@Loop",!1),this.app.fire("Timeline:Fill@Time",this.time),this.app.fire("World2Screen:Show",this.barName,this.entity,this.offset)),this.who=t,this.lastTrigger=Date.now(),this.edgeEntity.element.color=pc.Color.GREEN},Station.prototype.conditionFallback=function(t){this.app.fire("Sound:Play","Error"),this.edgeEntity.element.color=pc.Color.RED,this.money>0&&(this.app.fire("RewardManager:Show","Money"),this.app.fire("Money:NoMoney"))},Station.prototype.onTrigger=function(t){if(this.buyEntity&&!this.buyEntity.enabled)return!1;this.progressEntity&&(this.progressEntity.enabled=!0),this.onHoverShow&&(this.onHoverShow.enabled=!0),this.hoverEntity&&this.hoverEntity.element&&this.hoverEntity.element.opacity&&(this.hoverEntity.element.opacity=.25,this.hoverEntity.setLocalScale(this.originalScale*this.scaleFactor,this.originalScale*this.scaleFactor,this.originalScale*this.scaleFactor),this.app.fire("Sound:Play","Hover"),this.app.fire("Station:"+this.entity.name,!0)),this.slowFeedback?(clearTimeout(this.triggerTimer),this.triggerTimer=setTimeout((function(i){i.updateTrigger(t)}),500,this)):this.updateTrigger(t)},Station.prototype.updateTrigger=function(t){var i=this;this.progressEntity&&(this.progressEntity.enabled=!0),this.hoverEntity&&this.hoverEntity.element&&(this.hoverEntity.element.opacity=.25,this.hoverEntity.setLocalScale(this.originalScale*this.scaleFactor,this.originalScale*this.scaleFactor,this.originalScale*this.scaleFactor),"None"==this.condition?this.conditionCallback(t):this.app.fire(this.condition,this.conditionValue,(function(){i.conditionCallback(t)}),(function(){i.conditionFallback(t)})),this.edgeEntity.enabled=!0),t&&(this.waitingVolume=1,this.app.fire(this.waitAnimation,this.waitValue,this.waitTime))},Station.prototype.onLeave=function(t){clearTimeout(this.triggerTimer),this.progressEntity,this.onHoverShow&&(this.onHoverShow.enabled=!1),this.hoverEntity&&(this.hoverEntity.element.opacity=.1,this.hoverEntity.setLocalScale(1*this.originalScale,1*this.originalScale,1*this.originalScale),this.who=!1,this.bar&&this.app.fire("World2Screen:Hide",this.barName),this.edgeEntity.enabled=!1,this.app.fire("Station:"+this.entity.name,!1)),this.app.fire("ThrowDisable"),this.waitingVolume=0},Station.prototype.reset=function(){this.groupEntity&&(this.groupEntity.enabled=!0),this.buyEntity?this.buyEntity.enabled=!0:this.entity.enabled=!0,this.unlockEntity&&(this.unlockEntity.enabled=!1),this.money=this.startMoney,this.moneyText&&(this.moneyText.element.text=this.money),Utils.deleteItem(this.stationName)},Station.prototype.complete=function(){if(this.money<=0&&!this.doDestroy)return this.groupEntity&&(this.groupEntity.enabled=!1),!1;if(this.money-=this.moneyStep,this.moneyText&&(this.moneyText.element.text=this.money),this.money<=0&&(this.app.fire("MaterialShader:Progress","progress",0),this.completeCarry(),this.startMoney>0&&this.doDestroy))return this.destroy(),!1;var t=this.who;this.who=!1,this.updateTrigger(t),this.enoughMoneyToBuyOnce=!0},Station.prototype.destroy=function(){if(this.isDestroyed)return!1;this.doDestroy&&this.entity.destroy(),this.entity.fire("Completed"),this.enoughMoneyToBuyOnce=!0,this.isDestroyed=!0},Station.prototype.completeCarry=function(t){if(this.app.fire("World2Screen:Hide",this.barName),this.action&&(this.global?this.app.fire(this.action,this.value,this.connectedEntity):this.who.fire(this.action,this.value,this.connectedEntity)),this.unlockEntity&&(this.buyEntity.enabled=!1,this.unlockEntity.enabled=!0,this.unlockEntity.fire("Reset"),this.collisionEntity&&(this.collisionEntity.enabled=!1)),this.enableOnComplete&&(this.enableOnComplete.enabled=!0,this.enableOnComplete.fire("Reset")),this.playBuildingEffect&&!t&&(this.app.fire("EffectManager:LandSmoke",this.entity.getPosition()),this.app.fire("Overlay:Sound","StoneDestroy"),this.app.fire("Overlay:Sound","Building"),this.app.fire("Motion","BigShake"),setTimeout((function(t){t.app.fire("EffectManager:Destroy",t.entity.getPosition())}),100,this)),this.disableOnComplete&&(this.disableOnComplete.enabled=!1),this.cloneEntity){var i=this.cloneEntity.clone();i.enabled=!0,i.sound.play("Whoosh"),i.sound.play("Drop"),this.app.fire("EffectManager:LandSmoke",i.getPosition()),this.app.root.addChild(i),this.app.fire("Motion","LittleShake")}this.doDestroy||(this.isDestroyed=!0,this.buyEntity?this.buyEntity.enabled=!1:this.entity.enabled=!1,this.entity.fire("Completed"));var e=this.who;this.who=!1,this.updateTrigger(e)},Station.prototype.upgradeStation=function(){return!this.enoughMoneyToBuyOnce&&(!this.who&&void(this.enoughMoneyToBuyOnce=!0))},Station.prototype.onStageClear=function(){this.buyEntity&&(this.buyEntity.enabled=!0)},Station.prototype.update=function(t){if(0===pc.app.timeScale)return!1;if(Date.now()-this.lastMoneyCheck>1500&&!this.isCompleted&&this.money>0){var i=this;this.app.fire("Money:Has",this.startMoney,(function(){i.upgradeStation()})),this.lastMoneyCheck=Date.now()}if(this.who&&Date.now()-this.lastTrigger>1e3*this.time&&(this.loop?(this.complete(),this.bar&&this.app.fire("World2Screen:Show",this.barName,this.entity,this.offset)):(this.complete(),this.doDestroy?this.destroy():this.completeCarry())),this.entity.sound&&this.entity.sound.slots.Waiting&&(this.entity.sound.slots.Waiting.volume=pc.math.lerp(this.entity.sound.slots.Waiting.volume,this.waitingVolume,.1)),this.visualBar){var e=(this.startMoney-this.money)/this.startMoney;this.visualBar.setLocalScale(e,1,1)}if(this.animationEntity&&(this.who&&!this.isDestroyed?this.animationEntity.enabled=!0:this.animationEntity.enabled=!1),this.who&&!this.isDestroyed&&this.progressEntity){e=(this.startMoney-this.money)/this.startMoney;this.app.fire("MaterialShader:Progress","progress",e)}};var Actions=pc.createScript("actions");Actions.prototype.initialize=function(){};var BuildingManager=pc.createScript("buildingManager");BuildingManager.attributes.add("buildings",{type:"entity",array:!0}),BuildingManager.prototype.initialize=function(){this.app.on("Ground:Update",this.onGroundUpdate,this),this.app.on("BuildingManager:Build",this.build,this),pc.BuildingManager=this},BuildingManager.prototype.onGroundUpdate=function(){this.stones=this.app.root.findByTag("Stone"),this.collisions=this.app.root.findByTag("Collision")},BuildingManager.prototype.canBuild=function(i){for(var t=0;t<this.stones.length;t++){if(this.stones[t].getPosition().clone().sub(i).length()<1)return!1}return!0},BuildingManager.prototype.getCollisionByPosition=function(i){for(var t=0;t<this.collisions.length;t++){var n=this.collisions[t];if(n.getPosition().clone().sub(i).length()<1)return n}},BuildingManager.prototype.snap=function(i){return Math.round(i)},BuildingManager.prototype.build=function(i,t){for(var n=this.buildings.length;n--;){var o=this.buildings[n];if(o.name==i){var e=o.clone();e.enabled=!0,e.setPosition(this.snap(t.x),0,this.snap(t.z));var a=e.getPosition();this.app.fire("EffectManager:LandSmoke",a),this.app.fire("EffectManager:Destroy",a),this.app.root.addChild(e)}}this.app.fire("Motion","LittleShake"),this.entity.sound.play("Stone-Destroy"),this.app.fire("Scene:Collision")};var Tone=pc.createScript("tone");Tone.attributes.add("offset",{type:"number",default:.5}),Tone.attributes.add("scale",{type:"number",default:.5}),Tone.prototype.initialize=function(){this.on("state",this.onStateChange,this)},Tone.prototype.onStateChange=function(t){t?(this.entity.sound.play("Tone"),this.entity.sound.play("TickTock")):(this.entity.sound.stop("Tone"),this.entity.sound.stop("TickTock"))},Tone.prototype.update=function(t){var e=this.entity.getLocalScale().x;this.entity.sound.pitch=e*this.scale+this.offset};var Sound=pc.createScript("sound");Sound.prototype.initialize=function(){this.app.on("Sound:Play",this.playSound,this)},Sound.prototype.playSound=function(n){this.entity.sound.play(n)};var DealtDamage=pc.createScript("dealtDamage");DealtDamage.attributes.add("numberEntity",{type:"entity"}),DealtDamage.attributes.add("holderEntity",{type:"entity"}),DealtDamage.prototype.initialize=function(){this.numbers=[],this.lastDamage=100,this.defaultOffset=new pc.Vec3(0,0,0),this.isMinus=1,this.cameraEntity=this.app.root.findByName("Lens"),this.numberEntity.enabled=!1,this.app.on("DealtDamage:Trigger",this.onDamageDealt,this)},DealtDamage.prototype.destroyEntity=function(e){this.numbers.splice(this.numbers.indexOf(e),1),e.destroy()},DealtDamage.prototype.onDamageDealt=function(e,t,a){var i=this.numberEntity.clone();e<=.99&&(e=1),i.element.text=e>0?Math.round(e)+"":e,this.offset=this.defaultOffset,i.player=new pc.Vec3(t.x,t.y,t.z),i.element.offsetX=50*Math.random()-50*Math.random(),i.element.offsetY=-1.7,i.element.opacity=1;var n=3,s=.3;a&&(n=4,s=1,i.element.color=pc.Color.RED),this.lastDamage=e;var o=i.tween(i.getLocalScale()).to({x:n,y:n,z:n},.15,pc.BounceOut);o.on("complete",(function(){this.entity.tween(this.entity.getLocalScale()).to({x:1,y:1,z:1},.4,pc.BounceOut).start()})),o.start(),i.tween(i.element).to({offsetY:0},.3,pc.Linear).start().on("complete",(function(){i.tween(i.element).to({opacity:0,offsetY:.8},s,pc.Linear).delay(.5).start()})),setTimeout((function(e,t){e.destroyEntity(t)}),3e3,this,i),this.numbers.push(i),this.holderEntity.addChild(i)},DealtDamage.prototype.updateNumberPosition=function(e){var t=new pc.Vec3,a=this.cameraEntity.camera,i=this.app.graphicsDevice.maxPixelRatio,n=this.entity.screen.scale,s=this.app.graphicsDevice,o=!1;return o=e.player.name?e.player.getPosition().clone().add(this.offset):e.player,!!a&&(!!e&&(a.worldToScreen(o,t),t.x*=i,t.y*=i,void(t.x>0&&t.x<this.app.graphicsDevice.width&&t.y>0&&t.y<this.app.graphicsDevice.height&&t.z>0?(e.setLocalPosition(t.x/n+e.element.offsetX,(s.height-t.y)/n+this.isMinus*Math.cos(e.element.offsetY)*Math.cos(e.element.offsetY)*120+(this.isMinus<0?150:0),0),e.element.outlineThickness=e.element.opacity,e.enabled=!0):e.enabled=!1)))},DealtDamage.prototype.update=function(e){for(var t=this.numbers.length;t--;)this.updateNumberPosition(this.numbers[t])};var Carry=pc.createScript("carry");Carry.attributes.add("resetEntity",{type:"entity"}),Carry.prototype.initialize=function(){this.offset=new pc.Vec3(0,1.5,0),this.who=!1,this.entity.on("Trigger",this.onTrigger,this),this.entity.on("Leave",this.onLeave,this),this.entity.on("Take",this.onTake,this),this.entity.on("Drop",this.onDrop,this),this.app.fire("Scene:Triggers")},Carry.prototype.onTrigger=function(t){if(t.script.movement.isCarrying)return!1;this.app.fire("World2Screen:Show","Carry",this.entity,this.offset)},Carry.prototype.onLeave=function(){this.app.fire("World2Screen:Hide","Carry")},Carry.prototype.onTake=function(t){if(t.script.movement.isCarrying)return!1;this.who=t,this.who.fire("Carry",!0),this.entity.reparent(this.who.findByName("CarryPoint")),this.entity.setLocalEulerAngles(0,0,0),this.entity.setLocalPosition(0,0,0),this.entity.collision&&(this.entity.collision.enabled=!1),this.entity.tags.remove("Trigger"),this.app.fire("Scene:Triggers"),this.app.fire("Motion","LittleShake"),this.resetEntity&&this.resetEntity.fire("Reset")},Carry.prototype.onDrop=function(t){this.entity.reparent(this.app.root),this.entity.setPosition(t),this.entity.tags.add("Trigger"),this.entity.collision&&(this.entity.collision.enabled=!0),this.app.fire("Scene:Triggers"),this.app.fire("EffectManager:LandSmoke",this.entity.getPosition()),this.app.fire("Motion","LittleShake"),this.app.fire("Place:Position",this.entity),this.who.fire("Carry",!1),this.who=!1};var Node=function(t,i){this.x=t,this.z=i,this.f=0,this.g=0,this.h=0,this.parent=null,this.walkable=!1},PathFinding=pc.createScript("pathFinding");PathFinding.attributes.add("gridWidth",{type:"number",default:100}),PathFinding.attributes.add("gridHeight",{type:"number",default:100}),PathFinding.attributes.add("size",{type:"number",default:1}),PathFinding.attributes.add("offset",{type:"number",default:1}),PathFinding.prototype.initialize=function(){this.grid=[],this.entities=[],this.app.on("PathFinding:Find",this.createPath,this)},PathFinding.prototype.createPath=function(t,i,e){var s=this;this.player=t,this.destination=i,this.createGrid();var h=this.calculatePath(this.snap(t.x),this.snap(t.z),this.snap(i.x),this.snap(i.z));h&&e&&e(h.map((function(t){return new pc.Vec3(t.x/s.size-parseInt(s.offset),0,t.z/s.size-parseInt(s.offset))})))},PathFinding.prototype.createGrid=function(){var t,i;for(t=-this.gridWidth;t<this.gridWidth;t++)for(this.grid[t]=[],i=-this.gridHeight;i<this.gridHeight;i++)this.grid[t][i]=new Node(t,i);for(this.platforms=this.app.root.findByTag("Platform"),t=0;t<this.platforms.length;t++){var e=this.snap(this.platforms[t].getPosition().x),s=this.snap(this.platforms[t].getPosition().z);this.platforms[t].enabled&&(this.grid[e][s].walkable=!0)}},PathFinding.prototype.snap=function(t){return Math.round(t*this.size)+this.offset},PathFinding.prototype.calculatePath=function(t,i,e,s){var h=[],n=[],r=[],a=this.grid[t][i],d=this.grid[e][s];if(!d.walkable)return!1;for(h.push(a);h.length>0;){for(var g=h[0],o=0;o<h.length;o++)h[o].f<g.f&&(g=h[o]);if(h.splice(h.indexOf(g),1),n.push(g),g.x===d.x&&g.z===d.z){for(var p=n[n.length-1];p.parent;)r.push(p),p=p.parent;return h=[],n=[],r.reverse(),r}var f=this.getAdjacentNodes(g);for(o=0;o<f.length;o++){var u=f[o];-1===n.indexOf(u)&&u.walkable&&(-1===h.indexOf(u)?(u.g=g.g+this.getCost(g,u),u.h=this.getCost(u,d),u.f=u.g+u.h,u.parent=g,h.push(u)):u.g>g.g+this.getCost(g,u)&&(u.g=g.g+this.getCost(g,u),u.f=u.g+u.h,u.parent=g))}}return!1},PathFinding.prototype.getAdjacentNodes=function(t){var i=[];return t.x>0&&i.push(this.grid[t.x-1][t.z]),t.x<this.gridWidth-1&&i.push(this.grid[t.x+1][t.z]),t.z>0&&i.push(this.grid[t.x][t.z-1]),t.z<this.gridHeight-1&&i.push(this.grid[t.x][t.z+1]),i},PathFinding.prototype.getCost=function(t,i){return 10};var MoveCurve=pc.createScript("moveCurve");MoveCurve.prototype.initialize=function(){this.entities=[],this.app.on("MoveCurve:Move",this.move,this)},MoveCurve.prototype.move=function(e,t,i,o){var c=[],n=[],u=[],v=0,p=e.getLocalPosition().clone();c.push(0,p.x),n.push(0,0),u.push(0,p.z),t.forEach((function(e){v+=1/t.length,c.push(v,e.x),n.push(v,0),u.push(v,e.z)}));var s=new pc.Curve(c),r=new pc.Curve(n),a=new pc.Curve(u);s.type=pc.CURVE_SPLINE,r.type=pc.CURVE_SPLINE,a.type=pc.CURVE_SPLINE,s.tension=.5,r.tension=.5,a.tension=.5,this.entities.push({entity:e,curveX:s,curveY:r,curveZ:a,speed:i,time:0,callback:o})},MoveCurve.prototype.update=function(e){this.entities.forEach((function(t,i){var o=t.entity.getLocalPosition();t.time+=e*t.speed,o.x=t.curveX.value(t.time),o.y=t.curveY.value(t.time),o.z=t.curveZ.value(t.time),t.entity.setLocalPosition(o),t.time>1&&(t.callback&&t.callback(),this.entities.splice(i,1))}),this)};var PathMove=pc.createScript("pathMove");PathMove.attributes.add("directionEntity",{type:"entity"}),PathMove.attributes.add("targetEntity",{type:"entity"}),PathMove.attributes.add("speed",{type:"number",default:.15}),PathMove.attributes.add("turnSpeed",{type:"number",default:.15}),PathMove.prototype.initialize=function(){this.isActive=!1,this.direction=0,this.waypoints=[],this.isPlaying=!1,this.timestamp=0,this.entity.on("PathMove:Wave",this.setWave,this),this.entity.on("PathMove:Play",this.playWave,this),this.entity.on("PathMove:Pause",this.pauseWave,this),this.entity.on("Attack:SetType",this.setAttackType,this)},PathMove.prototype.setAttackType=function(t){this.isActive="Default"==t},PathMove.prototype.playWave=function(){this.isPlaying=!0},PathMove.prototype.pauseWave=function(){this.isPlaying=!1},PathMove.prototype.onReach=function(){this.isPlaying=!1,this.entity.fire("Target:Reach",this.targetEntity)},PathMove.prototype.setWave=function(t){this.curveX=new pc.Curve,this.curveZ=new pc.Curve,this.curveX.type=pc.CURVE_SPLINE,this.curveZ.type=pc.CURVE_SPLINE,this.curveX.tension=.5,this.curveZ.tension=.5,this.waypoints=[];for(var i=this.app.root.findByTag("Waypoint"),e=0;e<i.length;e++){var s=i[e];s.tags.list()[1].split("-")[1]<=t&&this.waypoints.push(s)}for(e=0;e<this.waypoints.length;e++){var a=this.waypoints[e].getPosition(),h=e/(this.waypoints.length-1);this.curveX.add(h,a.x),this.curveZ.add(h,a.z)}this.currentWaypointIndex=0,this.isPlaying=!0,this.timestamp=0},PathMove.prototype.checkDistanceToTarget=function(){var t=this.entity.getPosition(),i=this.targetEntity.getPosition();t.sub(i).length()<1&&this.onReach()},PathMove.prototype.update=function(t){if(!this.isActive)return!1;if(0!==this.waypoints.length){if(!this.isPlaying)return!1;this.checkDistanceToTarget();this.waypoints[this.currentWaypointIndex];var i=this.curveX.value(this.timestamp),e=this.curveZ.value(this.timestamp);this.entity.setLocalPosition(i,0,e);var s=this.entity.getPosition(),a=this.curveX.value(this.timestamp+.01),h=this.curveZ.value(this.timestamp+.01),n=Utils.lookAt(s.x,s.z,a,h);this.direction=Utils.rotate(this.direction,n,this.turnSpeed),this.directionEntity.setLocalEulerAngles(0,this.direction*pc.math.RAD_TO_DEG,0),this.timestamp+=t*this.speed,this.timestamp>=1&&this.onReach()}};var Mount=pc.createScript("mount");Mount.prototype.initialize=function(){setTimeout((function(){pc.app.fire("Mount:Ready")}),60)};var Button=pc.createScript("button");Button.attributes.add("action",{type:"string"}),Button.attributes.add("value",{type:"string"}),Button.attributes.add("cooldown",{type:"number",default:0}),Button.attributes.add("hoverStateEvent",{type:"boolean",default:!1}),Button.attributes.add("lockAfterAction",{type:"boolean",default:!1}),Button.attributes.add("hoverAction",{type:"string"}),Button.attributes.add("leaveAction",{type:"string"}),Button.prototype.initialize=function(){this.cooldown>0&&(this.timerEntity=this.entity.findByName("Timer"),this.timerEntity.enabled=!1),this.entity.element.on("touchstart",this.onPress,this),this.entity.element.on("touchend",this.onLeave,this),this.entity.element.on("mouseenter",this.onHover,this),this.entity.element.on("mouseleave",this.onLeave,this),this.entity.element.on("mousedown",this.onPress,this),this.on("state",this.onStageChange,this)},Button.prototype.onStageChange=function(){this.lockAfterAction&&(this.entity.button.active=!0)},Button.prototype.onHover=function(t){document.body.style.cursor="pointer",this.hoverStateEvent&&this.app.fire(this.hoverAction,this.value),this.app.fire("Sound:Play","Button-Hover")},Button.prototype.onLeave=function(t){this.hoverStateEvent&&this.app.fire(this.leaveAction,this.value),document.body.style.cursor="default"},Button.prototype.onPress=function(t){return 0!==this.app.timeScale&&((!this.timerEntity||!this.timerEntity.enabled)&&(!(this.entity.button&&!this.entity.button.active)&&(this.app.fire(this.action,this.value),this.timerEntity&&(this.timerEntity.enabled=!0),setTimeout((function(t){t.timerEntity&&(t.timerEntity.enabled=!1)}),1e3*this.cooldown,this),void(this.lockAfterAction&&(this.entity.button.active=!1,setTimeout((function(t){t.entity.button.active=!0}),1e3,this))))))};var ShopManager=pc.createScript("shopManager");ShopManager.attributes.add("playerEntity",{type:"entity"}),ShopManager.prototype.initialize=function(){this.app.on("ShopManager:Buy",this.buy,this)},ShopManager.prototype.getItemDetails=function(t){return this.app.assets.find(t)},ShopManager.prototype.buy=function(t){var e=this.getItemDetails(t);if(this.playerEntity.script.movement.isCarrying)return console.error("Place current one first"),!1;var r=e.resource.instantiate();this.app.root.addChild(r),this.playerEntity.fire("Player:Carry",r)};var AnimatedSprite=pc.createScript("animatedSprite");AnimatedSprite.attributes.add("speed",{type:"number"}),AnimatedSprite.attributes.add("totalFrameCount",{type:"number"}),AnimatedSprite.prototype.initialize=function(){var t=this;this.currentSpriteFrame=0,this.on("state",(function(e){t.currentSpriteFrame=0,t.entity.element.spriteFrame=0}))},AnimatedSprite.prototype.update=function(t){this.entity.element.spriteFrame=Math.floor(this.currentSpriteFrame%this.totalFrameCount),this.currentSpriteFrame+=this.speed*t};var Dragon=pc.createScript("dragon");Dragon.attributes.add("damage",{type:"number",default:1}),Dragon.attributes.add("health",{type:"number",default:5}),Dragon.attributes.add("attackDistance",{type:"number",default:1}),Dragon.attributes.add("modelEntity",{type:"entity"}),Dragon.prototype.postInitialize=function(){this.targetEntity=!1,this.dragonNames=["Frostbite","Serpentia","Aurora","Claw","Drake","Onyx"],this.name=this.dragonNames[Math.floor(Math.random()*this.dragonNames.length)],this.modelEntity.anim.on("Flap",this.onFlap,this),this.modelEntity.anim.on("Attack",this.onAttack,this),this.entity.fire("Attack:SetType","Protect"),this.entity.on("Target:Reach",this.onReach,this),this.app.on("Enemy:Spawn",this.onEnemySpawn,this),this.entity.fire("Define",{name:this.entity.name,health:this.health,level:1,offset:new pc.Vec3(0,2,0)})},Dragon.prototype.onEnemySpawn=function(t){this.entity.fire("Target:Refresh",!0)},Dragon.prototype.onReach=function(t){this.targetEntity=t},Dragon.prototype.onAttack=function(){var t=this.entity.getPosition().clone().sub(this.targetEntity.getPosition()).length();this.isEnemy(this.targetEntity)&&t<=this.attackDistance&&this.targetEntity.fire("Hit",this.damage)},Dragon.prototype.isEnemy=function(t){return t&&t.tags.list().indexOf("Enemy")>-1&&t.enabled&&t.parent&&t.script.enemy&&!t.script.enemy.isDeath},Dragon.prototype.update=function(t){this.isEnemy(this.targetEntity)?this.modelEntity.anim.setBoolean("Attacking",!0):this.modelEntity.anim.setBoolean("Attacking",!1)};var MoneyManager=pc.createScript("moneyManager");MoneyManager.attributes.add("startMoney",{type:"number",default:500}),MoneyManager.attributes.add("noMoneyAlert",{type:"entity"}),MoneyManager.attributes.add("moneyEntity",{type:"entity"}),MoneyManager.attributes.add("playerEntity",{type:"entity"}),MoneyManager.prototype.initialize=function(){this.money=this.startMoney,this.totalMoney=this.startMoney,this.lastMoneySave=-1,this.mapLoot={},Utils.getItem("Money")&&(this.money=parseInt(Utils.getItem("Money"))),this.money=Math.max(this.money,this.startMoney),this.app.on("Money:Remove",this.remove,this),this.app.on("Money:Add",this.add,this),this.app.on("Money:Has",this.has,this),this.app.on("Money:Drop",this.drop,this),this.app.on("Money:NoMoney",this.showNoMoney,this),this.app.on("Money:TestCondition",this.hasTest,this),this.updateMoney(),pc.MoneyManager=this},MoneyManager.prototype.showNoMoney=function(){this.noMoneyAlert.enabled||(this.noMoneyAlert.enabled=!0,this.noMoneyTimer=setTimeout((function(t){t.noMoneyAlert.enabled=!1}),1e3,this))},MoneyManager.prototype.has=function(t,e,n){var o=parseInt(t);this.money>o?e():n&&n()},MoneyManager.prototype.hasTest=function(t,e,n){e(),this.app.fire("Sound:Play","MoneyCount")},MoneyManager.prototype.remove=function(t){this.money-=parseInt(t),this.updateMoney(),this.app.fire("Sound:Play","MoneyCount")},MoneyManager.prototype.add=function(t){this.money+=parseInt(t),this.totalMoney+=parseInt(t),this.updateMoney(),this.mapLoot[pc.BalanceSession.mapName]||(this.mapLoot[pc.BalanceSession.mapName]=0),this.mapLoot[pc.BalanceSession.mapName]+=parseInt(t),this.app.fire("Sound:Play","CoinAdd")},MoneyManager.prototype.updateMoney=function(){this.moneyEntity.element.text=this.money+"",Date.now()-this.lastMoneySave>1e3&&(Utils.setItem("Money",this.money),this.lastMoneySave=Date.now())};var Hit=pc.createScript("hit");Hit.attributes.add("modelEntity",{type:"entity"}),Hit.prototype.initialize=function(){this.offset=new pc.Vec3(0,.75,0),this.entity.on("Hit",this.onHit,this)},Hit.prototype.onHit=function(t){if(this.entity.script.enemy.isDeath)return!1;var i=!1;this.modelEntity.fire("MaterialShader:Play"),this.modelEntity.fire("Motion","Hit",!0),t>20&&(i=!0,this.app.fire("Sound:Play","Crit")),this.app.fire("DealtDamage:Trigger",t,this.entity.getPosition().add(this.offset),i),this.app.fire("Overlay:Sound","Hit")},Hit.prototype.update=function(t){};var Place=pc.createScript("place");Place.prototype.initialize=function(){this.app.on("Place:Position",this.onPlace,this),this.on("destroy",this.onDestroy,this)},Place.prototype.onDestroy=function(){this.app.off("Place:Position",this.onPlace,this)},Place.prototype.onPlace=function(t){this.entity.getPosition().sub(t.getPosition()).length()<1&&this.entity.fire("Place",t)};var Label=pc.createScript("label");Label.attributes.add("type",{type:"string",default:"Dragon"}),Label.attributes.add("offset",{type:"vec3",default:[0,1.25,0]}),Label.prototype.initialize=function(){this.name="",this.isLabelCreated=!1,this.healthRatio=1,this.health=100,this.level=1,this.maxHealth=parseInt(this.health+""),this.entity.on("Define",this.defineNPC,this),this.entity.on("Health",this.onHealthChange,this),this.entity.on("Progress",this.setProgress,this),this.entity.on("Action",this.setActionBar,this)},Label.prototype.defineNPC=function(t){this.name=t.name,this.health=t.health,this.maxHealth=parseInt(this.health+""),this.level=t.level,t.offset&&(this.offset=t.offset),this.app.fire("World2Screen:Clone",this.type,this.entity,this.offset,this.onLabel.bind(this))},Label.prototype.onLabel=function(t){this.labelEntity=t,this.healthEntity=t.findByName("Health"),this.healthValue=t.findByName("HealthValue"),this.nameEntity=t.findByName("Name"),this.actionBar=t.findByName("ActionBar"),this.actionBar&&(this.actionBar.enabled=!1),this.nameEntity&&(this.nameEntity.element.text=this.name),this.isLabelCreated=!0},Label.prototype.setActionBar=function(t){this.actionBar.enabled=t},Label.prototype.onHealthChange=function(t){this.health=t},Label.prototype.setProgress=function(t,e){e>=1?(this.statusEntity.enabled=!1,this.progressEntity.enabled=!1):(this.statusEntity.enabled||(this.statusIcon.element.textureAsset=this.app.assets.find(t+"-Icon.png")),this.statusEntity.enabled=!0,this.progressEntity.enabled=!0,this.progressBar.setLocalScale(e,1,1))},Label.prototype.update=function(t){if(!this.isLabelCreated)return!1;this.healthRatio=pc.math.lerp(this.healthRatio,Math.max(1*this.health/this.maxHealth,0),.1),this.healthEntity.setLocalScale(this.healthRatio,1,1),this.healthValue&&(this.healthValue.element.text=this.health)};var CustomInput=pc.createScript("customInput");CustomInput.attributes.add("trigger",{type:"string"}),CustomInput.attributes.add("autoFocus",{type:"boolean",default:!1}),CustomInput.attributes.add("maxLength",{type:"number",default:7}),CustomInput.attributes.add("placeholderEntity",{type:"entity"}),CustomInput.prototype.initialize=function(){this.placeHolder=this.entity.element.text+"",this.isActive=!1,this.value="",this.keys=[],this.excludedChars=[8,13,9,16,20,17,91],this.cursor=!1,this.lastCursorTime=Date.now(),this.app.keyboard.on("keyup",this.onKeyUp,this),this.entity.element.on("touchstart",this.onActive,this),this.autoFocus&&this.onActive()},CustomInput.prototype.onActive=function(t){if(this.isActive&&(this.entity.element.text=this.placeHolder,this.trigger&&this.app.fire(this.trigger,this.keys.join("")),this.keys=[]),this.isActive=!this.isActive,t){var e=window.prompt("Enter some value");this.isActive=!1,this.trigger&&this.app.fire(this.trigger,e)}},CustomInput.prototype.onKeyUp=function(t){if(13==t.key&&this.onActive(!1),!this.isActive)return!1;-1===this.excludedChars.indexOf(t.key)&&t.event.key&&this.keys.length<this.maxLength&&this.keys.push(t.event.key),8===t.key&&this.keys.splice(this.keys.length-1,1)},CustomInput.prototype.update=function(t){if(!this.isActive)return!1;Date.now()-this.lastCursorTime>200&&(this.keys.length<this.maxLength?this.cursor=!this.cursor:this.cursor=!1,this.lastCursorTime=Date.now()),this.placeholderEntity.enabled=this.keys.length<=0,this.value=this.keys.join(""),this.entity.element.text=this.keys.join("")+(this.cursor?"_":" ")};var Overlay=pc.createScript("overlay");Overlay.attributes.add("damageEntity",{type:"entity"}),Overlay.attributes.add("killCount",{type:"entity"}),Overlay.attributes.add("deathEntity",{type:"entity"}),Overlay.attributes.add("restartText",{type:"entity"}),Overlay.attributes.add("restartButton",{type:"entity"}),Overlay.attributes.add("reviveButton",{type:"entity"}),Overlay.attributes.add("mapHolder",{type:"entity"}),Overlay.attributes.add("playerEntity",{type:"entity"}),Overlay.attributes.add("progressBar",{type:"entity"}),Overlay.attributes.add("arrowEntity",{type:"entity"}),Overlay.attributes.add("stageText",{type:"entity"}),Overlay.attributes.add("transitionEntity",{type:"entity"}),Overlay.attributes.add("announceEntity",{type:"entity"}),Overlay.attributes.add("announceText",{type:"entity"}),Overlay.attributes.add("adblockText",{type:"entity"}),Overlay.attributes.add("alertEntity",{type:"entity"}),Overlay.attributes.add("alertText",{type:"entity"}),Overlay.attributes.add("useArrowsEntity",{type:"entity"}),Overlay.attributes.add("useTouchEntity",{type:"entity"}),Overlay.attributes.add("finishScreen",{type:"entity"}),Overlay.attributes.add("finishText",{type:"entity"}),Overlay.attributes.add("finishLevelText",{type:"entity"}),Overlay.attributes.add("finishMapText",{type:"entity"}),Overlay.attributes.add("arrowDamageText",{type:"entity"}),Overlay.attributes.add("finishStep1",{type:"entity"}),Overlay.attributes.add("finishStep2",{type:"entity"}),Overlay.attributes.add("arrowItem",{type:"entity"}),Overlay.attributes.add("finishUpgradeItem",{type:"entity"}),Overlay.attributes.add("finishUpgradeHolder",{type:"entity"}),Overlay.attributes.add("finishContinueButton",{type:"entity"}),Overlay.attributes.add("coinLoot",{type:"entity"}),Overlay.attributes.add("gemLoot",{type:"entity"}),Overlay.attributes.add("coinLootText",{type:"entity"}),Overlay.attributes.add("gemLootText",{type:"entity"}),Overlay.attributes.add("stagesEntity",{type:"entity"}),Overlay.attributes.add("bossEntity",{type:"entity"}),Overlay.attributes.add("bossHealthBar",{type:"entity"}),Overlay.attributes.add("bossText",{type:"entity"}),Overlay.attributes.add("chapterProgress",{type:"entity"}),Overlay.attributes.add("loadingScreen",{type:"entity"}),Overlay.attributes.add("moneyManager",{type:"entity"}),Overlay.attributes.add("runeManager",{type:"entity"}),Overlay.attributes.add("upgradeManager",{type:"entity"}),Overlay.attributes.add("mapManager",{type:"entity"}),Overlay.prototype.initialize=function(){this.killCounter=Utils.getItem("KillCounter")||0,this.killCount.element.text=this.killCounter+"",pc.BalanceSession.killCount=parseInt(this.killCounter),this.gameplayElements=this.app.root.findByTag("Gameplay"),this.restartCount=-1,this.lastTick=-1,this.finishUpgradeArray=[],this.currentArrowDamage=0,this.nextArrowDamage=0,this.currentBoss=!1,this.currentMapLevel=1,this.damageEntity.enabled=!0,this.startPoint=new pc.Vec3,this.endPoint=new pc.Vec3,this.currentLevel=0,this.animationPoint=0,this.levels=[],this.activeLevel=this.app.assets.find("Progress-Item-Active.png"),this.deactiveLevel=this.app.assets.find("Progress-Item.png"),this.app.on("Overlay:Level",this.setLevel,this),this.app.on("Overlay:Stage",this.setStage,this),this.app.on("Overlay:Finish",this.showFinish,this),this.app.on("Overlay:FinishContinue",this.continueFinish,this),this.app.on("Overlay:HideAll",this.hideAll,this),this.app.on("Overlay:Sound",this.playSound,this),this.app.on("Overlay:Transition",this.onTransition,this),this.app.on("Overlay:Announce",this.setAnnounce,this),this.app.on("Overlay:Adblock",this.showAdblock,this),this.app.on("Overlay:Alert",this.showAlert,this),this.app.on("Overlay:Chapter",this.showChapterProgress,this),this.app.on("Boss:Enter",this.onBossEnter,this),this.app.on("Boss:Death",this.onBossDeath,this),this.app.on("Enemy:Death",this.onEnemyDeath,this),this.app.on("Player:Respawn",this.onPlayerRespawn,this),this.app.on("Player:Death",this.onPlayerDeath,this),this.app.on("Player:Moved",this.onMoved,this),this.app.on("Stage:Reset",this.onStageReset,this),this.app.on("MapManager:RestartLevel",this.onRestart,this),this.app.on("Shader:Loaded",this.onShaderLoaded,this),this.app.on("Overlay:OpenLink",this.onOpenLink,this)},Overlay.prototype.onOpenLink=function(t){window.open(t,"_blank")},Overlay.prototype.showChapterProgress=function(){var t=pc.BalanceSession.mapName,e=this.mapManager.script.mapManager.currentLevel;if("Valley"==t&&1===e)return!1;this.chapterProgress.enabled=!0,this.chapterProgress.script.overlayChapters.showChapterProgress(),setTimeout((function(t){pc.app.fire("Overlay:Transition",(function(){t.chapterProgress.enabled=!1}))}),4e3,this)},Overlay.prototype.onMoved=function(){this.useArrowsEntity.enabled=!1,this.useTouchEntity.enabled=!1},Overlay.prototype.onShaderLoaded=function(t){"Ground"==t&&(this.loadingScreen.enabled=!1,Utils.isMobile()?(this.useArrowsEntity.enabled=!1,this.useTouchEntity.enabled=!0):(this.useArrowsEntity.enabled=!0,this.useTouchEntity.enabled=!1),Utils.isIOS()&&(this.useArrowsEntity.enabled=!1,this.useTouchEntity.enabled=!0),console.log(this.useArrowsEntity.enabled))},Overlay.prototype.onBossEnter=function(t){this.bossEntity.enabled=!0,this.stagesEntity.enabled=!1,this.bossText.element.text=t.name,this.currentBoss=t},Overlay.prototype.onBossDeath=function(t){this.bossEntity.enabled=!1,this.stagesEntity.enabled=!0,this.currentBoss=!1},Overlay.prototype.setAnnounce=function(t){this.announceEntity.enabled=!0,this.announceText.element.text=t,setTimeout((function(t){t.announceEntity.enabled=!1}),2e3,this)},Overlay.prototype.showAlert=function(t){this.alertEntity.enabled=!0,this.alertText.element.text=t,setTimeout((function(t){t.alertEntity.enabled=!1}),4e3,this)},Overlay.prototype.showAdblock=function(){this.adblockText.enabled=!0,setTimeout((function(t){t.adblockText.enabled=!1}),4e3,this)},Overlay.prototype.showFinish=function(t,e){this.currentArrowDamage=this.arrowItem.script.bullet.damage,this.nextArrowDamage=this.arrowItem.script.bullet.damage,this.finishUpgradeHolder.layoutgroup.enabled=!0,this.finishScreen.enabled=!0,this.finishStep1.enabled=!0,this.finishStep2.enabled=!1,this.finishText.element.text="You completed level "+t+"!",this.finishLevelText.element.text=t,this.finishMapText.element.text=e,this.moneyManager.script.moneyManager.mapLoot[e]?this.coinLootText.element.text=this.moneyManager.script.moneyManager.mapLoot[e]+"":this.coinLootText.element.text="0",this.gemLootText.element.text="0",this.coinLoot.enabled=!1,this.gemLoot.enabled=!1,setTimeout((function(t){t.coinLoot.enabled=!0}),500,this),setTimeout((function(t){t.gemLoot.enabled=!0}),900,this);for(var i=this.upgradeManager.script.upgradeManager.currentUpgrades,a=this.finishUpgradeArray.length;a--;)this.finishUpgradeArray[a].destroy();for(var n in this.finishUpgradeArray=[],this.finishUpgradeItem.enabled=!1,i){var s=i[n],r=this.finishUpgradeItem.clone();r.enabled=!0,r.findByName("Icon").element.textureAsset=s.icon,this.finishUpgradeHolder.addChild(r),this.finishUpgradeArray.push(r)}this.app.fire("ExperienceManager:GameFinishUpgrade",this.finishUpgradeArray),this.app.fire("UpgradeManager:Reset")},Overlay.prototype.continueFinish=function(){if(this.finishStep2.enabled)return this.finishScreen.enabled=!1,this.app.fire("MapManager:LoadNextMap"),!1;this.finishStep1.enabled=!1,this.finishStep2.enabled=!0,this.playUpgradeCombine(),this.finishContinueButton.element.active=!1},Overlay.prototype.playUpgradeCombine=function(){var t=this.finishUpgradeArray.length;for(this.finishUpgradeHolder.layoutgroup.enabled=!1;t--;){var e=this.finishUpgradeArray[t];setTimeout((function(t,e){e.fire("Motion","Add"),setTimeout((function(){e.destroy()}),300),t.increaseArrowDamage()}),700*t,this,e)}},Overlay.prototype.increaseArrowDamage=function(){this.nextArrowDamage+=1},Overlay.prototype.hideAll=function(){this.finishScreen.enabled=!1},Overlay.prototype.onTransition=function(t){this.transitionEntity.fire("Timeline",{isReverse:!0}),setTimeout((function(e){t(),e.transitionEntity.fire("Timeline")}),1e3,this)},Overlay.prototype.onPlayerRespawn=function(){this.deathEntity.enabled=!1,this.app.fire("Menu:DisableAll"),this.gameplayElements.forEach((function(t){t.enabled=!0}))},Overlay.prototype.onStageReset=function(){this.deathEntity.enabled=!1,this.app.fire("Menu:DisableAll"),this.gameplayElements.forEach((function(t){t.enabled=!0}))},Overlay.prototype.onPlayerDeath=function(){this.gameplayElements.forEach((function(t){t.enabled=!1})),setTimeout((function(t){t.restartCount=3,t.deathEntity.enabled=!0}),1e3,this),setTimeout((function(t){pc.app.fire("Gameplay:Revive")}),4e3,this),this.entity.sound.play("Death"),PokiPlugin.onPause()},Overlay.prototype.onRestart=function(){this.gameplayElements.forEach((function(t){t.enabled=!0})),this.deathEntity.enabled=!1,this.restartCount=-1},Overlay.prototype.onEnemyDeath=function(){this.killCounter++,this.killCount.element.text=this.killCounter+"",Utils.setItem("KillCounter",this.killCounter),pc.BalanceSession.killCount=this.killCounter},Overlay.prototype.playSound=function(t){this.entity.sound.play(t)},Overlay.prototype.setLevel=function(t){this.currentMapLevel=t},Overlay.prototype.setStage=function(t,e,i){this.startPoint=e.getPosition().clone(),this.currentLevel=t,this.levels=i,this.stageText.element.text=this.currentLevel+" / "+this.levels.length,this.currentLevel>0&&setTimeout((function(t){t.levels.length==t.currentLevel+1?t.app.fire("Overlay:Announce","Final Stage!"):t.app.fire("Overlay:Announce","Stage - "+t.currentLevel)}),1e3,this);var a=pc.BalanceSession.mapName+"-"+this.mapManager.script.mapManager.currentLevel+"-"+this.currentLevel;console.log("Event:",a),this.app.fire("Checkpoint:Event",a)},Overlay.prototype.updateProgressBar=function(t){if(0===this.levels.length)return!1;this.startPoint.z,this.endPoint.z,this.playerEntity.getPosition().z,this.currentLevel,this.levels.length;this.animationPoint=pc.math.lerp(this.animationPoint,this.currentLevel/this.levels.length,.1),this.progressBar.setLocalScale(this.animationPoint,1,1),this.arrowEntity.setLocalPosition(500*this.animationPoint,28,0)},Overlay.prototype.updateBossHealth=function(){if(!this.currentBoss)return!1;var t=this.currentBoss.script.label.healthRatio;this.bossHealthBar.setLocalScale(t,1,1)},Overlay.prototype.update=function(t){pc.isInterfaceLocked=!1,this.updateProgressBar(t),this.updateBossHealth(),this.restartCount>=0&&(this.restartCount>0?(this.restartText.element.text="Restart ("+this.restartCount+")",this.restartButton.button.active=!1):(this.restartText.element.text="Restart",this.restartButton.button.active=!0),Date.now()-this.lastTick>1e3&&(this.restartCount--,this.lastTick=Date.now())),this.finishStep2.enabled&&(this.currentArrowDamage=pc.math.lerp(this.currentArrowDamage,this.nextArrowDamage,.05),this.arrowDamageText.element.text=parseFloat(this.currentArrowDamage).toFixed(2))};var Gameplay=pc.createScript("gameplay");Gameplay.attributes.add("resetPopupEntity",{type:"entity"}),Gameplay.prototype.initialize=function(){this.isPaused=!1,this.lastLoadRequest=-1,this.app.on("Gameplay:Reset",this.onReset,this),this.app.on("Gameplay:ShowResetPopup",this.showResetPopup,this),this.app.on("Gameplay:CloseResetPopup",this.closeResetPopup,this),this.app.on("Gameplay:Revive",this.onRevive,this),this.app.on("Gameplay:Restart",this.onRestart,this),this.app.on("Gameplay:LoadMap",this.loadMap,this),setTimeout((function(t){pc.app.fire("Gameplay:OnLoad")}),100,this)},Gameplay.prototype.loadMap=function(t){if(Date.now()-this.lastLoadRequest<1e3)return!1;this.app.fire("Player:Stop"),this.app.fire("Overlay:Transition",(function(){pc.app.fire("MapManager:LoadMap",t)})),this.lastLoadRequest=Date.now()},Gameplay.prototype.onRevive=function(){this.app.fire("Stage:Reset")},Gameplay.prototype.onRestart=function(){var t=this;this.app.fire("Player:Stop"),this.app.fire("Overlay:Transition",(function(){t.app.fire("MapManager:RestartLevel")})),PokiPlugin.onPlay()},Gameplay.prototype.showResetPopup=function(){this.resetPopupEntity.enabled=!0},Gameplay.prototype.closeResetPopup=function(){this.resetPopupEntity.enabled=!1},Gameplay.prototype.onReset=function(){window.localStorage.clear(),window.location.reload()},Gameplay.prototype.update=function(){this.app.keyboard.wasPressed(pc.KEY_P)&&this.onPause()};var Bar=pc.createScript("bar");Bar.prototype.initialize=function(){this.app.on("Bar:"+this.entity.name,this.onBarSet,this)},Bar.prototype.onBarSet=function(t){var a=Math.max(Math.min(t,1),0);this.entity.setLocalScale(a,1,1)};var Enemy=pc.createScript("enemy");Enemy.attributes.add("name",{type:"string",default:"None"}),Enemy.attributes.add("health",{type:"number",default:100}),Enemy.attributes.add("damage",{type:"number",default:1}),Enemy.attributes.add("experience",{type:"number",default:1}),Enemy.attributes.add("repelFactor",{type:"number",default:.25}),Enemy.attributes.add("modelEntity",{type:"entity"}),Enemy.attributes.add("playerEntity",{type:"entity"}),Enemy.attributes.add("sprayEntity",{type:"entity"}),Enemy.attributes.add("howMany",{type:"number",default:5}),Enemy.attributes.add("freezeTime",{type:"number",default:1}),Enemy.attributes.add("projectileType",{type:"string",default:"Projectile"}),Enemy.prototype.initialize=function(){this.coinEntity=this.app.root.findByName("Coin"),this.lastSpawnTime=Date.now(),this.lastSpawnDelay=100,this.createdAt=Date.now(),this.willAttackEnemy=Math.random()>.5,this.repelForce=new pc.Vec3(0,0,0),this.emptyForce=new pc.Vec3(0,0,0),this.isDeath=!1,this.lastWaypointSet=Date.now(),this.entity.on("Hit",this.onDamage,this),this.entity.on("Target:Move",this.movingToTarget,this),this.entity.on("Target:Reach",this.onTarget,this),this.entity.on("Target:Changed",this.onTargetChange,this),this.entity.on("Target:Have",this.haveTarget,this),this.entity.on("Coin:Set",this.setCoin,this),this.modelEntity.anim.on("AttackHit",this.onAttackHit,this),this.modelEntity.anim.on("ProjectileHit",this.onProjectileHit,this),this.modelEntity.anim.on("TripleSpinHit",this.onTripleHit,this),this.modelEntity.anim.on("SpellHit",this.onSpellHit,this),this.modelEntity.anim.on("SpinHit",this.onSpinHit,this),this.modelEntity.anim.on("Explode",this.onExplode,this),this.modelEntity.anim.on("SpawnHelpers",this.onSpawnHelpers,this),this.modelEntity.anim.on("Spray",this.onSpray,this),this.entity.ownerType="Enemy",this.entity.fire("Define",{name:"None"==this.name?this.entity.name:this.name,health:this.health,level:1}),this.app.fire("Enemy:Spawn"),this.app.fire("Scene:AddCollision",this.entity),this.on("destroy",this.onDestroy,this)},Enemy.prototype.onDestroy=function(){this.app.fire("Enemy:Update")},Enemy.prototype.haveTarget=function(t){if(this.currentTarget==t)return!1;t.tags.list().indexOf("EnemyCanHit")>-1&&(this.setRandomSoundPitch(),this.entity.sound.play("Notice"),this.currentTarget=t)},Enemy.prototype.setCoin=function(){this.howMany=0},Enemy.prototype.movingToTarget=function(){this.lastMoveTime=Date.now()},Enemy.prototype.onTargetChange=function(){this.isAttacking=!1},Enemy.prototype.onTarget=function(t){return t&&t.enabled&&t.parent?"Player"==t.name&&t.script.player.isDeath?(this.isAttacking=!1,!1):void(t.tags.list().indexOf("EnemyCanHit")>-1&&(this.isAttacking=t)):(this.isAttacking=!1,!1)},Enemy.prototype.attackEnemy=function(){this.isAttacking&&!0===this.isAttacking.enabled&&this.isAttacking.parent?this.modelEntity.anim.setBoolean("Attacking",!0):this.modelEntity.anim.setBoolean("Attacking",!1)},Enemy.prototype.onAttackHit=function(){if(this.isFreeze)return!1;this.isAttacking&&this.isAttacking.fire("Hit",this.damage),this.setRandomSoundPitch(),this.entity.sound.play("Attack")},Enemy.prototype.onProjectileHit=function(){this.app.fire("ShootManager:Shoot","Enemy",this.projectileType,this.entity.getPosition(),this.playerEntity.getPosition()),this.setRandomSoundPitch(),this.entity.sound.play("Attack")},Enemy.prototype.onTripleHit=function(){for(var t=-40;t<=40;t+=40)this.app.fire("ShootManager:Shoot","Enemy",this.projectileType,this.entity.getPosition(),this.playerEntity.getPosition(),t);this.setRandomSoundPitch(),this.entity.sound.play("Attack")},Enemy.prototype.onSpinHit=function(){this.app.fire("ShootManager:Shoot","Enemy","Projectile",this.entity.getPosition(),this.playerEntity.getPosition()),this.setRandomSoundPitch(),this.entity.sound.play("Attack")},Enemy.prototype.onSpellHit=function(){this.app.fire("ShootManager:Shoot","Enemy","Spell",this.entity.getPosition(),this.playerEntity.getPosition()),this.setRandomSoundPitch(),this.entity.sound.play("Attack")},Enemy.prototype.onSpray=function(){this.sprayEntity.particlesystem.stop(),this.sprayEntity.particlesystem.reset(),this.sprayEntity.particlesystem.play()},Enemy.prototype.onExplode=function(){this.app.fire("ShootManager:Explode","Enemy","Explosion",this.entity.getPosition()),this.death()},Enemy.prototype.onSpawnHelpers=function(){this.app.fire("Stage:SpawnHelpers")},Enemy.prototype.setRandomSoundPitch=function(){this.entity.sound.pitch=Math.random()*(1-.8)+.8},Enemy.prototype.onDamage=function(t,e,i){if(this.isDeath)return!1;if(Date.now()-this.createdAt<1500)return!1;if(this.health-=t,this.health<=0&&this.death(),this.entity.fire("Health",this.health),i){var n=this.entity.getPosition(),s=Utils.lookAt(n.x,n.z,i.x,i.z)-Math.PI/2;this.repelForce.x=-Math.cos(s)*this.repelFactor,this.repelForce.z=Math.sin(s)*this.repelFactor}"IceArrow"==e?(this.isFreeze=!0,this.entity.fire("Locked",!0),setTimeout((function(t){t.isFreeze=!1,t.entity.fire("Locked",!1)}),1e3*this.freezeTime,this)):(this.app.fire("Motion","HitShake"),this.app.fire("EffectManager:HitEffect",this.entity.getPosition())),this.setRandomSoundPitch(),this.entity.sound.play("Damage")},Enemy.prototype.death=function(){if(this.isDeath)return!1;this.isDeath=!0,this.modelEntity.anim.setTrigger("Death"),this.entity.fire("PathMove:Pause"),this.setRandomSoundPitch(),this.entity.sound.play("Death"),this.lastSpawnTime=Date.now(),this.lastSpawnDelay=500,this.entity.fire("Death"),this.entity.isDeath=!0,this.entity.script.target&&(this.entity.script.target.enabled=!1),this.app.fire("Enemy:Death",this.entity.name,this.experience),this.app.fire("Scene:RemoveCollision",this.entity),setTimeout((function(t){t.entity.destroy(),pc.app.fire("Enemy:Update")}),2e3,this)},Enemy.prototype.spawnGolds=function(){if(!this.isDeath)return!1;if(Date.now()-this.lastSpawnTime<this.lastSpawnDelay)return!1;if(this.howMany<=0)return!1;var t=new pc.Vec3(2*Math.random()-1,0,2*Math.random()-1),e=this.coinEntity.clone();e.enabled=!0,e.setPosition(this.entity.getPosition().clone().add(t)),this.app.root.addChild(e),this.lastSpawnDelay=100+50*Math.random(),this.lastSpawnTime=Date.now(),this.howMany--},Enemy.prototype.update=function(t){if(!Utils.isGameActive)return!1;this.willAttackEnemy&&Date.now()-this.lastSpawnTime>5e3&&this.entity.fire("Attack:SetType","Enemy"),this.repelForce=this.repelForce.lerp(this.repelForce,this.emptyForce,16.6*t),this.entity.translate(this.repelForce),this.modelEntity.anim.setBoolean("Walking",Date.now()-this.lastMoveTime<100),this.spawnGolds(),this.attackEnemy()};var Coin=pc.createScript("coin");Coin.attributes.add("value",{type:"number",default:5}),Coin.prototype.initialize=function(){this.isDestroyed=!1,this.entity.on("Trigger",this.onTrigger,this),this.app.fire("Scene:AddTrigger",this.entity),setTimeout((function(t){t.entity.destroy()}),2e4,this)},Coin.prototype.onTrigger=function(t){if(this.isDestroyed)return!1;this.entity.fire("Motion","Destroy"),this.app.fire("Money:Add",this.value),this.app.fire("DealtDamage:Trigger",this.value,this.entity.getPosition()),setTimeout((function(t){t.entity.destroy()}),200,this),this.isDestroyed=!0};var Target=pc.createScript("target");Target.attributes.add("originEntity",{type:"entity"}),Target.attributes.add("targetTag",{type:"string"}),Target.attributes.add("target",{type:"entity"}),Target.attributes.add("playerEntity",{type:"entity"}),Target.attributes.add("coreEntity",{type:"entity"}),Target.attributes.add("speed",{type:"number",default:.1}),Target.attributes.add("turnSpeed",{type:"number",default:.1}),Target.attributes.add("maxPlayerDistance",{type:"number",default:3}),Target.attributes.add("scanTime",{type:"number",default:100}),Target.attributes.add("strategicAttack",{type:"boolean",default:!1}),Target.prototype.initialize=function(){this.isActive=!1,this.locked=!1,this.direction=0,this.lastScanTime=Date.now(),this.createdAt=Date.now(),this.targetVector=new pc.Vec3(0,0,0),this.entity.on("Target:Refresh",this.refreshEnemies,this),this.entity.on("Target:Set",this.setTarget,this),this.entity.on("Attack:SetType",this.setAttackType,this),this.refreshEnemies(),this.entity.on("Locked",this.setLocked,this)},Target.prototype.setTarget=function(t){this.entity.tags.list().indexOf("EnemyCanHit")>-1&&(this.isActive=!0,this.target=t)},Target.prototype.setLocked=function(t){this.locked=t},Target.prototype.refreshEnemies=function(){this.entities=this.app.root.findByTag(this.targetTag)},Target.prototype.setAttackType=function(t){this.isActive="Protect"==t||"Enemy"==t},Target.prototype.getClosestEnemies=function(t){if(Date.now()-this.lastScanTime<this.scanTime)return!1;for(var e,i=this.entities,a=this.entity.getPosition(),s=99999,r=0;r<i.length;r++){var n=i[r],h=n.getPosition(),o=a.clone().sub(h).length();n.enabled&&n.parent&&o<s&&(s=o,e=n)}e&&(this.target=e);var g=this.playerEntity.getPosition(),c=a.clone().sub(g).length();if(!this.target&&c<this.maxPlayerDistance&&(this.target=this.playerEntity),this.strategicAttack){var y=this.playerEntity.findByTag("AttackPoint");if(y.length>0){var d=Math.floor(Math.random()*y.length);this.target=y[d]}this.targetVector=this.target.getPosition().clone()}this.target&&this.entity.fire("Target:Have",this.target),this.lastScanTime=Date.now()},Target.prototype.update=function(t){if(!Utils.isGameActive)return!1;if(Date.now()-this.createdAt<1e3)return!1;if(!this.isActive)return!1;if(this.locked)return!1;if(this.getClosestEnemies(),!this.target)return!1;var e=this.entity.getPosition(),i=this.target.getPosition();if(this.strategicAttack&&(i=this.targetVector.clone()),e.clone().sub(i).length()<1)return this.entity.fire("Target:Reach",this.target),!1;var a=Utils.lookAt(e.x,e.z,i.x,i.z);if(this.direction=Utils.rotate(this.direction,a,this.turnSpeed*t),this.strategicAttack){var s=this.playerEntity.getPosition();a=Utils.lookAt(e.x,e.z,s.x,s.z);this.originEntity.setLocalEulerAngles(0,a*pc.math.RAD_TO_DEG,0)}else this.originEntity.setLocalEulerAngles(0,this.direction*pc.math.RAD_TO_DEG,0);var r=this.direction-Math.PI/2,n=Math.cos(r)*t*this.speed,h=-Math.sin(r)*t*this.speed;this.entity.translate(n,0,h),this.entity.fire("Target:Move"),this.entity.fire("Target:Changed",!1)};var EnemySpawn=pc.createScript("enemySpawn");EnemySpawn.attributes.add("enemies",{type:"entity",array:!0}),EnemySpawn.prototype.initialize=function(){for(var n=0;n<this.enemies.length;n++)this.enemies[n].enabled=!1;this.app.on("EnemySpawn:Clear",this.clearEnemies,this),this.app.on("EnemySpawn:Spawn",this.spawnEnemies,this),this.app.on("EnemySpawn:SpawnByPoint",this.spawnByPoint,this),this.app.on("EnemySpawn:SpawnByPoints",this.spawnByPoints,this)},EnemySpawn.prototype.findEnemyByName=function(n){for(var e=0;e<this.enemies.length;e++)if(this.enemies[e].name===n)return this.enemies[e];return null},EnemySpawn.prototype.spawnEnemy=function(n,e){var t=this.findEnemyByName(n);if(!t)return!1;var i=t.clone();e.tags.list().indexOf("NoBoss")>-1&&i.tags.add("NoBoss"),i.enabled=!0;e.getPosition();i.setLocalPosition(0,0,0),e.model.enabled=!1,i.reparent(e),i.fire("Attack:SetType","Enemy"),e.tags.list().indexOf("Locked")>-1&&i.fire("Coin:Set",0)},EnemySpawn.prototype.clearEnemies=function(n){var e=n.findByTag("Enemy");for(var t in e){var i=e[t];i&&i.destroy()}},EnemySpawn.prototype.spawnEnemies=function(n,e){if(!n)return!1;var t="Spawn";e&&(t=e);var i=n.findByTag(t);for(var a in i){var s=i[a],p=s.name;this.spawnEnemy(p,s)}},EnemySpawn.prototype.spawnByPoints=function(n){if(!n)return!1;for(var e in n){var t=n[e],i=t.name;this.spawnEnemy(i,t)}},EnemySpawn.prototype.spawnByPoint=function(n){if(!n)return!1;this.spawnEnemy(n.name,n)};var ShootingManager=pc.createScript("shootingManager");ShootingManager.attributes.add("arrowEntity",{type:"entity"}),ShootingManager.attributes.add("cannonEntity",{type:"entity"}),ShootingManager.attributes.add("dragonSpell",{type:"entity"}),ShootingManager.attributes.add("dragonElectroSpell",{type:"entity"}),ShootingManager.attributes.add("spellEntity",{type:"entity"}),ShootingManager.attributes.add("snowballEntity",{type:"entity"}),ShootingManager.attributes.add("bigSnowballEntity",{type:"entity"}),ShootingManager.attributes.add("bounceCannon",{type:"entity"}),ShootingManager.attributes.add("freezeCannon",{type:"entity"}),ShootingManager.attributes.add("projectileEntity",{type:"entity"}),ShootingManager.attributes.add("explosionEntity",{type:"entity"}),ShootingManager.attributes.add("splashEntity",{type:"entity"}),ShootingManager.attributes.add("explosiveArrowEntity",{type:"entity"}),ShootingManager.attributes.add("mapHolder",{type:"entity"}),ShootingManager.attributes.add("playerEntity",{type:"entity"}),ShootingManager.attributes.add("boulderRadius",{type:"number",default:.8}),ShootingManager.attributes.add("wallRadius",{type:"number",default:.8}),ShootingManager.prototype.initialize=function(){this.bullets=[],this.walls=[],this.enemies=[this.playerEntity],this.app.on("ShootManager:Shoot",this.onShoot,this),this.app.on("ShootManager:Explode",this.onExplode,this),this.app.on("Enemy:Spawn",this.onEnemies,this),this.app.on("Enemy:Update",this.onEnemies,this),this.app.on("Scene:Collision",this.onMapLoad,this)},ShootingManager.prototype.onMapLoad=function(){this.boulders=this.app.root.findByTag("Rock"),this.walls=this.app.root.findByTag("Wall")},ShootingManager.prototype.onEnemies=function(){this.enemies=this.mapHolder.findByTag("Shootable"),this.enemies.push(this.playerEntity)},ShootingManager.prototype.onShoot=function(t,e,i,n,o,s){var a=this,l=!1,r=o||0;"Cannon"==e?l=this.cannonEntity.clone():"DragonSpell"==e?l=this.dragonSpell.clone():"DragonElectroSpell"==e?l=this.dragonElectroSpell.clone():"Snowball"==e?l=this.snowballEntity.clone():"BigSnowball"==e?l=this.bigSnowballEntity.clone():"BounceCannon"==e?l=this.bounceCannon.clone():"FreezeCannon"==e?l=this.freezeCannon.clone():"Arrow"==e?l=this.arrowEntity.clone():"Projectile"==e?l=this.projectileEntity.clone():"Spell"==e&&(l=this.spellEntity.clone());var h=Utils.lookAt(n.x,n.z,i.x,i.z);for(var p in l.enabled=!0,l.setEulerAngles(0,h*pc.math.RAD_TO_DEG+r,0),l.setPosition(i),l.ownerType=t,l.on("destroy",(function(){a.bullets.splice(a.bullets.indexOf(l),1)})),s)l[p]=s[p];l.damage&&(l.script.bullet.damage=l.damage),this.app.root.addChild(l),this.bullets.push(l)},ShootingManager.prototype.checkArrowCollisions=function(){for(var t=this.enemies.length;t--;)for(var e=this.bullets.length;e--&&(!this.bullets[e].blockedEntity||this.bullets[e].blockedEntity!=this.enemies[t]);){var i=this.bullets[e].name,n=this.enemies[t].ownerType,o=this.enemies[t].getPosition(),s=this.bullets[e].getPosition(),a=this.bullets[e].damage,l=this.bullets[e].radius,r=Utils.distance(o.x,o.z,s.x,s.z);for(var h in("Everyone"==this.bullets[e].ownerType||this.bullets[e].ownerType!=n)&&r<l&&this.enemies[t].parent&&this.enemies[t].enabled&&!this.enemies[t].isDeath&&(this.app.fire("ShootingManager:Hit",this.enemies[t],a,i,s,this.bullets[e]),this.enemies[t].fire("Hit",a,i,s),"Player"==this.bullets[e].ownerType&&this.enemies[t].fire("Target:Set",this.playerEntity),this.bullets[e].destroy()),this.boulders){var p=this.boulders[h];if(p!=this.playerEntity){var d=p.getPosition();Utils.distance(d.x,d.z,s.x,s.z)<this.boulderRadius&&(this.onExplode("Everyone","ExplosiveArrow",d),this.bullets[e]&&this.bullets[e].destroy())}}}for(var y=this.walls.length;y--;){var g=this.walls[y].getPosition();for(e=this.bullets.length;e--;){s=this.bullets[e].getPosition();Utils.distance(g.x,g.z,s.x,s.z)<this.wallRadius&&this.bullets[e].destroy()}}},ShootingManager.prototype.onExplode=function(t,e,i){var n=!1;if("Splash"==e)n=this.splashEntity.clone();else if("Explosion"==e)n=this.explosionEntity.clone();else if("ExplosiveArrow"==e)n=this.explosiveArrowEntity.clone();if(!n)return!1;n.enabled=!0,n.setPosition(i),n.ownerType=t,this.app.root.addChild(n);for(var o=0;o<this.enemies.length;o++){var s=this.enemies[o].getPosition(),a=Utils.distance(s.x,s.z,i.x,i.z);this.enemies[o].ownerType!=t&&a<n.script.explosion.radius&&this.enemies[o].parent&&this.enemies[o].enabled&&this.enemies[o].fire("Hit",n.script.explosion.damage,"Explosion",i)}},ShootingManager.prototype.update=function(t){this.checkArrowCollisions()};var Turret=pc.createScript("turret");Turret.attributes.add("health",{type:"number",default:100}),Turret.attributes.add("stationEntity",{type:"entity"}),Turret.attributes.add("originEntity",{type:"entity"}),Turret.attributes.add("cannonEntity",{type:"entity"}),Turret.attributes.add("aimEntity",{type:"entity"}),Turret.attributes.add("maxDistance",{type:"number",default:5}),Turret.attributes.add("shootTime",{type:"number",default:2}),Turret.prototype.postInitialize=function(){this.isActive=!0,this.maxHealth=parseInt(this.health+""),this.enemies=[],this.targetEntity=!1,this.lastShootTime=Date.now(),this.cannonTarget=new pc.Vec3(0,0,0),this.entity.ownerType="Player",this.app.on("Enemy:Spawn",this.onEnemySpawn,this),this.entity.on("Hit",this.onDamage,this),this.entity.on("Reset",this.reset,this),this.entity.fire("Define",{name:this.entity.name,health:this.health,level:1,offset:new pc.Vec3(0,1.5,0)})},Turret.prototype.reset=function(){this.health=this.maxHealth,this.isDeath=!1,this.entity.fire("Health",this.health)},Turret.prototype.onDamage=function(t){this.health-=t,this.health<=0&&this.death(),this.entity.fire("Health",this.health)},Turret.prototype.death=function(){if(this.isDeath)return!1;this.isDeath=!0,this.stationEntity&&this.stationEntity.fire("Reset"),this.entity.enabled=!1},Turret.prototype.onEnemySpawn=function(){this.enemies=this.app.root.findByTag("Enemy")},Turret.prototype.scanClosestEnemy=function(){for(var t=null,e=Number.MAX_VALUE,i=0;i<this.enemies.length;i++){var n=this.enemies[i],s=this.entity.getPosition().sub(n.getPosition()).length();n.enabled&&!n.script.enemy.isDeath&&s<e&&s<this.maxDistance&&(t=n,e=s)}this.targetEntity=t||!1},Turret.prototype.shoot=function(){return!!this.isActive&&(!(Date.now()-this.lastShootTime<1e3*this.shootTime)&&(this.app.fire("ShootManager:Shoot","Player","Cannon",this.originEntity.getPosition(),this.cannonTarget),this.app.fire("EffectManager:CannonTraceEffect",this.originEntity.getPosition(),this.cannonTarget),this.entity.sound.play("Trace"),this.entity.sound.play("Cannon"),this.cannonEntity.fire("Motion","Shoot"),void(this.lastShootTime=Date.now())))},Turret.prototype.update=function(t){if(this.scanClosestEnemy(),this.targetEntity){var e=this.entity.getPosition();this.cannonTarget=this.cannonTarget.lerp(this.cannonTarget,this.targetEntity.getPosition(),.05);var i=Utils.lookAt(e.x,e.z,this.cannonTarget.x,this.cannonTarget.z);this.aimEntity.setLocalEulerAngles(0,i*pc.math.RAD_TO_DEG-90,0),this.originEntity.lookAt(this.cannonTarget),this.shoot(),this.aimEntity.enabled=!0}else this.aimEntity.enabled=!1};var Bullet=pc.createScript("bullet");Bullet.attributes.add("radius",{type:"number",default:1}),Bullet.attributes.add("speed",{type:"number",default:1}),Bullet.attributes.add("damage",{type:"number",default:1}),Bullet.attributes.add("bounce",{type:"boolean",default:!1}),Bullet.attributes.add("freeze",{type:"boolean",default:!1}),Bullet.attributes.add("shootingManagerEntity",{type:"entity"}),Bullet.prototype.initialize=function(){this.createdAt=Date.now(),this.entity.damage=this.damage,this.entity.radius=this.radius,this.bounce&&(this.bounceEntities=this.app.root.findByTag("Bounce")),this.freeze&&(this.shootingManagerScript=this.shootingManagerEntity.script.shootingManager)},Bullet.prototype.checkCollisions=function(t){for(var e in t){var i=t[e],a=i.getPosition(),s=this.entity.getPosition();if(Utils.distance(s.x,s.z,a.x,a.z)<.5)return i}},Bullet.prototype.update=function(t){if(this.entity.translateLocal(0,0,-this.speed*t),this.bounce&&this.checkCollisions(this.bounceEntities)&&this.entity.rotate(0,0,180),this.freeze){var e=this.shootingManagerScript.enemies,i=this.checkCollisions(e);i&&i.fire("Hit",0,"IceArrow")}Date.now()-this.createdAt>3e3&&this.entity.destroy()};var Player=pc.createScript("player");Player.attributes.add("health",{type:"number",default:100}),Player.attributes.add("characterEntity",{type:"entity"}),Player.attributes.add("sphereShieldEntity",{type:"entity"}),Player.attributes.add("healEffectEntity",{type:"entity"}),Player.prototype.postInitialize=function(){this.isDeath=!1,this.isImmunity=!1,this.entity.fire("Define",{name:"Player",health:this.health,offset:new pc.Vec3(0,2,0)}),this.entity.on("Health",this.setHealth,this),this.entity.on("Hit",this.onDamage,this),this.app.on("Player:Respawn",this.onRespawn,this),this.app.on("Player:Immunity",this.onImmunity,this),this.app.on("MapManager:RestartLevel",this.onRespawn,this),this.app.on("Station:ShootBoost",this.onShotAbility,this)},Player.prototype.setHealth=function(t){if(this.health<t){var e=this.entity.script.label.labelEntity.findByName("HealEffect");e.enabled=!0,setTimeout((function(){e.enabled=!1}),2e3,this)}this.health=t},Player.prototype.onShotAbility=function(t){this.onShotAbility=t,this.characterEntity.anim.speed=t?2:1},Player.prototype.onRespawn=function(){this.isDeath=!1,this.app.fire("Camera:BlackWhite",!1),this.app.fire("Stage:Spawn",this.entity),this.entity.fire("Health",100)},Player.prototype.onImmunity=function(){this.sphereShieldEntity.enabled=!0},Player.prototype.onDamage=function(t){return!this.isImmunity&&(!this.isDeath&&(this.app.fire("DealtDamage:Trigger",t,this.entity.getPosition()),this.app.fire("Motion","BigShake"),this.app.fire("Timeline:Damage"),this.entity.sound.play("Get-Damage"),this.entity.fire("Health",this.health-t),void(this.health<=0&&this.death())))},Player.prototype.death=function(){if(this.isDeath)return!1;this.isDeath=!0,this.entity.fire("Death"),this.app.fire("Camera:BlackWhite",!0),this.app.fire("Player:Death")};Object.assign(pc,function(){var BlackWhiteEffect=function(t){pc.PostEffect.call(this,t);var e={aPosition:pc.SEMANTIC_POSITION},i=["attribute vec2 aPosition;","","varying vec2 vUv0;","","void main(void)","{","    gl_Position = vec4(aPosition, 0.0, 1.0);","    vUv0 = (aPosition.xy + 1.0) * 0.5;","}"].join("\n"),c=["precision "+t.precision+" float;","","uniform sampler2D uColorBuffer;","varying vec2 vUv0;","","void main() {","    vec4 color = texture2D(uColorBuffer, vUv0);","    float gray = dot(color.rgb, vec3(0.199, 0.587, 0.114));","    gl_FragColor = vec4(vec3(gray), 1.0);","}"].join("\n");this.blackWhiteShader=new pc.Shader(t,{attributes:e,vshader:i,fshader:c})};return(BlackWhiteEffect.prototype=Object.create(pc.PostEffect.prototype)).constructor=BlackWhiteEffect,Object.assign(BlackWhiteEffect.prototype,{render:function(t,e,i){var c=this.device;c.scope.resolve("uColorBuffer").setValue(t.colorBuffer),pc.drawFullscreenQuad(c,e,this.vertexBuffer,this.blackWhiteShader,i)}}),{BlackWhiteEffect:BlackWhiteEffect}}());var BlackWhite=pc.createScript("blackWhite");BlackWhite.prototype.initialize=function(){this.effect=new pc.BlackWhiteEffect(this.app.graphicsDevice),this.effect.offset=this.offset,this.effect.darkness=this.darkness,this.on("attr",(function(t,e){this.effect[t]=e}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};var checkpoint={gameName:"archers_bounty",version:"v1",serviceURL:"patch/json/null.json?data.onrushstats.com/",init:function(){var e=Utils.getItem("FirstLogin")?"existing_user":"new_user";this.gameName=this.gameName+"_"+this.version+"_"+(Utils.isMobile()?"mobile":"desktop")+"_"+e,Utils.getItem("FirstLogin")||Utils.setItem("FirstLogin",Date.now()),this.setCheckpoint("FirstEntry"),pc.app.on("Checkpoint:Event",this.setCheckpoint,this)},setCheckpoint:function(e){console.log("[EVENT]",e),"undefined"!=typeof PokiSDK&&PokiSDK.customEvent("game","segment",{label:"level",value:e+""}),this.service("?request=save_data",{game_name:this.gameName,checkpoint:e},(function(e){}))},service:function(e,t,n){var i="string"==typeof t?t:Object.keys(t).map((function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])})).join("&"),s=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");s.open("POST",Utils.prefixCDN+e),s.onreadystatechange=function(){s.readyState>3&&200==s.status&&n(JSON.parse(s.responseText))},s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.send(i)}};window.addEventListener("load",(function(){checkpoint.init()}));var GameRoot=pc.createScript("gameRoot");GameRoot.attributes.add("transitionEntity",{type:"entity"}),GameRoot.attributes.add("loadingScreen",{type:"entity"}),GameRoot.prototype.initialize=function(){this.transitionEntity.enabled=!0,this.loadingScreen.enabled=!0};var Time=pc.createScript("time");Time.attributes.add("start",{type:"number",default:0}),Time.attributes.add("direction",{type:"string",default:"Forward",enum:[{Forward:"Forward"},{Backward:"Backward"}]}),Time.attributes.add("startEvent",{type:"string"}),Time.attributes.add("endEvent",{type:"string"}),Time.prototype.initialize=function(){this.startEventTriggered=!1,this.endEventTriggered=!1,this.originalText=this.entity.element.text+"",this.time=parseFloat(this.start+""),this.on("state",this.onStateChange,this),this.startEvent&&!this.startEventTriggered&&(this.app.fire(this.startEvent),this.startEventTriggered=!0)},Time.prototype.onStateChange=function(){this.startEventTriggered=!1,this.endEventTriggered=!1,this.time=parseFloat(this.start+"")},Time.prototype.update=function(t){if("Forward"==this.direction?this.time+=t:this.time>=0&&(this.time-=t),this.endEventTriggered)return!1;this.originalText.search(/\$/)>-1?(this.entity.element.text=this.originalText.replace("$time",Utils.mmss(this.time)),this.entity.element.text=this.originalText.replace("$time_number",Math.round(this.time))):this.entity.element.text=Utils.mmss(this.time),"Backward"==this.direction&&this.endEvent&&this.time<=0&&!this.endEventTriggered&&(this.app.fire(this.endEvent),this.endEventTriggered=!0)};var StageManager=pc.createScript("stageManager");StageManager.prototype.initialize=function(){this.app.on("StageManager:Complete",this.onComplete,this)},StageManager.prototype.onComplete=function(e){};var Level=pc.createScript("level");Level.attributes.add("chapterName",{type:"string"}),Level.prototype.postInitialize=function(){this.stages=this.entity.findByTag("Stage"),this.playerEntity=this.app.root.findByName("Player"),this.stages=this.stages.filter((function(t){return t.enabled})),this.spawnPoints=this.entity.findByTag("Spawn"),this.helperSpawnPoints=this.entity.findByTag("HelperSpawn"),this.timerSpawnPoints=this.entity.findByTag("TimerSpawn");for(var t=0;t<this.spawnPoints.length;t++)this.spawnPoints[t].model.enabled=!1;for(t=0;t<this.helperSpawnPoints.length;t++)this.helperSpawnPoints[t].model.enabled=!1;for(t=0;t<this.timerSpawnPoints.length;t++)this.timerSpawnPoints[t].model.enabled=!1;this.currentStage=parseInt(this.entity.name.split("-")[1]),this.currentLevel=0,this.stages[this.currentLevel].fire("Stage:Clear"),this.currentSpawnCount=0,this.totalKill=0,this.app.on("Stage:Complete",this.onStageComplete,this),this.app.on("Stage:Reset",this.onReset,this),this.app.on("Stage:NextLevel",this.onNextLevel,this),this.app.on("Stage:Spawn",this.onPlayerSpawn,this),this.app.on("Stage:SpawnHelpers",this.spawnHelpers,this),this.app.on("Enemy:Death",this.onEnemyKill,this),this.app.fire("Overlay:Stage",this.currentLevel,this.stages[this.currentLevel],this.stages),this.chapterName&&this.app.fire("Overlay:Chapter",pc.BalanceSession.mapName),this.on("destroy",this.onDestroy,this),Utils.setStartEvent(this.entity.name)},Level.prototype.onDestroy=function(){this.app.off("Stage:Complete",this.onStageComplete,this),this.app.off("Stage:Reset",this.onReset,this),this.app.off("Stage:NextLevel",this.onNextLevel,this),this.app.off("Stage:Spawn",this.onPlayerSpawn,this),this.app.off("Stage:SpawnHelpers",this.spawnHelpers,this),this.app.off("Enemy:Death",this.onEnemyKill,this)},Level.prototype.onEnemyKill=function(t){this.totalKill++,this.stages[this.currentLevel].fire("Stage:Kill",t)},Level.prototype.spawnHelpers=function(){var t=this.stages[this.currentLevel].findByTag("HelperSpawn"),e=Utils.shuffle(t).slice(2);this.app.fire("EnemySpawn:SpawnByPoints",e)},Level.prototype.onReset=function(){if(!this.stages[this.currentLevel])return!1;var t=this.stages[this.currentLevel-1];if(t){var e=t.findByName("PlayerSpawn");e&&this.playerEntity.setPosition(e.getPosition().clone())}this.app.fire("Player:Respawn"),this.app.fire("Player:Immunity"),this.stages[this.currentLevel].fire("Reset"),this.app.fire("EnemySpawn:Clear",this.stages[this.currentLevel]),this.app.fire("EnemySpawn:Spawn",this.stages[this.currentLevel])},Level.prototype.onNextLevel=function(){var t=this;this.app.fire("Player:Stop"),this.app.fire("Overlay:Transition",(function(){t.app.fire("MapManager:LoadNextLevel")})),Utils.setCompleteEvent(this.entity.name)},Level.prototype.onPlayerSpawn=function(t){if(!this.stages[this.currentLevel])return!1;var e=this.stages[this.currentLevel],i=e.findByName("PlayerSpawn");i&&t.setPosition(i.getPosition().clone()),e.fire("Reset")},Level.prototype.onStageComplete=function(){this.stages[this.currentLevel].fire("Deactivate"),this.currentLevel++,this.app.fire("EnemySpawn:Spawn",this.stages[this.currentLevel]),this.app.fire("Overlay:Stage",this.currentLevel,this.stages[this.currentLevel],this.stages),this.stages[this.currentLevel].fire("Activate"),this.currentSpawnCount=this.stages[this.currentLevel].findByTag("Spawn").length,this.totalKill=0,this.currentSpawnCount,Utils.setCompleteEvent(this.entity.name+"-"+this.currentLevel)};var CopyTextParent=pc.createScript("copyTextParent");CopyTextParent.prototype.initialize=function(){},CopyTextParent.prototype.update=function(){this.entity.parent.element.text!=this.entity.element.text&&(this.entity.element.text=this.entity.parent.element.text)};var Sphere=pc.createScript("sphere");Sphere.attributes.add("offset",{type:"vec3",default:[0,0,0]}),Sphere.attributes.add("radius",{type:"number",default:1}),Sphere.prototype.initialize=function(){this.originalPosition=this.entity.getPosition().clone(),this.collision=new pc.BoundingSphere(this.entity.getPosition().clone(),.5*this.radius),this.entity.parent.on("Reset",this.onReset,this),this.app.fire("Sphere:Created",this.entity)},Sphere.prototype.onReset=function(){this.entity.setPosition(this.originalPosition.clone())},Sphere.prototype.update=function(){this.collision.center=this.entity.getPosition().clone().add(this.offset)};var BoundingRay=pc.createScript("boundingRay");BoundingRay.attributes.add("fromEntity",{type:"entity"}),BoundingRay.attributes.add("toEntity",{type:"entity"}),BoundingRay.attributes.add("rayEntity",{type:"entity"}),BoundingRay.attributes.add("maxDistance",{type:"number",default:2}),BoundingRay.attributes.add("damage",{type:"number",default:1}),BoundingRay.prototype.postInitialize=function(){this.spheres=this.app.root.findByTag("Bounding"),this.ray=new pc.Ray,this.hitPoint=new pc.Vec3,this.lastDamageTime=Date.now(),this.app.on("Sphere:Created",this.onSphereCreated,this)},BoundingRay.prototype.onSphereCreated=function(t){this.spheres=this.app.root.findByTag("Bounding")},BoundingRay.prototype.update=function(t){if(!Utils.isGameActive)return!1;if(Date.now()-this.lastDamageTime<100)return!1;var i=!1;this.ray.set(this.fromEntity.getPosition(),this.fromEntity.forward),this.rayEntity.setLocalScale(this.maxDistance,1,1);for(var e=this.spheres.length;e--;){var a=this.spheres[e];if(a&&a.enabled&&a.script&&a.script.sphere){var n=a.script.sphere.collision.intersectsRay(this.ray,this.hitPoint);if(a&&n&&!i){var s=this.hitPoint.clone().sub(this.entity.getPosition()).length();this.rayEntity.setLocalScale(s,1,1),this.toEntity.setPosition(this.hitPoint);var o=this.damage;"Player"!=a.name&&(o=.25*this.damage),a.fire("Hit",o),i=!0}}}this.entity.sound&&(this.entity.sound.slots.Laser.pitch=i?1:.5),this.toEntity.enabled=i,this.lastDamageTime=Date.now()};var Cannon=pc.createScript("cannon");Cannon.attributes.add("time",{type:"number",default:3}),Cannon.attributes.add("shootType",{type:"string",enum:[{Cannon:"Cannon"},{FreezeCannon:"FreezeCannon"},{BounceCannon:"BounceCannon"}],default:"Cannon"}),Cannon.attributes.add("fromEntity",{type:"entity"}),Cannon.attributes.add("toEntity",{type:"entity"}),Cannon.attributes.add("barrelEntity",{type:"entity"}),Cannon.attributes.add("lineEntity",{type:"entity"}),Cannon.attributes.add("parentEntity",{type:"entity"}),Cannon.prototype.initialize=function(){this.isActive=!1,this.isGameActive=!1,this.currentTime=this.time+Math.random(),this.lastShoot=Date.now(),this.parentEntity?(this.parentEntity.on("Activate",this.onActivate,this),this.parentEntity.on("Deactivate",this.onDeactivate,this)):(this.entity.parent.parent.on("Activate",this.onActivate,this),this.entity.parent.parent.on("Deactivate",this.onDeactivate,this)),this.on("destroy",this.onDestroy,this)},Cannon.prototype.onDestroy=function(t){this.isActive=!1},Cannon.prototype.onActivate=function(t){this.isActive=!0},Cannon.prototype.onDeactivate=function(t){this.isActive=!1},Cannon.prototype.doShoot=function(t){this.app.fire("ShootManager:Shoot","Everyone",this.shootType,this.fromEntity.getPosition(),this.toEntity.getPosition()),this.app.fire("EffectManager:CannonTraceEffect",this.fromEntity.getPosition(),this.toEntity.getPosition())},Cannon.prototype.shoot=function(t){if(!this.isActive)return!1;this.barrelEntity.fire("Motion","Shoot"),setTimeout((function(t){t.doShoot()}),100,this),this.entity.sound.play("Cannon")},Cannon.prototype.readyToShoot=function(t){if(!this.isActive)return!1;this.lineEntity.fire("Timeline"),Timer.setTimeout((function(t){t.shoot()}),200,this)},Cannon.prototype.update=function(t){return!!Utils.isGameActive&&(!!this.isActive&&void(Date.now()-this.lastShoot>1e3*this.currentTime&&(this.readyToShoot(),this.lastShoot=Date.now())))};var Golem=pc.createScript("golem");Golem.attributes.add("characterEntity",{type:"entity"}),Golem.attributes.add("canSpawnHelpers",{type:"boolean",default:!1}),Golem.prototype.initialize=function(){this.isActive=!1,this.createdAt=Date.now(),this.spinTime=3e3+1e3*Math.random(),this.lastSpin=Date.now(),this.lastHelperSpawn=Date.now(),this.entity.on("Target:Have",this.haveTarget,this)},Golem.prototype.haveTarget=function(){this.isActive=!0},Golem.prototype.spinAttack=function(){this.characterEntity.anim.setTrigger("Spin"),this.entity.fire("Locked",!0),setTimeout((function(t){t.entity.fire("Locked",!1)}),1e3,this)},Golem.prototype.spawnHelpers=function(){this.characterEntity.anim.setTrigger("Spell"),this.entity.fire("Locked",!0),setTimeout((function(t){t.entity.fire("Locked",!1)}),1e3,this)},Golem.prototype.update=function(t){return!!this.isActive&&(!!Utils.isGameActive&&(!(Date.now()-this.createdAt<this.spinTime)&&(Date.now()-this.lastSpin>this.spinTime&&(this.spinAttack(),this.lastSpin=Date.now()),void(this.canSpawnHelpers&&Date.now()-this.lastHelperSpawn>1e4&&(this.spawnHelpers(),this.lastSpin=Date.now(),this.lastHelperSpawn=Date.now())))))};var Timer={nextTimerId:0,timers:[],init:function(){pc.app.on("update",this.onUpdate,this)},setTimeout:function(i,t,e,s,r){var m={id:this.nextTimerId++,callback:i,timeLeft:t/1e3,args:[e,s,r]};return this.timers.push(m),m.id},clearTimeout:function(i){for(var t=0;t<this.timers.length;t++)if(this.timers[t].id===i){this.timers.splice(t,1);break}},onUpdate:function(i){for(var t=this.timers.length-1;t>=0;t--)this.timers[t].timeLeft-=i,this.timers[t].timeLeft<=0&&(this.timers[t].callback.apply(null,this.timers[t].args),this.timers.splice(t,1))}};Timer.init();var PlayerDebug=pc.createScript("playerDebug");PlayerDebug.prototype.initialize=function(){this.mapHolder=this.app.root.findByName("MapHolder")},PlayerDebug.prototype.update=function(i){this.app.keyboard.wasPressed(pc.KEY_1)&&(position=this.mapHolder.findByName("Stage-1").findByName("PlayerSpawn").getPosition(),this.entity.setPosition(position)),this.app.keyboard.wasPressed(pc.KEY_2)&&(position=this.mapHolder.findByName("Stage-2").findByName("PlayerSpawn").getPosition(),this.entity.setPosition(position)),this.app.keyboard.wasPressed(pc.KEY_3)&&(position=this.mapHolder.findByName("Stage-3").findByName("PlayerSpawn").getPosition(),this.entity.setPosition(position)),this.app.keyboard.wasPressed(pc.KEY_4)&&(position=this.mapHolder.findByName("Stage-4").findByName("PlayerSpawn").getPosition(),this.entity.setPosition(position)),this.app.keyboard.wasPressed(pc.KEY_5)&&(position=this.mapHolder.findByName("Stage-5").findByName("PlayerSpawn").getPosition(),this.entity.setPosition(position)),this.app.keyboard.wasPressed(pc.KEY_6)&&(position=this.mapHolder.findByName("Stage-6").findByName("PlayerSpawn").getPosition(),this.entity.setPosition(position)),this.app.keyboard.wasPressed(pc.KEY_7)&&(position=this.mapHolder.findByName("Stage-7").findByName("PlayerSpawn").getPosition(),this.entity.setPosition(position))};var MusicManager=pc.createScript("musicManager");MusicManager.prototype.initialize=function(){this.mapName="Forest",this.musicIndex=1,this.isBattling=!1,this.isActive=!0,this.loopDuration=25.65,this.lastSwitch=Date.now()},MusicManager.prototype.onBossDeath=function(){this.isBattling=!1,this.isActive=!1,this.entity.sound.stop(this.currentMusicName),this.entity.sound.play("Battle-End")},MusicManager.prototype.onBossEnter=function(){this.entity.sound.stop(this.currentMusicName),this.currentMusicName=this.mapName+"-Combat",this.entity.sound.play(this.currentMusicName),this.isBattling=!0,this.lastSwitch=Date.now()},MusicManager.prototype.onLeave=function(){},MusicManager.prototype.update=function(t){};var Boss=pc.createScript("boss");Boss.prototype.initialize=function(){if(this.entity.tags.list().indexOf("NoBoss")>-1)return!1;this.app.fire("Boss:Enter",this.entity),this.entity.on("Death",this.onDeath,this),this.on("destroy",this.onDestroy,this)},Boss.prototype.onDeath=function(){this.app.fire("Boss:Death",this.entity)},Boss.prototype.onDestroy=function(){this.app.fire("Boss:Leave",this.entity)};var Box=pc.createScript("box");Box.attributes.add("offset",{type:"vec3",default:[0,0,0]}),Box.prototype.initialize=function(){this.collision=new pc.BoundingBox(this.entity.getPosition().clone(),this.entity.collision.halfExtents),this.app.fire("Box:Created",this.entity),this.on("destroy",this.onDestroy,this)},Box.prototype.onDestroy=function(){this.app.fire("Box:Created",this.entity)},Box.prototype.update=function(){this.collision.center=this.entity.getPosition()};var Footstep=pc.createScript("footstep");Footstep.attributes.add("fromEntity",{type:"entity"}),Footstep.prototype.initialize=function(){this.ray=new pc.Ray,this.boxes=this.app.root.findByTag("Box"),this.hitPoint=new pc.Vec3,this.app.on("Box:Created",this.onBoxCreated,this)},Footstep.prototype.onBoxCreated=function(t){this.boxes=this.app.root.findByTag("Box")},Footstep.prototype.update=function(t){this.ray.set(this.fromEntity.getPosition(),this.fromEntity.up.scale(-1));for(var o=this.boxes.length,i="Grass";o--;){var e=this.boxes[o];if(e&&e.enabled&&e.script&&e.script.box){var s=e.script.box.collision.intersectsRay(this.ray,this.hitPoint);e&&s&&(i=e.name)}}this.entity.fire("Footstep",i)};var Boulder=pc.createScript("boulder");Boulder.attributes.add("modelEntity",{type:"entity"}),Boulder.prototype.initialize=function(){this.pushingVolume=0,this.entity.on("Torque",this.onTorqueForce,this)},Boulder.prototype.onTorqueForce=function(t,e,o){this.modelEntity.rotate(t,e,o),this.pushingVolume=1},Boulder.prototype.update=function(t){this.pushingVolume=pc.math.lerp(this.pushingVolume,0,.1),this.entity.sound.volume=this.pushingVolume};var MapManager=pc.createScript("mapManager");MapManager.attributes.add("playerEntity",{type:"entity"}),MapManager.attributes.add("level",{type:"number",default:1}),MapManager.attributes.add("maxStage",{type:"number",default:10}),MapManager.attributes.add("upgradeDebug",{type:"boolean",default:!1}),MapManager.attributes.add("levelEntity",{type:"entity"}),MapManager.attributes.add("stageDisplay",{type:"entity"}),MapManager.attributes.add("selectionPopup",{type:"entity"}),MapManager.attributes.add("mapNameEntity",{type:"entity"}),MapManager.attributes.add("mapItem",{type:"entity"}),MapManager.attributes.add("mapItemHolder",{type:"entity"}),MapManager.attributes.add("chapters",{type:"json",schema:[{name:"name",type:"string"},{name:"description",type:"string"}],array:!0}),MapManager.prototype.initialize=function(){this.canUpgrade=!0,this.currentLevel=parseInt(this.level+"");var e=Utils.getItem("UnlockedMaps");this.unlockedMaps=e?JSON.parse(e):["Valley"];var t=Utils.getItem("LastMap");t&&(pc.BalanceSession.mapName=t);var a=Utils.getItem("Level");a&&(this.currentLevel=parseInt(a)),this.mapArray=[],this.levelEntity.element.text=this.currentLevel+"",this.mapItem.enabled=!1,this.app.on("MapManager:Show",this.showMapList,this),this.app.on("MapManager:Hide",this.hideMapList,this),this.app.on("MapManager:Load",this.load,this),this.app.on("MapManager:LoadNextLevel",this.loadNextLevel,this),this.app.on("MapManager:LoadMap",this.loadMap,this),this.app.on("MapManager:LoadNextMap",this.loadNextMap,this),this.app.on("MapManager:RestartLevel",this.restartLevel,this),this.upgradeDebug?this.loadByName("Upgrade-1"):this.load(this.currentLevel)},MapManager.prototype.hideMapList=function(){this.selectionPopup.enabled=!1,Utils.isGameActive=!0},MapManager.prototype.showMapList=function(){this.selectionPopup.enabled=!0;for(var e=this.mapArray.length;e--;)this.mapArray[e].destroy();for(var t in this.mapArray=[],this.chapters){var a=this.chapters[t],i=this.mapItem.clone();if(i.findByName("Name").element.text=a.name,i.findByName("Description").element.text=a.description,pc.BalanceSession.mapName==a.name)i.script.button.action="Menu:Close",i.findByName("Button").enabled=!1,i.findByName("Progress").enabled=!0,i.findByName("Progress").element.text=this.currentLevel+" / 10",i.findByName("Lock").enabled=!1;else{var n=this.isUnlocked(a.name);n?(i.script.button.action="Gameplay:LoadMap",i.script.button.value=a.name):(i.script.button.action="Overlay:Alert",i.script.button.value="You need to finish current chapter first!"),i.findByName("Button").enabled=n,i.findByName("Progress").enabled=n,i.findByName("Lock").enabled=!n}i.findByName("Thumbnail").element.textureAsset=this.app.assets.find(a.name+"-Thumbnail.jpg"),i.enabled=!0,this.mapItemHolder.addChild(i),this.mapArray.push(i)}Utils.isGameActive=!1},MapManager.prototype.isUnlocked=function(e){return this.unlockedMaps.indexOf(e)>-1},MapManager.prototype.clearMapHolder=function(){var e=this.entity.findByName(this.lastSceneName);e&&e.destroy()},MapManager.prototype.load=function(e,t){if(this.isLoading)return!1;var a=pc.BalanceSession.mapName;this.isLoading=!0,this.currentLevel=e,"Valley"==a&&1===this.currentLevel?this.loadByName("Level-1",t):this.loadByName("Level-Procedural",t),this.levelEntity.element.text=this.currentLevel+"",this.mapNameEntity.element.text=pc.BalanceSession.mapName,Utils.setItem("Level",this.currentLevel)},MapManager.prototype.loadByName=function(e,t){var a=this,i=this.app.scenes.find(e);this.clearMapHolder(),this.playerEntity.setPosition(0,.01,0),this.app.scenes.loadSceneHierarchy(i.url,(function(i,n){if(i&&console.log(i),!n)return!1;a.entity&&n.reparent(a.entity),t&&t(),a.resetScene(),a.lastSceneName=e,a.isLoading=!1})),Utils.setItem("LastMap",pc.BalanceSession.mapName)},MapManager.prototype.loadNextMap=function(){var e=0;for(var t in this.chapters){this.chapters[t].name==pc.BalanceSession.mapName&&(e=parseInt(t)+1)}if(this.chapters[e]&&(this.nextMapName=this.chapters[e].name),!this.nextMapName)return this.app.fire("Overlay:Alert","You finished the game, new content will be available soon!"),this.app.fire("Gameplay:LoadMap","Valley"),!1;this.app.fire("Gameplay:LoadMap",this.nextMapName)},MapManager.prototype.loadMap=function(e){if(!this.isUnlocked(e))return this.app.fire("Menu:Close"),console.error("This map is not unlocked yet!"),!1;pc.BalanceSession.mapName=e,this.currentLevel=1,this.canUpgrade=!0,this.load(this.currentLevel),Utils.isGameActive=!0,this.app.fire("Menu:Close"),this.app.fire("Overlay:HideAll"),Utils.setItem("Level",this.currentLevel)},MapManager.prototype.loadNextLevel=function(){var e=this;if(this.currentLevel+1>=this.maxStage)return this.onStageComplete(),!1;this.canUpgrade?(this.stageDisplay.enabled=!1,this.loadByName("Upgrade-1"),this.canUpgrade=!1):(this.stageDisplay.enabled=!0,this.app.fire("Checkpoint:Event","midroll_"+this.currentLevel),PokiPlugin.showMidroll((function(){e.goNextLevel()})))},MapManager.prototype.onStageComplete=function(){var e=0;for(var t in this.chapters){this.chapters[t].name==pc.BalanceSession.mapName&&(e=parseInt(t)+1)}this.chapters[e]&&this.unlockedMaps.push(this.chapters[e].name),Utils.isGameActive=!1,Utils.setItem("UnlockedMaps",JSON.stringify(this.unlockedMaps)),this.app.fire("Overlay:Finish",e,pc.BalanceSession.mapName),PokiPlugin.onPause()},MapManager.prototype.goNextLevel=function(){var e=this.currentLevel+1;this.load(e),this.canUpgrade=!0},MapManager.prototype.restartLevel=function(){var e=this;PokiPlugin.showMidroll((function(){e.load(e.currentLevel)}))},MapManager.prototype.resetScene=function(){this.app.fire("Scene:Triggers"),this.app.fire("Scene:Collision")};var Door=pc.createScript("door");Door.attributes.add("stationEntity",{type:"entity"}),Door.attributes.add("leftDoor",{type:"entity"}),Door.attributes.add("rightDoor",{type:"entity"}),Door.prototype.initialize=function(){this.stationEntity.on("Completed",this.onCompleted,this)},Door.prototype.onCompleted=function(t){this.leftDoor.fire("Timeline"),this.rightDoor.fire("Timeline")};var DamageObject=pc.createScript("damageObject");DamageObject.attributes.add("damage",{type:"number",default:5}),DamageObject.attributes.add("delay",{type:"number",default:300}),DamageObject.attributes.add("radius",{type:"number",default:1}),DamageObject.prototype.postInitialize=function(){this.lastDamage=Date.now(),this.enemies=this.app.root.findByTag("Shootable"),this.app.on("Enemy:Spawn",this.onEnemies,this),this.on("destroy",this.onDestroy,this)},DamageObject.prototype.onEnemies=function(){this.app.off("Enemy:Spawn",this.onEnemies,this)},DamageObject.prototype.onEnemies=function(){this.enemies=this.app.root.findByTag("Shootable")},DamageObject.prototype.checkCollisions=function(e){if(!Utils.isGameActive)return!1;if(Date.now()-this.lastDamage<this.delay)return!1;for(var t=this.entity.getPosition(),i=0;i<this.enemies.length;i++){var a=this.enemies[i].getPosition();if(Utils.distance(a.x,a.z,t.x,t.z)<this.radius&&this.enemies[i].parent&&this.enemies[i].enabled){var s=this.damage;"Player"!=this.enemies[i].name&&(s=.25*this.damage),this.enemies[i].fire("Hit",s,"Everyone",t),this.entity.fire("Activate",this.enemies[i])}}this.lastDamage=Date.now()},DamageObject.prototype.update=function(e){this.checkCollisions(e)};var Trap=pc.createScript("trap");Trap.attributes.add("stickEntity",{type:"entity"}),Trap.prototype.initialize=function(){this.entity.on("Activate",this.onActivate,this)},Trap.prototype.onActivate=function(t){this.stickEntity.fire("Motion","Stick")};var Rotatable=pc.createScript("rotatable");Rotatable.attributes.add("originEntity",{type:"entity"}),Rotatable.attributes.add("lookEntity",{type:"entity"}),Rotatable.attributes.add("radius",{type:"number",default:3}),Rotatable.prototype.initialize=function(){},Rotatable.prototype.update=function(t){var i=this.lookEntity.getPosition(),a=this.entity.getPosition(),o=Utils.lookAt(a.x,a.z,i.x,i.z);this.originEntity.setLocalEulerAngles(0,o*pc.math.RAD_TO_DEG,0);var e=o;this.lookEntity.setPosition(Math.sin(e)*this.radius+a.x,.5,Math.cos(e)*this.radius+a.z)};var UpgradeManager=pc.createScript("upgradeManager");UpgradeManager.attributes.add("upgrades",{type:"json",schema:[{name:"name",type:"string"},{name:"coin",type:"number",default:100},{name:"icon",type:"asset"},{name:"entity",type:"entity"},{name:"tier",type:"number",default:0}],array:!0}),UpgradeManager.attributes.add("upgradesPopup",{type:"entity"}),UpgradeManager.attributes.add("upgradesItem",{type:"entity"}),UpgradeManager.attributes.add("upgradesHolder",{type:"entity"}),UpgradeManager.attributes.add("reRollButton",{type:"entity"}),UpgradeManager.attributes.add("playerEntity",{type:"entity"}),UpgradeManager.attributes.add("activeColor",{type:"rgb"}),UpgradeManager.attributes.add("rewardColor",{type:"rgb"}),UpgradeManager.attributes.add("deactiveColor",{type:"rgb"}),UpgradeManager.attributes.add("upgradesListHolder",{type:"entity"}),UpgradeManager.attributes.add("upgradesListItem",{type:"entity"}),UpgradeManager.attributes.add("maxEntitiesInColumn",{type:"number",default:6}),UpgradeManager.prototype.initialize=function(){this.gameplayElements=this.app.root.findByTag("Gameplay"),this.upgradesArray=[],this.currentUpgrades=[],this.currentTier=Utils.getItemAsNumber("UpgradeTier")||0,this.upgradesListItem.enabled=!1,this.isSelected=!1,this.lastReRollTime=Date.now(),this.app.on("UpgradeManager:Show",this.onShow,this),this.app.on("UpgradeManager:Hide",this.onHide,this),this.app.on("UpgradeManager:ReRoll",this.onReRoll,this),this.app.on("UpgradeManager:Upgrade",this.onUpgrade,this),this.app.on("UpgradeManager:RewardUpgrade",this.onRewardUpgrade,this),this.app.on("UpgradeManager:UpdateList",this.updateUpgradesList,this),this.app.on("UpgradeManager:Reset",this.onReset,this),this.loadUpgrades()},UpgradeManager.prototype.onReRoll=function(){var e=this;PokiPlugin.showReward((function(){e.onShow()}))},UpgradeManager.prototype.onHide=function(){this.clearUpgrades(),this.upgradesPopup.enabled=!1,this.gameplayElements.forEach((function(e){e.enabled=!0})),PokiPlugin.onPlay()},UpgradeManager.prototype.clearUpgrades=function(){this.upgradesArray.forEach((function(e){e.destroy()})),this.upgradesArray=[]},UpgradeManager.prototype.haveUpgrade=function(e){return this.currentUpgrades.find((function(t){return t.name==e}))},UpgradeManager.prototype.onShow=function(e){var t=0;PokiPlugin.onPause();var a=this.upgrades.slice(0);for(var r in tempDisabledUpgrades=[],a){var i=a[r];"Valley"==pc.BalanceSession.mapName?!i.entity.enabled&&this.currentTier>=i.tier&&tempDisabledUpgrades.push(i):i.entity.enabled||tempDisabledUpgrades.push(i)}(a=(a=Utils.shuffle(tempDisabledUpgrades)).slice(0,4))[Math.floor(Math.random()*a.length)].isReward=!0,a.push("Empty"),a.push("Empty"),a=Utils.shuffle(a),this.isSelected=!1,this.upgradesPopup.enabled=!0,this.clearUpgrades(),this.gameplayElements.forEach((function(e){e.enabled=!1}));for(var n=[],s=0;s<a.length;s++){var d=a[s],p=this.upgradesItem.clone(),o=this.haveUpgrade(d.name);p.enabled=!0,p.script.timeline.delay=t,p.icon=d.icon,"Empty"==d||o?(p.isLocked=!0,p.element.color=this.deactiveColor,p.button.enabled=!1,p.findByName("Content").enabled=!1,p.findByName("Lock").enabled=!0):(p.isLocked=!1,p.name=d.entity.name,d.isReward?(p.element.color=this.rewardColor,p.findByName("Ad").enabled=!0,p.script.button.action="UpgradeManager:RewardUpgrade",d.isReward=!1):p.element.color=this.activeColor,p.findByName("Content").enabled=!0,p.findByName("Lock").enabled=!1,p.findByName("Icon").element.textureAsset=d.icon,p.findByName("Title").element.text=d.name,p.script.button.value=d.entity.name,p.connectedEntity=d.entity,n.push(d.entity.name)),this.upgradesHolder.addChild(p),this.upgradesArray.push(p),setTimeout((function(e){e.app.fire("Overlay:Sound","UnlockCard")}),1e3*t,this),t+=.2}var g=Utils.shuffle(n);g=g[0],this.autoUpgradeSelector=setTimeout((function(e){g&&e.onUpgrade(g)}),7e3,this),this.playerEntity.script.movement.isLocked=!0,this.app.fire("Overlay:Sound","ShowUpgrades")},UpgradeManager.prototype.clearUpgradesList=function(){for(var e in this.upgradesList)this.upgradesList[e].destroy();this.upgradesList=[]},UpgradeManager.prototype.updateUpgradesList=function(){for(var e in this.clearUpgradesList(),this.currentUpgrades){var t=this.currentUpgrades[e],a=this.upgradesListItem.clone();a.enabled=!0,a.findByName("Icon").element.textureAsset=t.icon,this.upgradesListHolder.addChild(a),this.upgradesList.push(a)}},UpgradeManager.prototype.getUpgrade=function(e){return this.upgradesArray.find((function(t){return e==t.name}))},UpgradeManager.prototype.getUpgradeFromList=function(e){return this.upgrades.find((function(t){return e==t.entity.name}))},UpgradeManager.prototype.loadUpgrades=function(){var e=Utils.getItem("Upgrades");if(!e)return!1;for(var t in e=JSON.parse(e)){var a=e[t],r=this.getUpgradeFromList(a);r&&r.entity&&(r.entity.enabled=!0,r.upgradeName=a,this.currentUpgrades.push(r))}this.updateUpgradesList()},UpgradeManager.prototype.saveUpgrades=function(){var e=this.currentUpgrades.map((function(e){return e.upgradeName}));Utils.setItem("Upgrades",JSON.stringify(e))},UpgradeManager.prototype.onUpgrade=function(e){if(this.isSelected)return!1;var t=this.getUpgrade(e);return!!t&&(!t.isLocked&&(this.upgradesArray.forEach((function(e){e.element.opacity=.1,e.findByName("Icon").element.opacity=.5,e.setLocalScale(.9,.9,.9)})),t&&(t.upgradeName=e,t.setLocalScale(1.15,1.15,1.15),t.element.opacity=1,t.findByName("Highlight").enabled=!0,t.connectedEntity.enabled=!0,t.connectedEntity.tags.list().indexOf("QuickUpgrade")>-1||this.currentUpgrades.push(t)),clearTimeout(this.autoUpgradeSelector),this.saveUpgrades(),setTimeout((function(e){e.app.fire("UpgradeManager:Hide")}),1500,this),this.app.fire("Overlay:Sound","SelectCard"),this.app.fire("Overlay:Sound","Buy"),this.isSelected=!0,this.playerEntity.script.movement.isLocked=!1,this.currentTier++,Utils.setItem("UpgradeTier",this.currentTier),void this.updateUpgradesList()))},UpgradeManager.prototype.onRewardUpgrade=function(e){var t=this;clearTimeout(this.autoUpgradeSelector),PokiPlugin.showReward((function(){t.onUpgrade(e)}),{disableEvents:!0})},UpgradeManager.prototype.onReset=function(){this.currentUpgrades=[],this.currentTier=0,Utils.setItem("UpgradeTier",this.currentTier),Utils.setItem("Upgrades",""),this.upgrades.forEach((function(e){e.entity.enabled=!1})),this.updateUpgradesList()};var UpgradeTripleArrows=pc.createScript("upgradeTripleArrows");UpgradeTripleArrows.attributes.add("curveDirection",{type:"number",default:20}),UpgradeTripleArrows.prototype.initialize=function(){this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradeTripleArrows.prototype.onStateChange=function(t){!0===t?this.app.on("Player:Shoot",this.onShoot,this):this.app.off("Player:Shoot",this.onShoot,this)},UpgradeTripleArrows.prototype.onDestroy=function(){this.onStateChange(!1)},UpgradeTripleArrows.prototype.onShoot=function(t,r){for(var o=-this.curveDirection;o<=2*this.curveDirection;o+=2*this.curveDirection)this.app.fire("ShootManager:Shoot","Player","Arrow",t,r,o)};var UpgradeHeal=pc.createScript("upgradeHeal");UpgradeHeal.attributes.add("playerEntity",{type:"entity"}),UpgradeHeal.attributes.add("type",{type:"number",enum:[{"Set Health":1},{"Add Health":2}]}),UpgradeHeal.attributes.add("valueType",{type:"number",enum:[{Numeric:1},{Percentage:2}]}),UpgradeHeal.attributes.add("value",{type:"number",description:"How much health add numeric/percentage%",default:50}),UpgradeHeal.prototype.initialize=function(){this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradeHeal.prototype.onStateChange=function(e){!0===e&&this.onHeal()},UpgradeHeal.prototype.onDestroy=function(){this.onStateChange(!1)},UpgradeHeal.prototype.onHeal=function(){var e=parseInt(this.playerEntity.script.label.health+""),t=parseInt(this.playerEntity.script.label.maxHealth+""),a=0;1==this.valueType?a=this.value:2==this.valueType&&(a=t/100*this.value),2==this.type&&(a+=e),a>t&&(a-=a-t),console.log(a),this.playerEntity.fire("Health",a),this.entity.enabled=!1};var UpgradeLuckyShot=pc.createScript("upgradeLuckyShot");UpgradeLuckyShot.attributes.add("multiplyoins",{type:"number",description:"enemyMoney*number",default:3}),UpgradeLuckyShot.attributes.add("chance",{type:"number",description:"Percentage %",default:5}),UpgradeLuckyShot.attributes.add("timeOut",{type:"number",description:"Seconds",default:10}),UpgradeLuckyShot.attributes.add("playerEntity",{type:"entity",description:"Player Entity"}),UpgradeLuckyShot.prototype.initialize=function(){this.lastUsedTime=-1/0,this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradeLuckyShot.prototype.onStateChange=function(t){!0===t?this.app.on("ShootingManager:Hit",this.onHit,this):this.app.off("ShootingManager:Hit",this.onHit,this)},UpgradeLuckyShot.prototype.onDestroy=function(){this.onStateChange(!1)},UpgradeLuckyShot.prototype.onHit=function(t,e,i,n,a){if(t.tags.list().indexOf("Boss")>-1)return!1;if("Player"!=a.ownerType)return!1;if(Date.now()-this.lastUsedTime>1e3*this.timeOut&&100*Math.random()<=this.chance){var o=t.script.enemy;o.howMany*=this.multiplyCoins,t.fire("Hit",o.health,i,n),this.lastUsedTime=Date.now()}};var UpgradeRepelArrow=pc.createScript("upgradeRepelArrow");UpgradeRepelArrow.attributes.add("type",{type:"number",enum:[{Set:1},{Add:2},{Multiply:3}]}),UpgradeRepelArrow.attributes.add("value",{type:"number",default:3}),UpgradeRepelArrow.attributes.add("chance",{type:"number",description:"Percentage %",default:5}),UpgradeRepelArrow.attributes.add("timeOut",{type:"number",description:"Seconds",default:10}),UpgradeRepelArrow.prototype.initialize=function(){this.lastUsedTime=-1/0,this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradeRepelArrow.prototype.onStateChange=function(e){!0===e?this.app.on("ShootingManager:Hit",this.onHit,this):this.app.off("ShootingManager:Hit",this.onHit,this)},UpgradeRepelArrow.prototype.onDestroy=function(){this.onStateChange(!1)},UpgradeRepelArrow.prototype.onHit=function(e,t,r,i,a){if(e.tags.list().indexOf("Boss")>-1)return!1;if("Player"!=a.ownerType)return!1;Date.now()-this.lastUsedTime>1e3*this.timeOut&&(100*Math.random()<=this.chance&&(this.scriptEnemy=e.script.enemy,this.originalRepelFactor=parseInt(this.scriptEnemy.repelFactor+""),0==this.type?this.scriptEnemy.repelFactor=this.value:1==this.type?this.scriptEnemy.repelFactor+=this.value:2==this.type&&(this.scriptEnemy.repelFactor*=this.value),e.fire("Hit",0,r,i),Timer.setTimeout((function(e){e.scriptEnemy.repelFactor=e.originalRepelFactor}),100,this),this.lastUsedTime=Date.now()))};var UpgradeArrowBoost=pc.createScript("upgradeArrowBoost");UpgradeArrowBoost.attributes.add("arrowEntity",{type:"entity"}),UpgradeArrowBoost.attributes.add("type",{type:"number",enum:[{Set:1},{Add:2},{Multiply:3}]}),UpgradeArrowBoost.attributes.add("value",{type:"number",default:1.5}),UpgradeArrowBoost.prototype.initialize=function(){this.commonValue=parseInt(this.arrowEntity.script.bullet.damage+""),this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradeArrowBoost.prototype.onStateChange=function(t){!0===t?1==this.type?this.arrowEntity.script.bullet.damage=this.value:2==this.type?this.arrowEntity.script.bullet.damage+=this.value:3==this.type&&(this.arrowEntity.script.bullet.damage*=this.value):this.arrowEntity.script.bullet.damage=this.commonValue},UpgradeArrowBoost.prototype.onDestroy=function(){this.onStateChange(!1)};var Explosion=pc.createScript("explosion");Explosion.attributes.add("radius",{type:"number",default:2}),Explosion.attributes.add("damage",{type:"number",default:50}),Explosion.prototype.initialize=function(){this.createdAt=Date.now()},Explosion.prototype.update=function(t){Date.now()-this.createdAt>2e3&&this.entity.destroy()};var SpawnTimer=pc.createScript("spawnTimer");SpawnTimer.attributes.add("time",{type:"number",default:1}),SpawnTimer.prototype.initialize=function(){this.createdAt=Date.now(),this.isActive=!1,this.entity.parent.parent.on("Activate",this.onActivate,this)},SpawnTimer.prototype.onActivate=function(){this.createdAt=Date.now(),this.isActive=!0},SpawnTimer.prototype.spawn=function(){this.isActive=!1,this.app.fire("EnemySpawn:SpawnByPoint",this.entity)},SpawnTimer.prototype.update=function(t){this.isActive&&Date.now()-this.createdAt>1e3*this.time&&this.spawn()};var LookAt=pc.createScript("lookAt");LookAt.prototype.initialize=function(){this.cameraEntity=this.app.root.findByName("Camera")},LookAt.prototype.update=function(t){this.entity.lookAt(this.cameraEntity.getPosition())};var UpgradeFreezeArrow=pc.createScript("upgradeFreezeArrow");UpgradeFreezeArrow.prototype.initialize=function(){this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradeFreezeArrow.prototype.onStateChange=function(e){!0===e?this.app.on("ShootingManager:Hit",this.onHit,this):this.app.off("ShootingManager:Hit",this.onHit,this)},UpgradeFreezeArrow.prototype.onDestroy=function(){this.onStateChange(!1)},UpgradeFreezeArrow.prototype.onHit=function(e,t,r,o,i){if("Player"!=i.ownerType)return!1;e.fire("Hit",0,"IceArrow",o)};var UpgradeFireCircle=pc.createScript("upgradeFireCircle");UpgradeFireCircle.attributes.add("playerEntity",{type:"entity"}),UpgradeFireCircle.attributes.add("shootingManager",{type:"entity"}),UpgradeFireCircle.attributes.add("fireEntities",{type:"entity",array:!0}),UpgradeFireCircle.attributes.add("originEntity",{type:"entity"}),UpgradeFireCircle.attributes.add("rotateSpeed",{type:"number",default:50}),UpgradeFireCircle.attributes.add("damage",{type:"number",default:1}),UpgradeFireCircle.attributes.add("fireRadius",{type:"number",default:1}),UpgradeFireCircle.attributes.add("weaponType",{type:"string",default:"Fire"}),UpgradeFireCircle.attributes.add("timeOutForEnemy",{type:"number",default:2}),UpgradeFireCircle.prototype.initialize=function(){},UpgradeFireCircle.prototype.checkCollisions=function(){for(var e=this.shootingManager.script.shootingManager.enemies,t=0;t<this.fireEntities.length;t++)for(var i=0;i<e.length;i++)if(e[i]){var r=e[i].getPosition().clone(),a=this.fireEntities[t].getPosition().clone(),n=Utils.distance(r.x,r.z,a.x,a.z);if("Player"!=e[i].name&&e[i].parent&&e[i].enabled&&e[i].script.enemy&&!e[i].script.enemy.isDeath&&n<this.fireRadius){if(e[i].fireBallTimeOut){if(Date.now()-e[i].fireBallTimeOut<1e3*this.timeOutForEnemy)return!1;e[i].fireBallTimeOut=Date.now()}else e[i].fireBallTimeOut=Date.now();e[i].fire("Hit",this.damage,this.weaponType,a),this.entity.sound.play("Hit")}}},UpgradeFireCircle.prototype.update=function(e){if(!Utils.isGameActive)return!1;var t=this.playerEntity.getPosition();this.entity.setPosition(t),this.originEntity.rotateLocal(0,e*this.rotateSpeed,0),this.checkCollisions()};var Bounce=pc.createScript("bounce");Bounce.attributes.add("radius",{type:"number"}),Bounce.prototype.initialize=function(){this.bounceEntities=this.app.root.findByTag("Bounce")},Bounce.prototype.update=function(t){for(var i in this.bounceEntities){var e=this.bounceEntities[i].getPosition(),n=this.entity.getPosition();Utils.distance(n.x,n.z,e.x,e.z)<this.radius&&this.entity.rotate(0,0,180)}};var UpgradeShieldCircle=pc.createScript("upgradeShieldCircle");UpgradeShieldCircle.attributes.add("playerEntity",{type:"entity"}),UpgradeShieldCircle.attributes.add("shootingManager",{type:"entity"}),UpgradeShieldCircle.attributes.add("shieldEntities",{type:"entity",array:!0}),UpgradeShieldCircle.attributes.add("rotateSpeed",{type:"number",default:50}),UpgradeShieldCircle.attributes.add("shieldRadius",{type:"number",default:.25}),UpgradeShieldCircle.prototype.initialize=function(){},UpgradeShieldCircle.prototype.checkCollisions=function(){this.bullets=this.shootingManager.script.shootingManager.bullets;for(var t=this.bullets.length;t--;)for(var e=this.shieldEntities.length;e--;)if(this.bullets[t]){var i=this.bullets[t].getPosition(),s=this.shieldEntities[e].getPosition(),l=(this.bullets[t].radius,Utils.distance(i.x,i.z,s.x,s.z));"Player"!=this.bullets[t].ownerType&&l<this.shieldRadius&&this.onCollision(this.bullets[t])}},UpgradeShieldCircle.prototype.onCollision=function(t){var e=t.getPosition();this.app.fire("EffectManager:HitEffect",e),this.entity.sound.play("Hit"),t.destroy()},UpgradeShieldCircle.prototype.update=function(t){var e=this.playerEntity.getPosition();this.entity.setPosition(e),this.entity.rotateLocal(0,t*this.rotateSpeed,0),this.checkCollisions()};var UpgradeBouncingArrow=pc.createScript("upgradeBouncingArrow");UpgradeBouncingArrow.attributes.add("range",{type:"number"}),UpgradeBouncingArrow.attributes.add("damageReduction",{type:"number",description:"% percent",default:25}),UpgradeBouncingArrow.attributes.add("maxBounces",{type:"number"}),UpgradeBouncingArrow.attributes.add("shootingManagerEntity",{type:"entity"}),UpgradeBouncingArrow.prototype.initialize=function(){this.shootingManagerScript=this.shootingManagerEntity.script.shootingManager,this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradeBouncingArrow.prototype.onStateChange=function(t){!0===t?this.app.on("ShootingManager:Hit",this.onHit,this):this.app.off("ShootingManager:Hit",this.onHit,this)},UpgradeBouncingArrow.prototype.onHit=function(t,e,n,i,o){if("Player"!=o.ownerType)return!1;for(var r=this.shootingManagerScript.enemies,a=r.length,g=!1,s=1/0;a--;){var p=r[a];if(t!=p&&"Player"!=p.name&&!p.script.enemy.isDeath){var u=t.getPosition(),h=p.getPosition(),c=Utils.distance(u.x,u.z,h.x,h.z);c<this.range&&c<s&&(s=c,g=p)}}if(g){if(o.bounceNumber&&o.bounceNumber==this.maxBounces)return!1;u=t.getPosition();var d=g.getPosition(),y={bounceNumber:(o.bounceNumber||1)+1,blockedEntity:t,damage:o.damage/100*(100-this.damageReduction)};this.app.fire("ShootManager:Shoot","Player","Arrow",u,d,0,y)}},UpgradeBouncingArrow.prototype.update=function(t){};var UpgradeExtraShot=pc.createScript("upgradeExtraShot");UpgradeExtraShot.attributes.add("chance",{type:"number",description:"precent",default:20}),UpgradeExtraShot.attributes.add("rangeFromTargetEnemy",{type:"number",default:4}),UpgradeExtraShot.attributes.add("timeOut",{type:"number",description:"(seconds) when next time extra shot possible",default:5}),UpgradeExtraShot.attributes.add("playerEntity",{type:"entity"}),UpgradeExtraShot.attributes.add("shootingManagerEntity",{type:"entity"}),UpgradeExtraShot.prototype.initialize=function(){this.shootingManagerScript=this.shootingManagerEntity.script.shootingManager,this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradeExtraShot.prototype.onStateChange=function(t){!0===t?(this.lastShoot=Date.now()-1e3*this.timeOut,this.app.on("Player:Shoot",this.onShoot,this)):this.app.off("Player:Shoot",this.onShoot,this)},UpgradeExtraShot.prototype.onShoot=function(t,e){if(Date.now()-this.lastShoot<1e3*this.timeOut)return!1;if(100*Math.random()>this.chance)return!1;for(var a=this.shootingManagerScript.enemies,o=a.length,r=!1,i=1/0;o--;){var n=a[o];if("Player"!=n.name&&!n.script.enemy.isDeath){var h=n.getPosition(),s=Utils.distance(e.x,e.z,h.x,h.z);s<this.rangeFromTargetEnemy&&s>.25&&s<i&&(i=s,r=h)}}r&&(this.app.fire("ShootManager:Shoot","Player","Arrow",t,r),this.lastShoot=Date.now())};var Condition=pc.createScript("condition");Condition.attributes.add("kills",{type:"json",schema:[{name:"enemy",type:"string"},{name:"kill",type:"number",default:1}],array:!0}),Condition.attributes.add("autoplay",{type:"boolean",default:!0}),Condition.attributes.add("boss",{type:"boolean",default:!1}),Condition.prototype.postInitialize=function(){this.isCompleted=!1,this.killCounts={},this.entity.on("Stage:Kill",this.onKill,this),this.autoplay&&this.onComplete()},Condition.prototype.onKill=function(e){this.killCounts[e]||(this.killCounts[e]=0),this.killCounts[e]++;var i=0;for(var t in this.kills){var n=this.kills[t];this.killCounts[n.enemy]>=n.kill&&i++}i==this.kills.length&&this.onComplete()},Condition.prototype.onComplete=function(){if(this.isCompleted)return!1;var e=this,i=this.entity.findByName("UpgradeItemPoint").getPosition().clone();pc.BalanceSession.hasDragonEgg?(this.app.fire("PetManager:SpawnEgg",i),pc.BalanceSession.dragonEggCallback=function(){e.entity.fire("Stage:Clear")},pc.BalanceSession.hasDragonEgg=!1):pc.BalanceSession.hasUpgrade?(this.app.fire("ExperienceManager:SpawnUpgradeItem",i),pc.BalanceSession.upgradeCallback=function(){e.entity.fire("Stage:Clear")},pc.BalanceSession.hasUpgrade=!1):pc.BalanceSession.hasRune?(this.app.fire("RuneManager:SpawnRune",i),pc.BalanceSession.runeCallback=function(){e.entity.fire("Stage:Clear")},pc.BalanceSession.hasRune=!1):this.entity.fire("Stage:Clear"),this.boss&&(this.app.fire("EffectManager:SlowTime"),this.app.fire("Overlay:Announce","Victory!"),this.app.fire("Overlay:Sound","BossKill")),this.isCompleted=!0};var UpgradeExplosiveArrow=pc.createScript("upgradeExplosiveArrow");UpgradeExplosiveArrow.prototype.initialize=function(){this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradeExplosiveArrow.prototype.onStateChange=function(t){!0===t?this.app.on("ShootingManager:Hit",this.onHit,this):this.app.off("ShootingManager:Hit",this.onHit,this)},UpgradeExplosiveArrow.prototype.onDestroy=function(){this.onStateChange(!1)},UpgradeExplosiveArrow.prototype.onHit=function(t,o,e,i,r){if("Player"!=r.ownerType)return!1;this.app.fire("ShootManager:Explode","Player","ExplosiveArrow",i)};pc.script.createLoadingScreen((function(e){var t,a;t=["body {","    background-color: #09080e;","}","","#application-splash-wrapper {","    position: absolute;","    top: 0;","    left: 0;","    height: 100%;","    width: 100%;",'    background: #09080e url("https://assets.venge.io/Portrait-v4.jpg") no-repeat center center;',"    background-size: contain;","}","","#application-splash {","    position: absolute;","    left: 50%;","    transform: translate(-50%, 0%);","    bottom: 20px;","    width: calc(100% - 20px);","}","","#application-splash img {","    width: 100%;","}","","#progress-bar-container {","    margin: 20px auto 0 auto;","    height: 20px;","    border: solid 4px #000;","    border-radius: 4px;","    width: calc(100% - 8px);","    background-color: #1d292c;","}","","#progress-bar {","    width: 0%;","    height: 100%;","    background-color: #fff;","}"].join("\n"),(a=document.createElement("style")).type="text/css",a.styleSheet?a.styleSheet.cssText=t:a.appendChild(document.createTextNode(t)),document.head.appendChild(a),function(){var e=document.createElement("div");e.id="application-splash-wrapper",document.body.appendChild(e);var t=document.createElement("div");t.id="application-splash",e.appendChild(t),t.style.display="none";var a=document.createElement("img");a.src="https://assets.venge.io/ArchersBounty-Logo.png",a.onload=function(){t.style.display="block"};var o=document.createElement("div");o.id="progress-bar-container",t.appendChild(o);var n=document.createElement("div");n.id="progress-bar",o.appendChild(n)}(),e.on("preload:end",(function(){e.off("preload:progress")})),e.on("preload:progress",(function(e){var t=document.getElementById("progress-bar");t&&(e=Math.min(1,Math.max(0,e)),t.style.width=100*e+"%")})),e.on("start",(function(){var e=document.getElementById("application-splash-wrapper");e.parentElement.removeChild(e)}))}));var Chest=pc.createScript("chest");Chest.attributes.add("topEntity",{type:"entity"}),Chest.attributes.add("shineEntity",{type:"entity"}),Chest.prototype.initialize=function(){this.topEntity.fire("Motion","Open"),this.app.fire("Motion","HitShake"),this.app.fire("BakedPhysics:DestroyEffect",this.entity.getPosition()),this.app.fire("UpgradeManager:Show")};var SpellCaster=pc.createScript("spellCaster");SpellCaster.attributes.add("characterEntity",{type:"entity"}),SpellCaster.prototype.initialize=function(){this.isActive=!1,this.lastSpellCast=Date.now(),this.spellTime=2500+1e3*Math.random(),this.entity.on("Target:Have",this.haveTarget,this)},SpellCaster.prototype.haveTarget=function(){this.isActive=!0},SpellCaster.prototype.spellAttack=function(){this.characterEntity.anim.setTrigger("CastSpell"),this.entity.fire("Locked",!0),setTimeout((function(t){t.entity.fire("Locked",!1)}),1e3,this)},SpellCaster.prototype.update=function(t){return!!Utils.isGameActive&&(!!this.isActive&&void(Date.now()-this.lastSpellCast>this.spellTime&&(this.spellAttack(),this.lastSpellCast=Date.now())))};var SpinManager=pc.createScript("spinManager");SpinManager.attributes.add("upgradeManager",{type:"entity"}),SpinManager.attributes.add("rouletteEntity",{type:"entity"}),SpinManager.attributes.add("spinHolder",{type:"entity"}),SpinManager.attributes.add("spinDefaultEntity",{type:"entity"}),SpinManager.attributes.add("firstColor",{type:"boolean",enum:[{"Color-1":!0},{"Color-2":!1}]}),SpinManager.attributes.add("color1",{type:"rgb"}),SpinManager.attributes.add("color2",{type:"rgb"}),SpinManager.attributes.add("maxMoney",{type:"number"}),SpinManager.attributes.add("minMoney",{type:"number"}),SpinManager.attributes.add("prizeColor",{type:"curve",color:"rgb",default:{keys:[[0,.5,.5,1,1,0],[0,0,.5,.5,1,1],[0,1,.5,0,1,.5]]}}),SpinManager.attributes.add("prizeColorTime",{type:"number"}),SpinManager.prototype.initialize=function(){this.isSpinning=!1,this.spinSpeed=60,this.timer=0,this.prizeEffect=!1,this.app.on("SpinManager:Show",this.onShow,this),this.app.on("SpinManager:Hide",this.onHide,this),this.app.on("SpinManager:Spin",this.onSpin,this),this.app.on("SpinManager:UpdateReward",this.updateReward,this)},SpinManager.prototype.onShow=function(){this.rouletteEntity.enabled=!0,this.firstColorOnShow=this.firstColor,this.rewards||this.updateReward();for(var t=0;t<8;t++){var e=this.spinDefaultEntity.clone();e.enabled=!0,e.tags.add("SpinEntity"),e.rotateLocal(0,0,-45*t);var i=this.rewards[t],n="";"Money"==i?(n=Math.floor(Math.random()*(this.maxMoney-this.minMoney)+this.minMoney),this.rewards[t]=n):(e.findByName("RewardIcon").element.textureAsset=i.icon,n=i.name),e.findByName("RewardText").element.text=n.toString();var r=!1;this.firstColorOnShow?(r=this.color1,this.firstColorOnShow=!1):(r=this.color2,this.firstColorOnShow=!0),e.findByName("RewardColor").element.color=r,this.spinHolder.addChild(e)}},SpinManager.prototype.onHide=function(){this.rouletteEntity.enabled=!1},SpinManager.prototype.onSpin=function(){if(this.isSpinning)return!1;this.isSpinning=!0,this.spinStartTime=Date.now(),this.spinSpeed=60,this.spinRotation=0},SpinManager.prototype.updateReward=function(){if(this.isSpinning)return!1;this.clearSpin(),this.rewards=this.getEnabledUpgrades();for(var t=Number(this.rewards.length+""),e=0;e<t;e++)this.rewards.push("Money");this.rewards=Utils.shuffle(this.rewards),this.rewards=this.rewards.slice(0,8),this.rouletteEntity.enabled&&(this.rouletteEntity.enabled=!1,this.onShow())},SpinManager.prototype.clearSpin=function(){for(var t=this.spinHolder.findByTag("SpinEntity"),e=0;e<t.length;e++){t[e].destroy()}},SpinManager.prototype.getEnabledUpgrades=function(){for(var t=[],e=this.upgradeManager.script.upgradeManager.upgrades,i=0;i<e.length;i++){var n=e[i];n.entity&&!n.entity.enabled&&t.push(n)}return t},SpinManager.prototype.getReward=function(){for(var t=-1/0,e=!1,i=this.spinHolder.children,n=0;n<i.length;n++){var r=i[n];if(r!=this.spinDefaultEntity){var a=r.findByName("RewardIcon").getPosition();a.y>t&&(t=a.y,e=n)}}this.prizeEffect=i[e].findByName("RewardColor");var s=this.rewards[e-1];s.name?this.app.fire("UpgradeManager:Upgrade",s.entity.name):this.app.fire("Money:Add",s)},SpinManager.prototype.update=function(t){if(this.isSpinning&&(this.spinRotation+=this.spinSpeed*t,this.spinHolder.rotateLocal(0,0,-this.spinSpeed*t),Date.now()-this.spinStartTime<1e3?this.spinSpeed+=t*this.spinSpeed*1.75+2*Math.random():Date.now()-this.spinStartTime<2e3?this.spinSpeed+=t*this.spinSpeed:Date.now()-this.spinStartTime<3e3?this.spinSpeed-=t*this.spinSpeed:(this.spinSpeed-=this.spinSpeed/100*t*60,this.spinSpeed<10&&(this.spinSpeed-=this.spinSpeed/50*t*60),this.spinSpeed<1&&(this.isSpinning=!1,this.getReward(this.spinRotation)))),this.prizeEffect){this.timer+=t/this.prizeColorTime;var e=this.prizeColor.value(this.timer);this.prizeEffect.element.color=new pc.Color(e[0],e[1],e[2],e[3]),this.timer>=1&&(this.prizeEffect=!1,this.timer=0)}};var UpgradePlayerSpeed=pc.createScript("upgradePlayerSpeed");UpgradePlayerSpeed.attributes.add("type",{type:"number",enum:[{"Set Speed":0},{"Add Speed":1},{"Multiply Speed":2}]}),UpgradePlayerSpeed.attributes.add("value",{type:"number"}),UpgradePlayerSpeed.attributes.add("playerEntity",{type:"entity"}),UpgradePlayerSpeed.prototype.initialize=function(){this.movement=this.playerEntity.script.movement,this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradePlayerSpeed.prototype.onStateChange=function(e){var t;e?(0==this.type?t=this.value:1==this.type?t=this.movement.speed+this.value:2==this.type&&(t=this.movement.speed*this.value),this.defaultSpeed=Number(this.movement.speed+""),this.movement.speed=t):this.movement.speed=this.defaultSpeed},UpgradePlayerSpeed.prototype.onDestroy=function(){this.onStateChange(!1)};var UpgradeMultiShoot=pc.createScript("upgradeMultiShoot");UpgradeMultiShoot.attributes.add("countOfExtraShots",{type:"number",default:2,description:"count"}),UpgradeMultiShoot.attributes.add("timeBetweenShots",{type:"number",default:.166,description:"seconds"}),UpgradeMultiShoot.attributes.add("playerEntity",{type:"entity"}),UpgradeMultiShoot.prototype.initialize=function(){this.onStateChange(!0),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},UpgradeMultiShoot.prototype.onStateChange=function(t){!0===t?this.app.on("Player:Shoot",this.onShoot,this):this.app.off("Player:Shoot",this.onShoot,this)},UpgradeMultiShoot.prototype.onDestroy=function(){this.onStateChange(!1)},UpgradeMultiShoot.prototype.onShoot=function(t,o){for(var e=1;e<=this.countOfExtraShots;e++)setTimeout((function(t){t.app.fire("ShootManager:Shoot","Player","Arrow",t.playerEntity.getPosition(),o)}),1e3*this.timeBetweenShots*e,this)};var Nightmare=pc.createScript("nightmare");Nightmare.prototype.initialize=function(){this.app.fire("Motion","HitShake"),this.app.fire("BakedPhysics:DestroyEffect",this.entity.getPosition()),this.app.fire("UpgradeManager:Show")};var AttachToBone=pc.createScript("attachTobone");AttachToBone.attributes.add("relations",{type:"json",schema:[{name:"entity",type:"entity"},{name:"bone",type:"string"},{name:"attach",type:"boolean",default:!0}],array:!0}),AttachToBone.attributes.add("isDebug",{type:"boolean"}),AttachToBone.prototype.initialize=function(){var t=this,e=this.entity.model.asset;this.app.assets.get(e).ready((function(){t.onLoad()}))},AttachToBone.prototype.onLoad=function(){for(var t in this.isDebug&&console.log(this.entity.children),this.relations){var e=this.relations[t];e.attach&&(e.entity.reparent(this.entity.findByName(e.bone)),e.entity.setLocalScale(100,100,100))}};var TalentManager=pc.createScript("talentManager");TalentManager.attributes.add("talentInterface",{type:"entity"}),TalentManager.attributes.add("talentItem",{type:"entity"}),TalentManager.attributes.add("talentHolder",{type:"entity"}),TalentManager.attributes.add("closeButton",{type:"entity"}),TalentManager.attributes.add("haveUpgradeWarning",{type:"entity"}),TalentManager.attributes.add("baseHealth",{type:"number",default:20}),TalentManager.attributes.add("healthFactor",{type:"number",default:.01}),TalentManager.attributes.add("upgradePrice",{type:"number"}),TalentManager.attributes.add("upgradePriceMultiply",{type:"number"}),TalentManager.attributes.add("priceFactor",{type:"number"}),TalentManager.attributes.add("upgradePriceTextEntity",{type:"entity"}),TalentManager.attributes.add("playerEntity",{type:"entity"}),TalentManager.attributes.add("characterEntity",{type:"entity"}),TalentManager.attributes.add("arrowEntity",{type:"entity"}),TalentManager.attributes.add("coinValueEntity",{type:"entity"}),TalentManager.attributes.add("noMoneyAlert",{type:"entity"}),TalentManager.attributes.add("buyButton",{type:"entity"}),TalentManager.attributes.add("buyButtonContent",{type:"entity"}),TalentManager.attributes.add("buyButtonSpinner",{type:"entity"}),TalentManager.attributes.add("adButton",{type:"entity"}),TalentManager.attributes.add("regenerationTimeOut",{type:"number",default:5}),TalentManager.attributes.add("healthRegeneration",{type:"number",default:5}),TalentManager.attributes.add("talents",{type:"json",schema:[{name:"name",type:"string"},{name:"icon",type:"asset"},{name:"level",type:"number",default:1},{name:"description",type:"string"}],array:!0}),TalentManager.attributes.add("changeLevelColorStep",{type:"number",description:"5 = 1-5 levels one color, 6-10 levels next color",default:5}),TalentManager.attributes.add("levelColors",{type:"rgb",array:!0}),TalentManager.prototype.initialize=function(){this.app.on("Mount:Ready",this.load,this)},TalentManager.prototype.load=function(){this.items=[],this.lockedItems=[],this.recoverLevel=!1,this.lastRecover=Date.now(),this.values={Strength:100,Recover:1,Agile:1,Power:1},this.suffix={Strength:" HP",Recover:"x faster",Agile:"x faster",Power:" DMG"},this.currentUpgradePrice=100,this.randomTalentIndex=0,this.talentItem.enabled=!1,this.defaultMaxHealth=Number(this.playerEntity.script.label.maxHealth+""),this.defaultArrowDamage=Number(this.arrowEntity.script.bullet.damage+""),this.loadTalents(),this.app.on("TalentManager:Show",this.onShow,this),this.app.on("TalentManager:Hide",this.onHide,this),this.app.on("TalentManager:Upgrade",this.onRandomUpgrade,this),this.app.on("TalentManager:RewardUpgrade",this.onRewardUpgrade,this),this.app.on("TalentManager:DescriptionShow",this.onDescriptionShow,this),this.app.on("TalentManager:DescriptionHide",this.onDescriptionHide,this)},TalentManager.prototype.saveTalents=function(){var t=[];for(var e in this.talents){var a=this.talents[e],n={name:a.name,level:a.level};t.push(n)}Utils.setItem("Talents",JSON.stringify(t))},TalentManager.prototype.loadTalents=function(){var t=Utils.getItem("Talents");if(t)for(var e in t=JSON.parse(t)){var a=t[e],n=this.talents.find((t=>t.name===a.name));n&&(n.level=a.level,this.applyTalent(a.name,a.level))}},TalentManager.prototype.onShow=function(){this.talentInterface.enabled=!0,this.updateTalentsList(),this.playerEntity.script.movement.isLocked=!0,this.buyButton.button.active=pc.MoneyManager.money>=this.currentUpgradePrice,this.adButton.enabled=!1,Utils.isGameActive=!1},TalentManager.prototype.onHide=function(){this.talentInterface.enabled=!1,this.playerEntity.script.movement.isLocked=!1,Utils.isGameActive=!0},TalentManager.prototype.onDescriptionShow=function(t){var e=this.items[t];e&&(e.findByName("Description").enabled=!0)},TalentManager.prototype.onDescriptionHide=function(t){var e=this.items[t];e&&(e.findByName("Description").enabled=!1)},TalentManager.prototype.updateTalentsList=function(){for(var t in this.items)this.items[t].destroy();for(var t in this.lockedItems)this.lockedItems[t].destroy();this.items=[],this.lockedItems=[];for(var e=0;e<this.talents.length;e++){var a=this.talents[e];(i=this.talentItem.clone()).enabled=!0,i.icon=a.icon,i.name=a.name;var n=this.levelColors[Math.floor((a.level-1)/5)];n||(n=this.levelColors[this.levelColors.length-1]),i.findByName("LevelColor").element.color=n,i.findByName("Icon").element.textureAsset=a.icon,i.findByName("Title").element.text=a.name,i.findByName("Level").element.text=a.level+"",i.findByName("DescriptionText").element.text=a.description,i.findByName("Value").element.text=this.values[a.name]+this.suffix[a.name],i.script.button.value=e,this.talentHolder.addChild(i),this.items.push(i)}for(e=0;e<6-this.talents.length;e++){var i;(i=this.talentItem.clone()).enabled=!0,i.element.color=new pc.Color(0,0,0),i.element.opacity=.25,i.findByName("Content").enabled=!1,i.findByName("Lock").enabled=!0,this.talentHolder.addChild(i),this.lockedItems.push(i)}this.updatePrice()},TalentManager.prototype.updateOneItem=function(t){var e=this.items[this.talents.indexOf(t)];e.enabled=!1;var a=this.levelColors[Math.floor((t.level-1)/5)];a||(a=this.levelColors[this.levelColors.length-1]),e.findByName("LevelColor").element.color=a,e.findByName("Level").element.text=t.level+"",e.enabled=!0,this.saveTalents(),this.updatePrice()},TalentManager.prototype.updatePrice=function(){var t=0;for(var e in this.talents)t+=this.talents[e].level-1;var a=Math.pow(this.upgradePrice,this.upgradePriceMultiply+this.priceFactor*t);a=Math.round(1e3*a)/1e3,a=Math.round(a),this.currentUpgradePrice=a,a=Utils.formatCoin(a),this.upgradePriceTextEntity.element.text=a,this.coinValueEntity.element.text=pc.MoneyManager.money+""},TalentManager.prototype.applyAllTalents=function(){for(var t in this.talents){var e=this.talents[t];this.applyTalent(e.name,e.level)}},TalentManager.prototype.calculateHealthUpgrade=function(t){for(var e=0,a=1;a<=t;a++)e+=Math.floor(this.baseHealth*Math.pow(this.healthFactor,a-1));return e},TalentManager.prototype.applyTalent=function(t,e){if("Strength"==t){var a=this.calculateHealthUpgrade(e);this.playerEntity.script.label.health=this.defaultMaxHealth+a,this.playerEntity.script.label.maxHealth=this.defaultMaxHealth+a,this.values[t]=this.defaultMaxHealth+a}else if("Power"==t){var n=.5*(e-1);this.arrowEntity.script.bullet.damage=this.defaultArrowDamage+n,this.values[t]=this.defaultArrowDamage+n}else"Recover"==t?(this.recoverLevel=e,this.values[t]=this.recoverLevel):"Agile"==t&&(this.agileLevel=e,this.values[t]=this.agileLevel)},TalentManager.prototype.showNoMoney=function(){this.noMoneyAlert.enabled||(this.noMoneyAlert.enabled=!0,this.noMoneyTimer=setTimeout((function(t){t.noMoneyAlert.enabled=!1}),1e3,this))},TalentManager.prototype.onRandomUpgrade=function(){return pc.MoneyManager.money<this.currentUpgradePrice?(this.showNoMoney(),!1):!!this.buyButton.button.active&&(this.randomAnimationTime=300,this.randomAnimationCount=0,this.totalCount=15+Math.floor(4*Math.random()),this.playRandomAnimation(),this.app.fire("Money:Remove",this.currentUpgradePrice),this.entity.sound.play("Buy"),this.buyButtonContent.enabled=!1,this.buyButtonSpinner.enabled=!0,this.buyButton.button.active=!1,void(this.closeButton.enabled=!1))},TalentManager.prototype.onRewardUpgrade=function(){var t=this;PokiPlugin.showReward((function(){t.onAdShow()}),{disableEvents:!0})},TalentManager.prototype.onAdShow=function(){this.randomAnimationTime=300,this.randomAnimationCount=0,this.totalCount=15+Math.floor(4*Math.random()),this.playRandomAnimation(!0),this.entity.sound.play("Buy"),this.buyButtonContent.enabled=!1,this.buyButton.button.active=!1,this.adButton.enabled=!1,this.closeButton.enabled=!1},TalentManager.prototype.getHighlightItem=function(t){return this.items[this.talents.indexOf(t)].findByName("Highlight")},TalentManager.prototype.playRandomAnimation=function(t){if(this.randomAnimationCount>this.totalCount)return this.randomTalent.level+=1,this.updateOneItem(this.randomTalent),this.applyTalent(this.randomTalent.name,this.randomTalent.level),this.highlightEntity.script.timeline=1,this.highlightEntity.enabled=!0,this.entity.sound.play("LevelUp"),this.buyButton.button.active=pc.MoneyManager.money>=this.currentUpgradePrice,t||(this.adButton.enabled=pc.MoneyManager.money<this.currentUpgradePrice,setTimeout((function(t){t.adButton.enabled=!1}),1e4,this)),this.buyButtonContent.enabled=!0,this.buyButtonSpinner.enabled=!1,this.closeButton.enabled=!0,setTimeout((function(t){t.highlightEntity.enabled=!1,t.applyAllTalents(),t.updateTalentsList()}),1e3,this),!1;this.randomTalentIndex++,this.randomTalentIndex>this.talents.length-1&&(this.randomTalentIndex=0),this.randomTalent=this.talents[this.randomTalentIndex],this.highlightEntity=this.getHighlightItem(this.randomTalent),this.highlightEntity.script.timeline=.2,this.highlightEntity.enabled=!0,this.entity.sound.play("Click"),setTimeout((function(e){e.highlightEntity.enabled=!1,e.playRandomAnimation(t)}),this.randomAnimationTime,this),this.randomAnimationTime-=15,this.randomAnimationCount++},TalentManager.prototype.updateRecover=function(){if(Date.now()-this.lastRecover<1e3*(this.regenerationTimeOut-.1*this.recoverLevel))return!1;var t=parseInt(this.playerEntity.script.label.health+""),e=parseInt(this.playerEntity.script.label.maxHealth+""),a=t+this.healthRegeneration;a>e&&(a-=a-e),this.playerEntity.fire("Health",a),this.lastRecover=Date.now()},TalentManager.prototype.updateAgile=function(){if(!this.agileLevel)return!1;if(this.playerEntity.script.movement.isShooting){var t=0;this.playerEntity.script.movement.onShotAbility&&(t=1),this.characterEntity.anim.speed=this.agileLevel/20+1+t}else this.playerEntity.script.movement.onShotAbility||(this.characterEntity.anim.speed=1)},TalentManager.prototype.updateWarning=function(){this.haveUpgradeWarning.enabled=pc.MoneyManager.money>=this.currentUpgradePrice},TalentManager.prototype.update=function(t){this.updateRecover(),this.updateAgile(),this.updatePrice(),this.updateWarning()};var Menu=pc.createScript("menu");Menu.attributes.add("items",{type:"json",schema:[{name:"entity",type:"entity"},{name:"value",type:"string"}],array:!0}),Menu.prototype.initialize=function(){this.gameplayElements=this.app.root.findByTag("Gameplay"),this.app.on("Menu:Switch",this.switchMenu,this),this.app.on("Menu:DisableAll",this.disableAll,this),this.app.on("Menu:Close",this.closeMenu,this),this.app.keyboard&&this.app.keyboard.on(pc.EVENT_KEYDOWN,this.onKeyDown,this)},Menu.prototype.onKeyDown=function(e){e.key===pc.KEY_ESCAPE&&this.closeMenu()},Menu.prototype.closeMenu=function(){this.disableAll(),PokiPlugin.onPlay(),Utils.isGameActive=!0},Menu.prototype.disableAll=function(){this.app.fire("TalentManager:Hide"),this.app.fire("RuneManager:Hide"),this.app.fire("MapManager:Hide"),this.app.fire("PetManager:HideEgg"),this.gameplayElements.forEach((function(e){e.enabled=!0})),Utils.isGameActive=!0},Menu.prototype.switchMenu=function(e){this.disableAll(),PokiPlugin.onPause();for(var t=0;t<this.items.length;t++)this.items[t].entity.name===e&&(this.app.fire(this.items[t].value),this.gameplayElements.forEach((function(e){e.enabled=!1})));Utils.isGameActive=!1,this.app.fire("Gameplay:Stop")};var Progress=pc.createScript("progress");Progress.prototype.initialize=function(){this.alphaValue=1,this.nextAlphaValue=0,this._element=this.entity.element,this._element.material=this._element.material.clone(),this._element.material.opacityMapChannel="r",this._element.material.alphaTest=this.alphaValue+.001,this._element.material.update(),this.app.on("Progress:"+this.entity.name,this.setProgress,this),this.setProgress(0),this.on("destroy",this.onDestroy,this)},Progress.prototype.onDestroy=function(e){this.app.off("Progress:"+this.entity.name,this.setProgress,this)},Progress.prototype.setProgress=function(e){e=pc.math.clamp(1-e,0,1),this.nextAlphaValue=e},Progress.prototype.update=function(e){this.alphaValue=pc.math.lerp(this.alphaValue,this.nextAlphaValue,.05),this._element.material.alphaTest=this.alphaValue+.001,this._element.material.update()};var RuneManager=pc.createScript("runeManager");RuneManager.attributes.add("runeEntity",{type:"entity"}),RuneManager.attributes.add("runes",{type:"entity",array:!0}),RuneManager.attributes.add("origins",{type:"entity",array:!0}),RuneManager.attributes.add("activeColor",{type:"rgb"}),RuneManager.attributes.add("deactiveColor",{type:"rgb"}),RuneManager.attributes.add("fusionButton",{type:"entity"}),RuneManager.attributes.add("originEntity",{type:"entity"}),RuneManager.attributes.add("notificationEntity",{type:"entity"}),RuneManager.attributes.add("tutorialEntity",{type:"entity"}),RuneManager.attributes.add("runeItem",{type:"entity"}),RuneManager.attributes.add("runeElement",{type:"entity"}),RuneManager.attributes.add("countText",{type:"entity"}),RuneManager.attributes.add("spawnTimes",{type:"string",default:"1, 3, 5, 10"}),RuneManager.prototype.initialize=function(){this.currentRunes=0,this.nextRunes=0,this.steps=[0,.2,.8,1],this.spawnTimeIndex=this.spawnTimes.split(", ").map((function(t){return parseFloat(t)})),this.lastSpawnIndex=0,this.lastSpawnDuration=this.spawnTimeIndex[0],this.lastSpawnTime=Date.now(),this.loadRunes(),this.app.on("RuneManager:Show",this.onShow,this),this.app.on("RuneManager:Hide",this.onHide,this),this.app.on("RuneManager:Collect",this.onCollect,this),this.app.on("RuneManager:Fusion",this.onFusion,this),this.app.on("RuneManager:SpawnRune",this.spawnRuneItem,this),this.fusionButton.button.active=!1},RuneManager.prototype.spawnRuneItem=function(t){var e=this.runeItem.clone();e.setPosition(t),e.enabled=!0,this.app.root.addChild(e)},RuneManager.prototype.loadRunes=function(){nextRunes=Utils.getItem("Runes"),nextRunes&&(this.nextRunes=nextRunes),this.nextRunes>=3&&(this.tutorialEntity.enabled=!0)},RuneManager.prototype.saveRunes=function(){Utils.setItem("Runes",this.nextRunes)},RuneManager.prototype.onFusion=function(){for(var t=0;t<this.runes.length;t++)this.runes[t].fire("Timeline");this.app.fire("PetManager:NextPet"),this.reset(),this.originEntity.fire("Timeline"),this.entity.sound.play("Unlock"),setTimeout((function(t){pc.app.fire("Menu:Close")}),1e3,this)},RuneManager.prototype.reset=function(){this.currentRunes=0,this.nextRunes=0,this.disableRunes(),this.saveRunes(),this.app.fire("Progress:RuneProgress",this.steps[this.currentRunes]),this.notificationEntity.enabled=!1,this.tutorialEntity.enabled=!1,this.fusionButton.button.active=!1},RuneManager.prototype.onCollect=function(t){this.entity.sound.play("Collect"),this.app.fire("World2Screen:Animate","Rune",t,this.runeElement),this.nextRunes++,this.countText.element.text=this.nextRunes+" / 3",this.saveRunes(),this.notificationEntity.enabled=!0,this.runeEntity.enabled&&this.nextStep(),this.nextRunes>=3&&(this.tutorialEntity.enabled=!0),pc.BalanceSession.runeCallback&&(pc.BalanceSession.runeCallback(),pc.BalanceSession.runeCallback=!1)},RuneManager.prototype.onShow=function(){this.runeEntity.enabled=!0,this.notificationEntity.enabled=!1,this.nextStep()},RuneManager.prototype.onHide=function(){this.runeEntity.enabled=!1},RuneManager.prototype.nextStep=function(){return!(this.currentRunes>=this.nextRunes)&&(!!this.runes[this.currentRunes]&&(this.app.fire("Progress:RuneProgress",this.steps[this.currentRunes]),this.runes[this.currentRunes].fire("Timeline"),this.runes[this.currentRunes].element.color=this.activeColor,this.origins[this.currentRunes].enabled=!0,this.currentRunes++,this.currentRunes>=this.steps.length-1&&(this.app.fire("Progress:RuneProgress",this.steps[this.currentRunes]),setTimeout((function(t){t.tutorialEntity.enabled=!0,t.fusionButton.button.active=!0,t.fusionButton.fire("Timeline")}),250,this)),void setTimeout((function(t){t.nextStep()}),500,this)))},RuneManager.prototype.disableRunes=function(){for(var t=0;t<this.runes.length;t++)this.runes[t].element.color=this.deactiveColor,this.origins[t].enabled=!1},RuneManager.prototype.update=function(){Date.now()-this.lastSpawnTime>1e3*this.lastSpawnDuration*60&&(pc.BalanceSession.hasRune=!0,this.lastSpawnIndex++,this.spawnTimeIndex[this.lastSpawnIndex]&&(this.lastSpawnDuration=this.spawnTimeIndex[this.lastSpawnIndex]),this.lastSpawnTime=Date.now())};var Prefab=pc.createScript("prefab");Prefab.prototype.initialize=function(){},Prefab.prototype.update=function(e){};var CurvedProjectile=pc.createScript("curvedProjectile");CurvedProjectile.attributes.add("playerEntity",{type:"entity"}),CurvedProjectile.attributes.add("modelEntity",{type:"entity"}),CurvedProjectile.attributes.add("shadowEntity",{type:"entity"}),CurvedProjectile.attributes.add("radius",{type:"number",default:.5}),CurvedProjectile.attributes.add("speed",{type:"number",default:1}),CurvedProjectile.attributes.add("damage",{type:"number",default:15}),CurvedProjectile.attributes.add("hitEffect",{type:"string",default:"Explosion"}),CurvedProjectile.prototype.initialize=function(){this.direction=0,this.setDirection()},CurvedProjectile.prototype.setDirection=function(){var t=this.entity.getPosition(),e=this.playerEntity.getPosition(),i=Utils.lookAt(t.x,t.z,e.x,e.z);this.direction=Utils.rotate(this.direction,i,1);var o=Utils.distance(t.x,t.z,e.x,e.z);this.modelEntity.script.motion.motions[0].speed=1/(o/this.speed)},CurvedProjectile.prototype.updateDistances=function(){var t=this.modelEntity.getPosition(),e=this.playerEntity.getPosition();t.distance(e);t.y<.1&&(this.entity.destroy(),this.app.fire("ShootManager:Explode","Enemy",this.hitEffect,this.modelEntity.getPosition()))},CurvedProjectile.prototype.updateMove=function(t){var e=this.direction-Math.PI/2,i=Math.cos(e)*t*this.speed,o=-Math.sin(e)*t*this.speed;this.entity.translate(i,0,o)},CurvedProjectile.prototype.update=function(t){var e=this.entity.getPosition();this.shadowEntity.setPosition(e.x,0,e.z),this.updateMove(t),this.updateDistances()};var Worm=pc.createScript("worm");Worm.attributes.add("characterEntity",{type:"entity"}),Worm.attributes.add("playerEntity",{type:"entity"}),Worm.attributes.add("shootFrom",{type:"entity"}),Worm.attributes.add("projectileEntity",{type:"entity"}),Worm.attributes.add("originEntity",{type:"entity"}),Worm.attributes.add("targetRadius",{type:"number",default:7}),Worm.attributes.add("playerRadiusSpawn",{type:"number",default:3}),Worm.attributes.add("teleportTimeOut",{type:"number",default:3,description:"seconds"}),Worm.attributes.add("undergroundTime",{type:"number",default:1,description:"seconds"}),Worm.attributes.add("attackTimeOut",{type:"number",default:3,description:"seconds"}),Worm.attributes.add("animationTime",{type:"number",default:.85,description:"seconds"}),Worm.prototype.initialize=function(){this.lastTeleport=Date.now(),this.lastAttack=Date.now(),this.lastTeleportRandom=1e3*Math.random(),this.isActive=!1,this.teleportPoints=this.entity.parent.parent.parent.findByTag("Spawn"),this.characterEntity.anim.on("Shoot",this.onShoot,this),this.characterEntity.anim.on("UnderGround",this.underGround,this)},Worm.prototype.updatePlayerDistance=function(){var t=this.entity.getPosition(),e=this.playerEntity.getPosition();Utils.distance(t.x,t.z,e.x,e.z)<this.targetRadius?this.isActive=!0:this.isActive=!1},Worm.prototype.updateTeleport=function(){Date.now()-this.lastTeleport>1e3*this.teleportTimeOut+this.lastTeleportRandom&&(this.onTeleport(),this.lastTeleportRandom=2e3*Math.random())},Worm.prototype.onTeleport=function(){this.goDown(),setTimeout((function(t){t.goUp()}),this.animationTime+1e3*this.undergroundTime,this),this.lastTeleport=1e3*(this.undergroundTime+2*this.animationTime)+Date.now()},Worm.prototype.goDown=function(){this.characterEntity.anim&&this.characterEntity.anim.setTrigger("Down")},Worm.prototype.underGround=function(){var t=this.entity.getPosition();this.entity.setPosition(t.x,-100,t.z)},Worm.prototype.goUp=function(){var t=this.teleportPoints[Math.floor(Math.random()*this.teleportPoints.length)];t&&this.entity.setPosition(t.getPosition().clone()),this.lookAtPlayer(),this.characterEntity.anim&&this.characterEntity.anim.setTrigger("Up")},Worm.prototype.lookAtPlayer=function(){var t=this.entity.getPosition(),e=this.playerEntity.getPosition(),i=Utils.lookAt(t.x,t.z,e.x,e.z);this.originEntity.setLocalEulerAngles(0,i*pc.math.RAD_TO_DEG,0)},Worm.prototype.update=function(t){this.updatePlayerDistance(),this.isActive&&this.updateTeleport()},Worm.prototype.onShoot=function(){this.lookAtPlayer();var t=this.shootFrom.getPosition().clone(),e=this.projectileEntity.clone();e.setPosition(t),e.enabled=!0,this.app.root.addChild(e)};var TornadoProjectile=pc.createScript("tornadoProjectile");TornadoProjectile.attributes.add("playerEntity",{type:"entity"}),TornadoProjectile.attributes.add("modelEntity",{type:"entity"}),TornadoProjectile.attributes.add("shadowEntity",{type:"entity"}),TornadoProjectile.attributes.add("radius",{type:"number",default:.5}),TornadoProjectile.attributes.add("speed",{type:"number",default:1}),TornadoProjectile.attributes.add("damage",{type:"number",default:15}),TornadoProjectile.prototype.initialize=function(){this.direction=0,this.setDirection()},TornadoProjectile.prototype.setDirection=function(){var t=this.entity.getPosition(),i=this.playerEntity.getPosition(),e=Utils.lookAt(t.x,t.z,i.x,i.z);this.direction=Utils.rotate(this.direction,e,1)},TornadoProjectile.prototype.updateDistances=function(){var t=this.modelEntity.getPosition(),i=this.playerEntity.getPosition(),e=t.distance(i);if(isNaN(this.modelEntity.script.motion.timestamp))return this.entity.destroy(),!1;e<this.radius&&(this.entity.destroy(),this.playerEntity.fire("Hit",this.damage,"Cannon",t))},TornadoProjectile.prototype.updateMove=function(t){var i=this.direction-Math.PI/2,e=Math.cos(i)*t*this.speed,o=-Math.sin(i)*t*this.speed;this.entity.translate(e,0,o)},TornadoProjectile.prototype.update=function(t){var i=this.entity.getPosition();this.shadowEntity.setPosition(i.x,0,i.z),this.updateMove(t),this.updateDistances()};var PrefabManager=pc.createScript("prefabManager");PrefabManager.prototype.postInitialize=function(){this.stages={},this.entity.setPosition(0,0,0),this.items=this.entity.findByTag(pc.BalanceSession.mapName),this.generateWorld()},PrefabManager.prototype.generateWorld=function(){for(var a=this.entity.parent.findByTag("Prefab"),e=0;e<a.length;e++){var t=this.items[Math.floor(Math.random()*this.items.length)].clone();t.enabled=!0,a[e].parent.addChild(t),t.setPosition(a[e].getPosition())}this.app.fire("BalanceManager:Balance")},PrefabManager.prototype.setSpawnPoints=function(a,e){var t=a.findByTag("Spawn");for(var n in t){t[n].name="Ghost"}};var Horror=pc.createScript("horror");Horror.attributes.add("originEntity",{type:"entity"}),Horror.attributes.add("modelEntity",{type:"entity"}),Horror.attributes.add("playerEntity",{type:"entity"}),Horror.attributes.add("turnSpeed",{type:"number",default:.25}),Horror.attributes.add("turnRollingSpeed",{type:"number",default:.75}),Horror.attributes.add("rollingSpeed",{type:"number",default:1}),Horror.attributes.add("rollingTimeAfterHit",{type:"number",default:2}),Horror.attributes.add("maxRollingTime",{type:"number",default:4}),Horror.attributes.add("rollingTimeout",{type:"number",default:5}),Horror.attributes.add("radiusNotice",{type:"number",default:5}),Horror.attributes.add("radiusDamage",{type:"number",default:.5}),Horror.attributes.add("timeOutDamage",{type:"number",default:.2}),Horror.attributes.add("damage",{type:"number",default:1}),Horror.prototype.initialize=function(){this.isRolling=!1,this.lastRolling=-1,this.createdAt=Date.now(),this.randomTime=1e3*Math.random(),this.playerInRadius=!1,this.direction=0,this.lastDamage=Date.now()},Horror.prototype.updateState=function(){Date.now()-this.lastRolling>1e3*this.maxRollingTime+this.randomTime&&(this.isRolling=!0,this.randomTime=1e3*Math.random(),setTimeout((function(t){t.isRolling=!1}),1e3*this.rollingTimeout,this),this.lastRolling=Date.now())},Horror.prototype.updateDistance=function(){var t=this.entity.getPosition(),i=this.playerEntity.getPosition(),e=Utils.distance(t.x,t.z,i.x,i.z);this.isRolling?this.radiusDamage>e&&this.dealDamage():this.radiusNotice>e?this.playerInRadius=!0:this.playerInRadius=!1},Horror.prototype.dealDamage=function(){if(Date.now()-this.lastDamage<1e3*this.timeOutDamage)return!1;this.playerEntity.fire("Hit",this.damage,"Arrow",this.entity.getPosition()),this.lastDamage=Date.now()},Horror.prototype.updateMove=function(t){if(!this.isRolling)return!1;var i=this.direction-Math.PI/2,e=Math.cos(i)*t*this.rollingSpeed,r=-Math.sin(i)*t*this.rollingSpeed;this.entity.translate(e,0,r)},Horror.prototype.updateDirection=function(){var t=this.turnSpeed;this.isRolling&&(t=this.turnRollingSpeed);var i=this.entity.getPosition(),e=this.playerEntity.getPosition(),r=Utils.lookAt(i.x,i.z,e.x,e.z);this.direction=Utils.rotate(this.direction,r,t),this.originEntity.setLocalEulerAngles(0,this.direction*pc.math.RAD_TO_DEG,0)},Horror.prototype.update=function(t){return!!Utils.isGameActive&&(!(Date.now()-this.createdAt<3e3)&&(!this.entity.script.enemy.isDeath&&(this.modelEntity.anim.setBoolean("Spin",this.isRolling),this.updateDistance(),this.updateState(),this.updateDirection(),void this.updateMove(t))))};var BalanceManager=pc.createScript("balanceManager");BalanceManager.attributes.add("baseMultiplier",{type:"number",default:2,description:"Base multiplier for the relationship between bow damage and enemy health"}),BalanceManager.attributes.add("killScaling",{type:"number",default:5,description:"Define a scaling factor that will increase the difficulty based on kill count, 5% increase in difficulty per kill"}),BalanceManager.attributes.add("upgradeScaling",{type:"number",default:10,description:"Define a factor that reduces difficulty based on upgrade level, This will apply a 10% decrease in difficulty per upgrade, 10% decrease in difficulty per upgrade"}),BalanceManager.attributes.add("changeOverPeriod",{type:"number",default:3,description:"Apply an additional reduction for every 3rd upgrade level"}),BalanceManager.attributes.add("specialUpgradeReduction",{type:"number",default:15,description:"Game gets easier around that time"}),BalanceManager.attributes.add("exponentialStageDifficulty",{type:"number",default:1.5,description:"Define a factor for exponential stage increase"}),BalanceManager.attributes.add("levelRoot",{type:"entity"}),BalanceManager.attributes.add("levels",{type:"json",schema:[{name:"name",type:"string"},{name:"balanceMultiplier",type:"number",default:1},{name:"entity",type:"entity"}],array:!0}),pc.BalanceSession={playerDamage:1,killCount:0,upgradeLevel:1,mapName:"Valley",gameStart:Date.now(),hasUpgrade:!1,upgradeCallback:!1,hasRune:!1,runeCallback:!1},BalanceManager.prototype.postInitialize=function(){this.defineBalanceSession(),this.app.on("BalanceManager:Balance",this.doBalance,this),this.on("destroy",this.onDestroy,this)},BalanceManager.prototype.defineBalanceSession=function(){this.app.off("BalanceManager:Balance",this.doBalance,this)},BalanceManager.prototype.defineBalanceSession=function(){var e=1,a=this.app.root.findByName("ShootingManager");a&&(e+=a.findByName("Arrow").script.bullet.damage);var t=this.app.root.findByName("MapHolder");t&&(pc.BalanceSession.upgradeLevel=t.script.mapManager.currentLevel),pc.BalanceSession.playerDamage=e},BalanceManager.prototype.doBalance=function(){var e=1;for(var a in this.levels){var t=this.levels[a];t.name===pc.BalanceSession.mapName?(t.entity.enabled=!0,e=t.balanceMultiplier):t.entity.enabled=!1}var n=this.levelRoot.findByTag("Stage");for(var i in n){var r=n[i],l=parseInt(i),o=r.findByTag("Spawn"),p={},s=this.calculateTotalEnemyHealth(pc.BalanceSession.playerDamage,pc.BalanceSession.killCount,pc.BalanceSession.upgradeLevel,l)*e,c=this.generateEnemiesByHealth(pc.BalanceSession.mapName,s,o.length);for(var d in o){var h=o[d];if(c[d])p[g=c[d].name]?p[g]++:p[g]=1,h.name=g}var u=0;for(var g in p)r.script.condition.kills.push({enemy:g,kill:p[g]}),u++;0===u?(r.script.condition.autoplay=!0,r.script.condition.onComplete()):r.script.condition.autoplay=!1}},BalanceManager.prototype.getEnemiesByMap=function(e,a){if(!e)return[];var t=[],n=e.findByTag(a);for(var i in n){var r=n[i];t.push(r)}return t},BalanceManager.prototype.generateEnemiesByHealth=function(e,a,t){var n=this.app.root.findByName("EnemyManager"),i=this.getEnemiesByMap(n,e),r=parseInt(a+"");if(0===t)return[];var l=[...i].sort(((e,a)=>a.script.enemy.health-e.script.enemy.health)),o=[],p=Math.floor(.5*l.length),s=l[Math.floor(Math.random()*p)];s&&s.script&&s.script.enemy&&s.script.enemy.health<=r&&(o.push(s),r-=s.script.enemy.health,t--);var c=l.length-p,d=p+Math.floor(Math.random()*c),h=l[d],u=Math.floor(.5*l.length),g=l.length;if(h&&h.script&&h.script.enemy&&h.script.enemy.health>0)for(;r>=h.script.enemy.health&&t>0;)o.push(h),r-=h.script.enemy.health,u<g?(d=u+Math.floor(Math.random()*(g-u)),u++):d=g-1,h=l[d],t--;return o},BalanceManager.prototype.calculateTotalEnemyHealth=function(e,a,t,n){var i=1+a*this.killScaling*.01,r=1-t*this.upgradeScaling*.01;r<=0&&(r=1),t%this.changeOverPeriod==0&&(r*=1-.01*this.specialUpgradeReduction);var l=Math.pow(this.exponentialStageDifficulty,n),o=e*this.baseMultiplier*i*r*l;Date.now(),pc.BalanceSession.gameStart;return Math.round(o)};var ExperienceManager=pc.createScript("experienceManager");ExperienceManager.attributes.add("experienceValue",{type:"entity"}),ExperienceManager.attributes.add("experienceBar",{type:"entity"}),ExperienceManager.attributes.add("baseExperience",{type:"number",default:100}),ExperienceManager.attributes.add("experienceFactor",{type:"number",default:1.15}),ExperienceManager.attributes.add("returnFactor",{type:"number",default:.35}),ExperienceManager.attributes.add("experienceMultiplier",{type:"number",default:15}),ExperienceManager.attributes.add("arrowUpgrade",{type:"number",default:5}),ExperienceManager.attributes.add("popupEntity",{type:"entity"}),ExperienceManager.attributes.add("options",{type:"entity",array:!0}),ExperienceManager.attributes.add("damageText",{type:"entity"}),ExperienceManager.attributes.add("healthText",{type:"entity"}),ExperienceManager.attributes.add("strokeEntity",{type:"entity"}),ExperienceManager.attributes.add("cursorEntity",{type:"entity"}),ExperienceManager.attributes.add("playerEntity",{type:"entity"}),ExperienceManager.attributes.add("arrowEntity",{type:"entity"}),ExperienceManager.attributes.add("upgradeItem",{type:"entity"}),ExperienceManager.prototype.initialize=function(){var e=Utils.getItemAsNumber("NextExperience")||this.baseExperience;this.randomRewardName=!1,this.selectedUpgradeBefore=!1,this.currentExperience=Utils.getItemAsNumber("XP")||0,this.displayExperience=Utils.getItemAsNumber("XP")||0,this.previousExperience=Utils.getItemAsNumber("PreviousXP")||0;var t=Utils.getItemAsNumber("ArrowDamage");t>0&&(this.arrowEntity.script.bullet.damage=t),this.nextExperience=Math.round(e+""),this.app.on("Enemy:Death",this.onEnemyDeath,this),this.app.on("ExperienceManager:SpawnUpgradeItem",this.spawnUpgradeItem,this),this.app.on("ExperienceManager:LevelUp",this.levelUp,this),this.app.on("ExperienceManager:Upgrade",this.beforeUpgrade,this),this.app.on("ExperienceManager:GameFinishUpgrade",this.gameFinishUpgrade,this)},ExperienceManager.prototype.spawnUpgradeItem=function(e){var t=this.upgradeItem.clone();t.setPosition(e),t.enabled=!0,this.app.root.addChild(t)},ExperienceManager.prototype.onEnemyDeath=function(e,t){this.currentExperience+=t*this.experienceMultiplier,this.currentExperience>this.nextExperience&&(this.previousExperience=Math.round(this.nextExperience+""),this.baseExperience=Math.round(this.nextExperience+""),this.nextExperience=this.baseExperience+Math.pow(this.baseExperience*this.returnFactor,this.experienceFactor),pc.BalanceSession.hasUpgrade=!0),Utils.setItem("NextExperience",this.nextExperience),Utils.setItem("BaseExperience",this.baseExperience),Utils.setItem("PreviousXP",this.previousExperience),Utils.setItem("XP",this.currentExperience)},ExperienceManager.prototype.levelUp=function(){var e=["UpgradeDamage","Heal"];for(var t in this.options){var i=this.options[t];i&&(i.enabled=!0,i.findByName("Highlight").enabled=!1,i.findByName("Reward").enabled=!1)}var a=Math.round(Math.random()),r=this.options[a];r&&this.selectedUpgradeBefore&&(r.findByName("Reward").enabled=!0,this.randomRewardName=e[a],e.splice(a,1)),this.selectedUpgradeBefore=!0,this.popupEntity.enabled=!0,this.strokeEntity.enabled=!0,this.renderTexts(),this.isActive=!0,Utils.isGameActive=!1,this.autoSelectionTimer=setTimeout((function(t){var i=e[Math.floor(Math.random()*e.length)];t.upgrade(i)}),12e3,this),this.entity.sound.play("LevelUp"),this.entity.sound.play("Loop"),this.app.fire("Player:Stop"),PokiPlugin.onPause()},ExperienceManager.prototype.gameFinishUpgrade=function(e){var t=e.length;t>this.arrowEntity.script.bullet.damage&&(this.arrowEntity.script.bullet.damage=t,Utils.setItem("ArrowDamage",t))},ExperienceManager.prototype.renderTexts=function(){var e=parseFloat(this.arrowEntity.script.bullet.damage).toFixed(2),t=this.playerEntity.script.player.health;this.damageText.element.text="You have "+e+" damage",this.healthText.element.text="You have "+t+" health"},ExperienceManager.prototype.beforeUpgrade=function(e){if(clearTimeout(this.autoSelectionTimer),this.randomRewardName==e){var t=this;PokiPlugin.showReward((function(){t.upgrade(e)}))}else this.upgrade(e)},ExperienceManager.prototype.upgrade=function(e){if(!this.isActive)return!1;for(var t in this.options){var i=this.options[t];i.name==e?i.findByName("Highlight").enabled=!0:i.enabled=!1}"Heal"==e&&this.heal(),"UpgradeDamage"==e&&this.upgradeDamage(),this.renderTexts(),this.entity.sound.play("Upgrade"),this.cursorEntity.enabled=!1,setTimeout((function(e){e.hidePopup(),pc.BalanceSession.upgradeCallback&&(pc.BalanceSession.upgradeCallback(),pc.BalanceSession.upgradeCallback=!1),pc.app.fire("Scene:Triggers")}),2e3,this),this.isActive=!1,clearTimeout(this.autoSelectionTimer),PokiPlugin.onPlay()},ExperienceManager.prototype.hidePopup=function(){this.popupEntity.enabled=!1,this.strokeEntity.enabled=!1,this.entity.sound.stop("Loop"),Utils.isGameActive=!0},ExperienceManager.prototype.heal=function(){var e=parseInt(this.playerEntity.script.label.maxHealth+"");this.playerEntity.fire("Health",e)},ExperienceManager.prototype.upgradeDamage=function(){var e=this.arrowEntity.script.bullet.damage+this.arrowEntity.script.bullet.damage*this.arrowUpgrade*.01;this.arrowEntity.script.bullet.damage=e,Utils.setItem("ArrowDamage",e)},ExperienceManager.prototype.update=function(e){this.displayExperience=pc.math.lerp(this.displayExperience,this.currentExperience,.05),this.experienceValue.element.text=Math.round(this.displayExperience)+" / "+Math.round(this.nextExperience)+" XP";var t=(this.displayExperience-this.previousExperience)/(this.nextExperience-this.previousExperience);t>0&&this.experienceBar.setLocalScale(Math.min(t,1),1,1)};var LevelUpItem=pc.createScript("levelUpItem");LevelUpItem.prototype.initialize=function(){this.isDestroyed=!1,this.entity.on("Trigger",this.onTrigger,this),this.app.fire("Scene:Triggers")},LevelUpItem.prototype.onTrigger=function(e){if(this.isDestroyed)return!1;this.entity.fire("Motion","Destroy"),this.entity.destroy(),this.app.fire("ExperienceManager:LevelUp"),this.isDestroyed=!0};var Scorpion=pc.createScript("scorpion");Scorpion.attributes.add("shootFrom",{type:"entity"}),Scorpion.attributes.add("projectileEntity",{type:"entity"}),Scorpion.attributes.add("characterEntity",{type:"entity"}),Scorpion.prototype.initialize=function(){this.isActive=!1,this.createdAt=Date.now(),this.spinTime=2e3+1e3*Math.random(),this.lastSpin=Date.now(),this.lastShootTime=Date.now(),this.entity.on("Target:Have",this.haveTarget,this),this.characterEntity.anim.on("Shoot",this.onShoot,this)},Scorpion.prototype.haveTarget=function(){this.isActive=!0},Scorpion.prototype.projectileAttack=function(){this.characterEntity.anim.setTrigger("Spin"),this.entity.fire("Locked",!0),setTimeout((function(t){t.entity.fire("Locked",!1)}),1e3,this)},Scorpion.prototype.update=function(t){return!!this.isActive&&(!!Utils.isGameActive&&(!(Date.now()-this.createdAt<this.spinTime)&&void(Date.now()-this.lastSpin>this.spinTime&&(this.projectileAttack(),this.lastSpin=Date.now()))))},Scorpion.prototype.onShoot=function(){var t=this.shootFrom.getPosition().clone(),i=this.projectileEntity.clone();i.setPosition(t),i.enabled=!0,this.app.root.addChild(i)};var TextBackground=pc.createScript("textBackground");TextBackground.attributes.add("textEntity",{type:"entity"}),TextBackground.attributes.add("padding",{type:"number",default:10}),TextBackground.prototype.initialize=function(){},TextBackground.prototype.update=function(t){this.entity.element.width=this.textEntity.element.width+this.padding};var DebugManager=pc.createScript("debugManager");DebugManager.prototype.initialize=function(){if(!this.app.keyboard)return!1;this.app.keyboard.on("keydown",this.onKeyDown,this)},DebugManager.prototype.onKeyDown=function(e){e.key==pc.KEY_X&&this.exportStats()},DebugManager.prototype.getAllItemsFromLocalStorage=function(){var e={};for(let o=0;o<localStorage.length;o++){var t=localStorage.key(o);e[t]=localStorage.getItem(t)}return e},DebugManager.prototype.exportStats=function(){var e=this.getAllItemsFromLocalStorage(),t=JSON.stringify(e);console.log(t)};// MobileErrorManager.js
/*
var errorDiv = document.createElement('div');
errorDiv.style.position = 'fixed';
errorDiv.style.zIndex = '1000';

document.body.appendChild(errorDiv);

window.onerror = function (message, url, lineNo, columnNo, error) {
    var errorMessage = document.createElement('div');
    errorMessage.style.color = 'white';
    errorMessage.style.backgroundColor = 'red';
    errorMessage.style.borderBottom = 'solid 2px #fff';
    errorMessage.textContent = `Error: ${message} at ${url}:${lineNo}:${columnNo}`;
    
    errorDiv.appendChild(errorMessage);

    return true;
};
*/

var WindSpell=pc.createScript("windSpell");WindSpell.attributes.add("playerEntity",{type:"entity"}),WindSpell.attributes.add("speed",{type:"number",default:1}),WindSpell.attributes.add("damage",{type:"number",default:5}),WindSpell.prototype.initialize=function(){this.createdAt=Date.now(),this.lastDamage=Date.now(),this.on("state",this.onStateChange,this)},WindSpell.prototype.onStateChange=function(t){this.createdAt=Date.now()},WindSpell.prototype.update=function(t){var e=this.playerEntity.getPosition().clone().sub(this.entity.getPosition()).length();if(e<5){var i=this.playerEntity.getPosition().clone().sub(this.entity.getPosition()).normalize().scale(e/this.speed*t);this.playerEntity.translate(i.x,0,i.z),Date.now()-this.lastDamage>500&&(this.lastDamage=Date.now(),this.playerEntity.fire("Hit",this.damage))}Date.now()-this.createdAt>1e3&&(this.entity.enabled=!1)};var DragonShooter=pc.createScript("dragonShooter");DragonShooter.attributes.add("petManagerEntity",{type:"entity"}),DragonShooter.attributes.add("dragonEntity",{type:"entity"}),DragonShooter.attributes.add("modelEntity",{type:"entity"}),DragonShooter.attributes.add("minPlayerDistance",{type:"number",default:1.5}),DragonShooter.attributes.add("attackRadius",{type:"number",default:5}),DragonShooter.attributes.add("speed",{type:"number",default:3}),DragonShooter.attributes.add("smoothSpeed",{type:"number",default:.15}),DragonShooter.attributes.add("turnSpeed",{type:"number",default:3}),DragonShooter.attributes.add("attackTurnSpeed",{type:"number",default:7}),DragonShooter.attributes.add("bulletName",{type:"string",default:"DragonSpell"}),DragonShooter.attributes.add("shootFrom",{type:"entity"}),DragonShooter.prototype.initialize=function(){this.defaultSpeed=Number(this.speed+"");var t=this.petManagerEntity.script.petManager;this.shootingManagerEntity=t.shootingManagerEntity,this.playerEntity=t.playerEntity,this.isAttacking=!1,this.closeToPlayer=!1,this.direction=0,this.smooth=1,this.modelEntity.anim.on("Attack",this.onAttack,this)},DragonShooter.prototype.updateAnimationStates=function(){this.modelEntity.anim.setBoolean("Attacking",this.isAttacking)},DragonShooter.prototype.onAttack=function(){var t=this.shootFrom.getPosition(),i=this.targetEntity.getPosition();this.app.fire("ShootManager:Shoot","Player",this.bulletName,t,i),setTimeout((function(t){t.isAttacking=!1}),800,this)},DragonShooter.prototype.playerDistance=function(){var t=this.playerEntity.getPosition(),i=this.dragonEntity.getPosition();return Utils.distance(t.x,t.z,i.x,i.z)},DragonShooter.prototype.getClosestTarget=function(){for(var t=this.shootingManagerEntity.script.shootingManager.enemies,i=null,e=1/0,o=this.dragonEntity.getPosition(),a=t.length;a--;){var n=t[a];if(n!=this.playerEntity){var s=n.getPosition().sub(o).length();s>this.attackRadius||s<e&&n.parent&&n.enabled&&!n.script.enemy.isDeath&&(e=s+(100-n.script.enemy.health)/100,i=n)}}i?(this.targetEntity=i,this.isAttacking=!0):this.targetEntity=!1},DragonShooter.prototype.updateEnemyAim=function(t){var i=this.dragonEntity.getPosition(),e=this.targetEntity.getPosition(),o=Utils.lookAt(i.x,i.z,e.x,e.z);this.direction=Utils.rotate(this.direction,o,this.attackTurnSpeed*t),this.dragonEntity.setLocalEulerAngles(0,this.direction*pc.math.RAD_TO_DEG,0)},DragonShooter.prototype.updatePosition=function(t,i){var e=this.dragonEntity.getPosition(),o=this.playerEntity.getPosition(),a=Utils.lookAt(e.x,e.z,o.x,o.z);this.direction=Utils.rotate(this.direction,a,this.turnSpeed*t),this.isAttacking||this.dragonEntity.setLocalEulerAngles(0,this.direction*pc.math.RAD_TO_DEG,0);var n=this.direction-Math.PI/2,s=Math.cos(n)*t*this.speed,r=-Math.sin(n)*t*this.speed,h=i-this.minPlayerDistance;h>1?h=1:h<this.smoothSpeed&&(h=this.smoothSpeed),this.smooth=h,this.dragonEntity.translate(s*h,0,r*h)},DragonShooter.prototype.update=function(t){if(this.isAttacking)this.targetEntity&&this.updateEnemyAim(t);else{var i=this.playerDistance();this.speed=i>6?this.speed*(i/5)*t*60:this.defaultSpeed,NaN==i||i>100?this.dragonEntity.setPosition(this.playerEntity.getPosition()):i>=this.minPlayerDistance&&this.updatePosition(t,i),i<this.minPlayerDistance+1.5&&this.getClosestTarget()}this.updateAnimationStates()};var ColorTransfusion=pc.createScript("colorTransfusion");ColorTransfusion.attributes.add("colorCurve",{type:"curve",color:"rgb",default:{keys:[[0,.5,.5,1,1,0],[0,0,.5,.5,1,1],[0,1,.5,0,1,.5]]}}),ColorTransfusion.attributes.add("time",{type:"number",default:1}),ColorTransfusion.attributes.add("autoplay",{type:"boolean"}),ColorTransfusion.attributes.add("loop",{type:"boolean"}),ColorTransfusion.prototype.initialize=function(){this.timer=0,this.on("state",this.onStateChange,this)},ColorTransfusion.prototype.onStateChange=function(t){!0===t&&this.autoplay&&(this.timer=0)},ColorTransfusion.prototype.update=function(t){this.timer+=t/this.time;var o=this.colorCurve.value(this.timer);this.entity.element.color=new pc.Color(o[0],o[1],o[2],o[3]),this.loop&&this.timer>=1&&(this.timer=0)};var PetManager=pc.createScript("petManager");PetManager.attributes.add("playerEntity",{type:"entity"}),PetManager.attributes.add("shootingManagerEntity",{type:"entity"}),PetManager.attributes.add("pets",{type:"entity",array:!0}),PetManager.attributes.add("eggItem",{type:"entity"}),PetManager.attributes.add("eggElement",{type:"entity"}),PetManager.attributes.add("eggPopup",{type:"entity"}),PetManager.attributes.add("eggButton",{type:"entity"}),PetManager.attributes.add("eggRewardText",{type:"entity"}),PetManager.attributes.add("eggImage",{type:"entity"}),PetManager.attributes.add("dragonImage",{type:"entity"}),PetManager.attributes.add("equipButton",{type:"entity"}),PetManager.attributes.add("totalAds",{type:"number",default:2}),PetManager.attributes.add("hatchButton",{type:"entity"}),PetManager.attributes.add("hatchText",{type:"entity"}),PetManager.prototype.initialize=function(){this.usingPet=-1,this.watchedAds=0,this.gameplayStarted=Date.now(),this.eggCollectTime=Date.now(),this.alreadyClaimedEgg=Utils.getItemAsBoolean("AlreadyClaimedEgg"),this.loadPet(),this.app.on("PetManager:NextPet",this.onNextPet,this),this.app.on("PetManager:HidePet",this.hidePet,this),this.app.on("PetManager:SpawnPet",this.spawnPet,this),this.app.on("PetManager:SpawnEgg",this.spawnEgg,this),this.app.on("PetManager:CollectEgg",this.collectEgg,this),this.app.on("PetManager:HatchComplete",this.onHatchComplete,this),this.app.on("PetManager:ShowEgg",this.showEggPopup,this),this.app.on("PetManager:HideEgg",this.hideEggPopup,this),this.app.on("PetManager:WatchEggAds",this.watchEggAds,this)},PetManager.prototype.onHatchComplete=function(){this.hatchButton.element.color=pc.Color.WHITE,this.hatchText.element.text="CLICK!"},PetManager.prototype.showEggPopup=function(){if(Date.now()-this.eggCollectTime<12e4)return this.app.fire("Overlay:Announce","Please wait!"),!1;this.eggPopup.enabled=!0,this.eggElement.enabled=!1,this.equipButton.enabled=!1,this.eggButton.enabled=!0,this.eggRewardText.element.text=this.watchedAds+" / "+this.totalAds},PetManager.prototype.watchEggAds=function(){var t=this;PokiPlugin.showReward((function(){t.afterAdsWatch()}))},PetManager.prototype.afterAdsWatch=function(){this.watchedAds++,this.eggRewardText.element.text=this.watchedAds+" / "+this.totalAds,this.watchedAds>=this.totalAds&&(this.eggButton.enabled=!1,this.eggImage.enabled=!1,this.dragonImage.enabled=!0,this.equipButton.enabled=!0,this.app.fire("PetManager:NextPet"))},PetManager.prototype.hideEggPopup=function(){this.eggPopup.enabled=!1,this.eggElement.enabled=!1},PetManager.prototype.spawnEgg=function(t){var e=this.eggItem.clone();e.setPosition(t),e.enabled=!0,this.app.root.addChild(e),this.app.fire("Overlay:Announce","Got an egg!")},PetManager.prototype.collectEgg=function(t){this.eggElement.enabled=!0,this.eggCollectTime=Date.now(),this.entity.sound.play("EggCollect"),this.app.fire("World2Screen:Animate","Egg",t,this.eggElement),pc.BalanceSession.dragonEggCallback&&(pc.BalanceSession.dragonEggCallback(),pc.BalanceSession.dragonEggCallback=!1)},PetManager.prototype.savePet=function(t){Utils.setItem("Pet",t)},PetManager.prototype.loadPet=function(){var t=Utils.getItem("Pet");this.usingPet=t||-1,this.spawnPet()},PetManager.prototype.onNextPet=function(){this.hidePet(),this.usingPet>=0?this.usingPet<this.pets.length-1&&this.usingPet++:this.usingPet=0,this.savePet(this.usingPet),this.spawnPet()},PetManager.prototype.hidePet=function(){if(this.usingPet<0)return!1;var t=this.pets[this.usingPet];if(!t)return!1;t.enabled=!1},PetManager.prototype.spawnPet=function(){if(this.usingPet<0)return!1;var t=this.pets[this.usingPet];if(!t)return!1;t.enabled=!0},PetManager.prototype.update=function(t){this.usingPet<0&&!this.alreadyClaimedEgg&&Date.now()-this.gameplayStarted>25e3&&(pc.BalanceSession.hasDragonEgg=!0,this.alreadyClaimedEgg=!0,Utils.setItem("AlreadyClaimedEgg","Inferno"))};var SoulMage=pc.createScript("soulMage");SoulMage.attributes.add("projectileEntity",{type:"entity"}),SoulMage.attributes.add("characterEntity",{type:"entity"}),SoulMage.attributes.add("playerEntity",{type:"entity"}),SoulMage.prototype.initialize=function(){this.isActive=!1,this.createdAt=Date.now(),this.spinTime=2e3+1e3*Math.random(),this.lastSpin=Date.now(),this.entity.on("Target:Have",this.haveTarget,this),this.characterEntity.anim.on("Shoot",this.onShoot,this)},SoulMage.prototype.haveTarget=function(){this.isActive=!0},SoulMage.prototype.lookAtPlayer=function(){var t=this.entity.getPosition(),i=this.playerEntity.getPosition(),e=Utils.lookAt(t.x,t.z,i.x,i.z);this.originEntity.setLocalEulerAngles(0,e*pc.math.RAD_TO_DEG,0)},SoulMage.prototype.projectileAttack=function(){this.characterEntity.anim.setTrigger("Spin"),this.entity.fire("Locked",!0),setTimeout((function(t){t.entity.fire("Locked",!1)}),1e3,this)},SoulMage.prototype.onShoot=function(){this.projectileEntity.enabled=!0;var t=this.entity.getPosition(),i=this.playerEntity.getPosition(),e=Utils.lookAt(t.x,t.z,i.x,i.z);this.projectileEntity.setLocalPosition(t),this.projectileEntity.setLocalEulerAngles(0,e*pc.math.RAD_TO_DEG,0)},SoulMage.prototype.update=function(t){return!!this.isActive&&(!!Utils.isGameActive&&(!(Date.now()-this.createdAt<this.spinTime)&&void(Date.now()-this.lastSpin>this.spinTime&&(this.projectileAttack(),this.lastSpin=Date.now()))))};var RuneItem=pc.createScript("runeItem");RuneItem.prototype.initialize=function(){this.isDestroyed=!1,this.entity.on("Trigger",this.onTrigger,this),this.app.fire("Scene:Triggers")},RuneItem.prototype.onTrigger=function(e){if(this.isDestroyed)return!1;this.app.fire("RuneManager:Collect",this.entity.getPosition().clone()),this.entity.destroy(),this.isDestroyed=!0};var World2ScreenAnimate=pc.createScript("world2ScreenAnimate");World2ScreenAnimate.attributes.add("elements",{type:"entity",array:!0}),World2ScreenAnimate.attributes.add("speed",{type:"number",default:1}),World2ScreenAnimate.attributes.add("randomModifier",{type:"number",default:0}),World2ScreenAnimate.attributes.add("scaleCurve",{type:"curve",curves:["x"]}),World2ScreenAnimate.attributes.add("cameraEntity",{type:"entity"}),World2ScreenAnimate.attributes.add("holderEntity",{type:"entity"}),World2ScreenAnimate.prototype.initialize=function(){this.movingElements=[],this.elements.forEach((function(e){e.enabled=!1})),this.app.on("World2Screen:Animate",this.onCollect,this)},World2ScreenAnimate.prototype.onCollect=function(e,t,n){var i=this.getElementByName(e);if(i){var r=this.getScreenPosition(t),a=n.getPosition().clone(),o=i.clone(),s=(Math.random()-Math.random())*this.randomModifier;o.setLocalPosition(r.x+s,r.y+s,0),o.enabled=!0,this.movingElements.push({timestamp:0,element:o,screenPosition:r,destinationPosition:a}),this.holderEntity.addChild(o)}},World2ScreenAnimate.prototype.getScreenPosition=function(e){if(!this.cameraEntity)return console.warn("Camera doesnt exist!"),!1;var t=new pc.Vec3,n=this.cameraEntity.camera,i=this.app.graphicsDevice.maxPixelRatio,r=this.entity.screen.scale,a=this.app.graphicsDevice;return n?(n.worldToScreen(e,t),t.x*=i,t.y*=i,new pc.Vec2(t.x/r,(a.height-t.y)/r)):(console.warn("Camera doesnt exist!"),!1)},World2ScreenAnimate.prototype.getElementByName=function(e){for(var t=0;t<this.elements.length;t++)if(this.elements[t].name===e)return this.elements[t];return null},World2ScreenAnimate.prototype.update=function(e){for(var t=this.movingElements.length;t--;){var n=this.movingElements[t];if(n&&(n.timestamp+=e*this.speed,n.timestamp>0)){var i=n.timestamp,r=this.scaleCurve.value(i),a=n.element.getPosition();i>.25&&a.lerp(a,n.destinationPosition,.1),n.element.setPosition(a),n.element.setLocalScale(r,r,r),i>=1&&(this.movingElements.splice(t,1),n.element.destroy())}}};var ShieldSphere=pc.createScript("shieldSphere");ShieldSphere.attributes.add("playerEntity",{type:"entity"}),ShieldSphere.attributes.add("sphereOriginEntity",{type:"entity"}),ShieldSphere.attributes.add("sphereEntity",{type:"entity"}),ShieldSphere.attributes.add("infinite",{type:"boolean",default:!1}),ShieldSphere.attributes.add("time",{type:"number",default:5}),ShieldSphere.attributes.add("timeStartEffect",{type:"number",default:2.25}),ShieldSphere.attributes.add("durationEffect",{type:"number",default:.75}),ShieldSphere.attributes.add("maxEffectValue",{type:"number",description:"0.1 - 1",default:.75}),ShieldSphere.prototype.initialize=function(){this.timeEffect=!1,this.onStateChange(!0),this.getMeshInstances(),this.on("state",this.onStateChange,this),this.on("destroy",this.onDestroy,this)},ShieldSphere.prototype.onStateChange=function(t){!0===t&&(this.timeEffect=!1,this.sphereOriginEntity.enabled=!0,this.playerEntity.script.player.isImmunity=!0,this.infinite||(setTimeout((function(t){t.timeEffect=0}),1e3*this.timeStartEffect,this),setTimeout((function(t){t.playerEntity.script.player.isImmunity=!1,t.sphereOriginEntity.enabled=!1,t.entity.enabled=!1}),1e3*this.time,this)))},ShieldSphere.prototype.getMeshInstances=function(){var t=this.sphereEntity.findComponents("render");this.meshInstances=[];for(var e=0;e<t.length;++e)for(var i=t[e].meshInstances,h=0;h<i.length;h++)this.meshInstances.push(i[h])},ShieldSphere.prototype.updateSphereEffect=function(t){if("boolean"==typeof this.timeEffect)return!1;this.timeEffect+=t,this.timeEffect>this.durationEffect&&(this.timeEffect-=this.durationEffect);for(var e=this.timeEffect/this.durationEffect,i=Math.abs((e-.5)*this.maxEffectValue),h=this.meshInstances,n=0;n<h.length;++n)h[n].setParameter("material_opacity",i)},ShieldSphere.prototype.update=function(t){var e=this.playerEntity.getPosition();this.sphereOriginEntity.setPosition(e),this.updateSphereEffect(t)};var OverlayChapters=pc.createScript("overlayChapters");OverlayChapters.attributes.add("maps",{type:"json",schema:[{name:"entity",type:"entity"},{name:"lineEntity",type:"entity"},{name:"color",type:"rgb"},{name:"pins",type:"number",array:!0},{name:"lines",type:"number",array:!0}],array:!0}),OverlayChapters.attributes.add("mapManager",{type:"entity"}),OverlayChapters.attributes.add("mapName",{type:"entity"}),OverlayChapters.attributes.add("activeColor",{type:"rgb"}),OverlayChapters.attributes.add("deactiveColor",{type:"rgb"}),OverlayChapters.prototype.initialize=function(){this.currentMap=!1,this.mapOffset=0,this.nextMapOffset=0,this.lineOffset=0,this.nextLineOffset=0,this.fullHeight=1960},OverlayChapters.prototype.showChapterProgress=function(){var t=pc.BalanceSession.mapName,e=this.mapManager.script.mapManager.currentLevel-1;this.currentMap=this.maps[0],this.mapName.element.text=t;for(var a=0;a<this.maps.length;a++)this.maps[a].entity.name===t?(this.currentMap=this.maps[a],this.maps[a].entity.enabled=!0):this.maps[a].entity.enabled=!1;var i=this.currentMap.entity.findByTag("Pin");for(a=0;a<i.length;a++)i[a].element.color=this.deactiveColor,i[a].setLocalScale(.571,.571,.571),e>a&&(i[a].element.color=this.activeColor,i[a].setLocalScale(.818,.818,.818));setTimeout((function(t,e){t.element.color=e.activeColor,t.setLocalScale(.818,.818,.818)}),1e3,i[e],this),this.nextLineOffset=this.currentMap.lines[e],this.nextMapOffset=this.currentMap.pins[e],this.entity.element.color=this.currentMap.color,this.entity.sound.play("NextChapter")},OverlayChapters.prototype.update=function(t){this.currentMap&&(this.mapOffset=pc.math.lerp(this.mapOffset,this.nextMapOffset,.05),this.lineOffset=pc.math.lerp(this.lineOffset,this.nextLineOffset,.05),this.currentMap.entity.setLocalPosition(0,this.mapOffset,0),this.currentMap.lineEntity.element.height=this.lineOffset*this.fullHeight,this.currentMap.lineEntity.element.rect.w=this.lineOffset)};var Variations=pc.createScript("variations");Variations.attributes.add("entities",{type:"entity",array:!0,title:"Entity Variations"}),Variations.prototype.initialize=function(){this.selectRandomVariation()},Variations.prototype.selectRandomVariation=function(){if(this.entities.forEach((function(t){t.enabled=!1})),this.entities.length>0){var t=Math.floor(Math.random()*this.entities.length);this.entities[t].enabled=!0}};var VersionManager=pc.createScript("versionManager");VersionManager.attributes.add("version",{type:"string"}),VersionManager.attributes.add("versionEntity",{type:"entity"}),VersionManager.attributes.add("versionPopup",{type:"entity"}),VersionManager.prototype.initialize=function(){this.checkVersion(),this.app.on("VersionManager:Show",this.onShow,this),this.app.on("VersionManager:Close",this.onClose,this)},VersionManager.prototype.checkVersion=function(){var e=Utils.getItem("Version");e?e!=this.version&&(this.onShow(),this.setNewVersion()):this.setNewVersion()},VersionManager.prototype.onShow=function(){this.versionPopup.enabled=!0;var e=this.versionEntity.script.versionEntity,n=e.updates,t=e.fixes;if(n.length>0){this.versionPopup.findByName("UpdatesTitle").enabled=!0;var i=this.versionPopup.findByName("Updates");i.enabled=!0,i.element.text=this.renderNotes(n)}if(t.length>0){this.versionPopup.findByName("FixesTitle").enabled=!0;var r=this.versionPopup.findByName("Fixes");r.enabled=!0,r.element.text=this.renderNotes(t)}},VersionManager.prototype.renderNotes=function(e){if(!e)return!1;var n="";for(var t in e){n+="- "+e[t]+"\n"}return n},VersionManager.prototype.onClose=function(){this.versionPopup.enabled=!1},VersionManager.prototype.setNewVersion=function(){Utils.setItem("Version",this.version)};var VersionEntity=pc.createScript("versionEntity");VersionEntity.attributes.add("updates",{type:"string",array:!0}),VersionEntity.attributes.add("fixes",{type:"string",array:!0});var EggItem=pc.createScript("eggItem");EggItem.prototype.initialize=function(){this.isDestroyed=!1,this.entity.on("Trigger",this.onTrigger,this),this.app.fire("Scene:Triggers")},EggItem.prototype.onTrigger=function(t){if(this.isDestroyed)return!1;this.app.fire("PetManager:CollectEgg",this.entity.getPosition().clone()),this.entity.destroy(),this.isDestroyed=!0};var RewardManager=pc.createScript("rewardManager");RewardManager.attributes.add("showHourlyInFirstSessionAfter",{type:"number",description:"mins"}),RewardManager.attributes.add("hourlyRewardValue",{type:"number",description:"how much coins",default:5}),RewardManager.attributes.add("hourlyRewardAds",{type:"number",description:"how much ads need to watch",default:2}),RewardManager.attributes.add("hourlyRewardPopup",{type:"entity"}),RewardManager.attributes.add("hourlyRewardButton",{type:"entity"}),RewardManager.attributes.add("hourlyRewardTimers",{type:"entity",array:!0}),RewardManager.attributes.add("rewardsMenuEntity",{type:"entity"}),RewardManager.prototype.initialize=function(){this.sessionStart=Date.now(),this.hourlyRewardEnd=!1,this.lastTimeEndSave=Date.now(),this.hourlyRewardPopup.enabled=!1,this.hourlyRewardWatched=!1;var e=Utils.getItem("LastHourlyReward");e&&Date.now()-e<432e5&&(this.hourlyRewardWatched=!0),this.hourlyRewardAdsWatched=0;var t=Utils.getItem("HourlyRewardTimeEnd");t&&Date.now()<t&&(this.hourlyRewardEnd=t,this.enabledHourlyReward(!0)),this.app.on("RewardManager:Show",this.onShow,this),this.app.on("RewardManager:Close",this.onClose,this),this.app.on("RewardManager:Hourly",this.hourlyRewardWatch,this)},RewardManager.prototype.onShow=function(e){"Hourly"==e&&(this.hourlyRewardPopup.enabled=!0,this.hourlyRewardButton.findByName("Notification").enabled=!1,PokiPlugin.onPause(),Utils.isGameActive=!1)},RewardManager.prototype.onClose=function(e){this.hourlyRewardPopup.enabled=!1,PokiPlugin.onPlay(),Utils.isGameActive=!0},RewardManager.prototype.onHourlyRewardWatched=function(e){this.hourlyRewardAdsWatched++,this.hourlyRewardAdsWatched>=this.hourlyRewardAds?(this.hourlyRewardWatched=!0,this.app.fire("Money:Add",e),this.enabledHourlyReward(!1),this.onClose(),Utils.setItem("LastHourlyReward",Date.now()),Utils.setItem("HourlyRewardTimeEnd",0)):this.hourlyRewardPopup.findByName("AdsNumber").element.text="Watch ads "+this.hourlyRewardAdsWatched+"/"+this.hourlyRewardAds},RewardManager.prototype.hourlyRewardWatch=function(e){var t=this;PokiPlugin.showReward((function(){t.onHourlyRewardWatched(e)}))},RewardManager.prototype.updateHourlyReward=function(){Date.now()-this.sessionStart>1e3*this.showHourlyInFirstSessionAfter*60&&!this.hourlyRewardButton.enabled&&!this.hourlyRewardWatched&&(this.enabledHourlyReward(!0),this.hourlyRewardEnd||(this.hourlyRewardEnd=Date.now()+3599e3)),this.hourlyRewardEnd&&(Date.now()>this.hourlyRewardEnd&&this.hourlyRewardButton.enabled?(Utils.setItem("LastHourlyReward",Date.now()),Utils.setItem("HourlyRewardTimeEnd",0),this.hourlyRewardWatched=!0,this.enabledHourlyReward(!1),this.onClose()):this.updateTimers(),Date.now()-this.lastTimeEndSave>3e4&&(this.lastTimeEndSave=Date.now(),Utils.setItem("HourlyRewardTimeEnd",this.hourlyRewardEnd)))},RewardManager.prototype.updateTimers=function(){var e=Math.floor((this.hourlyRewardEnd-Date.now())/1e3),t=Math.floor(e%3600/60);e%=60;var a=t.toString().padStart(2,"0")+":"+e.toString().padStart(2,"0");for(var r in this.hourlyRewardTimers)this.hourlyRewardTimers[r].element.text=a},RewardManager.prototype.enabledHourlyReward=function(e){e?(this.hourlyRewardPopup.findByName("AdsNumber").element.text="Watch ads "+this.hourlyRewardAdsWatched+"/"+this.hourlyRewardAds,this.hourlyRewardPopup.findByName("ButtonWatch").script.button.value=this.hourlyRewardValue):this.hourlyRewardPopup.enabled=!1,this.rewardsMenuEntity.enabled=e,this.hourlyRewardButton.enabled=e},RewardManager.prototype.update=function(e){this.updateHourlyReward()};